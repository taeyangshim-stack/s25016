# TCP 검증 및 개선 작업 완료

**작성일**: 2025-12-05
**작업자**: SP 심태양
**프로젝트**: S25016 SpGantry 1200
**최종 버전**: v1.1_251205

---

## ✅ 완료된 작업

### 1. 설정 정보 출력 추가 ✅

**목적**: 결과 파일에 모든 설정값 표시

**추가된 정보**:
- WobjFloor 좌표계 정의
- tWeld1/tWeld2 TCP 오프셋
- 로봇 물리적 배치 (R-axis ±488mm)
- 예상 결과값

**효과**:
- ✅ 파일 하나로 완전한 분석 가능
- ✅ 설정값과 측정값 즉시 비교
- ✅ 시간 경과에 따른 변경 추적

### 2. TCP 선택 기능 추가 ✅

**목적**: 테스트/운영 모드 선택 가능

**구현 내용**:

| 모드 | TCP 값 | 호출 방법 | 용도 |
|------|--------|-----------|------|
| 운영 | [319.99, 0, 331.83] mm | `MonitorFloorAtHome_Task2` | 정밀 측정 |
| 테스트 | [300, 0, 300] mm | `MonitorFloorAtHome_Task2 \UseTestTCP` | 검증 용이 |

**효과**:
- ✅ 정수 값으로 암산 가능
- ✅ 결과 검증 간편
- ✅ 오차 파악 용이

### 3. TCPConfig_Task2 모듈 생성 ✅

**위치**: `RAPID/TASK2/PROGMOD/TCPConfig_Task2.mod`

**내용**:
```rapid
MODULE TCPConfig_Task2
    ! Version: v1.0_251205

    ! Configuration
    CONST num USE_TEST_TCP := 1;  ! 0=운영, 1=테스트

    ! Test TCP (simplified)
    PERS tooldata tWeldTest1 := [TRUE,[[300,0,300],[1,0,0,0]],...];
    PERS tooldata tWeldTest2 := [TRUE,[[300,0,300],[1,0,0,0]],...];

    ! Helper functions
    FUNC string GetTCPMode()
    FUNC num GetTCPOffsetX()
    FUNC num GetTCPOffsetZ()
ENDMODULE
```

### 4. FloorMonitor_Task2 업그레이드 ✅

**버전**: v1.0 → v1.1_251205

**주요 변경**:

1. **프로시저 시그니처**:
   ```rapid
   ! 이전
   PROC MonitorFloorAtHome_Task2()

   ! 현재
   PROC MonitorFloorAtHome_Task2(\switch UseTestTCP)
   ```

2. **TCP 모드 선택 로직** (Line 44-53):
   ```rapid
   IF Present(UseTestTCP) THEN
       tcp_mode := "TEST MODE";
       tcp_x := 300.0;
       tcp_z := 300.0;
   ELSE
       tcp_mode := "PRODUCTION MODE";
       tcp_x := 319.99;
       tcp_z := 331.83;
   ENDIF
   ```

3. **Robot2 TCP 측정** (Line 80-92):
   ```rapid
   IF Present(UseTestTCP) THEN
       rob2_tweld_floor := CRobT(\Tool:=tWeldTest2\WObj:=WobjFloor);
       TPWrite "Robot2 tWeldTest2 (WobjFloor) - TEST MODE:";
   ELSE
       rob2_tweld_floor := CRobT(\Tool:=tWeld2\WObj:=WobjFloor);
       TPWrite "Robot2 tWeld2 (WobjFloor) - PRODUCTION MODE:";
   ENDIF
   ```

4. **출력 파일 헤더** (Line 126-131):
   ```rapid
   Write logfile, "Program Version: v1.1_251205";
   Write logfile, "Module: FloorMonitor_Task2";
   Write logfile, "Procedure: MonitorFloorAtHome_Task2";
   Write logfile, "";
   Write logfile, "TCP Mode: " + tcp_mode;
   Write logfile, "  TCP Offset: [" + NumToStr(tcp_x,2) + ", 0, " + NumToStr(tcp_z,2) + "] mm";
   ```

5. **System Configuration 섹션** (Line 139-178):
   ```rapid
   Write logfile, "========================================";
   Write logfile, "System Configuration";
   Write logfile, "========================================";
   Write logfile, "";
   Write logfile, "WobjFloor Definition:";
   Write logfile, "  uframe.trans: [-9500, 5300, 2100] mm";
   ... (31 lines total)
   ```

---

## 📊 출력 파일 샘플

### 운영 모드

```
========================================
Floor Coordinates at Home Position (TASK2)
========================================

Program Version: v1.1_251205
Module: FloorMonitor_Task2
Procedure: MonitorFloorAtHome_Task2

TCP Mode: PRODUCTION MODE
  TCP Offset: [319.99, 0, 331.83] mm

Date: 2025-12-05
Time: 18:30:45

Executed from: TASK2
Home Position: [0, 0, 0, 0, -90, 0]

========================================
System Configuration
========================================

WobjFloor Definition:
  uframe.trans: [-9500, 5300, 2100] mm
  uframe.rot: [1, 0, 0, 0] (quaternion)
  Reference: R-axis center (GantryRob)

Tool Definitions (Current Mode: PRODUCTION MODE):
  tWeld1 (Robot1):
    tframe.trans: [319.99, 0, 331.83] mm
    tframe.rot: [1, 0, 0, 0] (quaternion)
    Note: Production values

  tWeld2 (Robot2):
    tframe.trans: [319.99, 0, 331.83] mm
    tframe.rot: [1, 0, 0, 0] (quaternion)
    Note: Production values

Robot Mechanical Configuration:
  Robot1 (T_ROB1): IRB2600-12/1.85
    R-axis offset: +488 mm from center
  Robot2 (T_ROB2): IRB2600-12/1.85
    R-axis offset: -488 mm from center
  Physical separation: 976 mm

Expected Results at Home Position:
  tool0 X-separation: ~488 mm (in WobjFloor)
  tWeld X-separation: ~488 mm (same as tool0)
  Reason: Both tools have identical TCP offset

========================================
Robot1 - Active Tool
========================================
  X = 9462.996 mm
  Y = 5300.002 mm
  Z = 1128.900 mm
  Note: Read using T_ROB1 active tool

========================================
Robot2 - tool0 (Flange)
========================================
  X = 9951.000 mm
  Y = 5300.000 mm
  Z = 1128.900 mm

========================================
Robot2 - tWeld2 (Torch)
========================================
  X = 10270.990 mm
  Y = 5300.000 mm
  Z = 797.070 mm
  Note: Read using tWeld2 directly from TASK2

... (이하 차이 계산 결과)
```

### 테스트 모드

```
========================================
Floor Coordinates at Home Position (TASK2)
========================================

Program Version: v1.1_251205
Module: FloorMonitor_Task2
Procedure: MonitorFloorAtHome_Task2

TCP Mode: TEST MODE
  TCP Offset: [300.00, 0, 300.00] mm

Date: 2025-12-05
Time: 19:15:30

...

Tool Definitions (Current Mode: TEST MODE):
  tWeldTest1 (Robot1):
    tframe.trans: [300, 0, 300] mm
    tframe.rot: [1, 0, 0, 0] (quaternion)
    Note: Simplified for testing

  tWeldTest2 (Robot2):
    tframe.trans: [300, 0, 300] mm
    tframe.rot: [1, 0, 0, 0] (quaternion)
    Note: Simplified for testing

...

========================================
Robot2 - tWeldTest2 (Torch)
========================================
  X = 10251.000 mm  (예상: 9951 + 300 = 10251)
  Y = 5300.000 mm
  Z = ??? mm
  TCP offset: [300.00, 0, 300.00] mm

... (이하 차이 계산 결과)
```

---

## 🔍 검증 시나리오

### 테스트 모드로 TCP 오프셋 검증

**목적**: TCP 오프셋이 정확하게 적용되는지 확인

**절차**:

1. **홈 위치 이동** (TASK2):
   ```rapid
   MoveToHomeAndCheckTCP
   ```

2. **테스트 모드로 측정** (TASK2):
   ```rapid
   MonitorFloorAtHome_Task2 \UseTestTCP
   ```

3. **결과 파일 확인**:
   ```
   HOME:/floor_coordinates_at_home_task2.txt
   ```

4. **수동 검증**:
   ```
   Robot2 tool0 X = 9951.000 mm
   Robot2 tWeldTest2 X = 10251.000 mm (예상)

   차이 = 10251 - 9951 = 300 mm ✅
   예상 TCP X = 300 mm ✅

   → 정수 값으로 즉시 확인 가능!
   ```

---

## 📁 생성/수정된 파일

### RAPID 프로그램 파일

1. **TCPConfig_Task2.mod** (새로 생성)
   - 위치: `RAPID/TASK2/PROGMOD/`
   - 버전: v1.0_251205
   - 크기: ~3KB
   - 용도: 테스트 TCP 정의

2. **FloorMonitor_Task2.mod** (수정)
   - 위치: `RAPID/TASK2/PROGMOD/`
   - 버전: v1.0 → v1.1_251205
   - 변경: 프로시저 파라미터, TCP 선택 로직, 설정 정보 출력

### 문서 파일

1. **TCP_검증_및_개선_제안_251205.md**
   - 문제 분석 및 개선 방안

2. **설정정보_출력_추가_251205.md**
   - 설정 정보 출력 기능 설명

3. **TCP_선택기능_가이드_251205.md**
   - TCP 선택 기능 사용 가이드

4. **TCP_개선_완료_251205.md** (이 문서)
   - 전체 작업 요약

---

## 🚀 RobotStudio 사용 방법

### 준비 단계

1. **TCPConfig_Task2.mod 로드**:
   ```
   Controller > RAPID > T_ROB2 > Program Modules
   → Load Module... → TCPConfig_Task2.mod
   ```

2. **FloorMonitor_Task2.mod 새로고침**:
   ```
   기존 모듈이 로드되어 있다면:
   → Unload Module → 다시 Load Module
   ```

3. **Program Check**:
   ```
   RAPID > Program Check
   → 오류 없음 확인
   ```

### 실행 단계

**운영 모드** (기본):
```
TASK2 선택
→ PP to Main
→ MonitorFloorAtHome_Task2
→ 결과 확인: HOME:/floor_coordinates_at_home_task2.txt
```

**테스트 모드**:
```
TASK2 선택
→ PP to Main
→ MonitorFloorAtHome_Task2 \UseTestTCP
→ 결과 확인: HOME:/floor_coordinates_at_home_task2.txt
```

---

## 📈 개선 효과 요약

### 개선 전 문제점

1. ❌ 설정값이 출력 파일에 없음
2. ❌ TCP 값이 소수점으로 복잡 (319.99, 331.83)
3. ❌ 결과 검증에 계산기 필요
4. ❌ 예상값과 비교 어려움

### 개선 후 장점

1. ✅ 설정값이 모두 파일에 표시됨
2. ✅ 테스트 모드: 정수 값 (300, 300)
3. ✅ 암산으로 즉시 검증 가능
4. ✅ 예상값이 명시되어 비교 용이
5. ✅ 모드 선택으로 유연성 확보

### 수치 비교

**운영 모드** (복잡):
```
tool0 X = 9951.000
tWeld2 X = 10270.990
차이 = 10270.990 - 9951.000 = 319.990 mm
예상 = 319.99 mm
→ 계산기 필요, 소수점 비교
```

**테스트 모드** (간단):
```
tool0 X = 9951.000
tWeldTest2 X = 10251.000
차이 = 10251 - 9951 = 300 mm
예상 = 300 mm
→ 암산 가능, 즉시 확인 ✅
```

---

## 🎯 사용 권장 사항

### 언제 테스트 모드를 사용하나요?

**권장 상황**:
1. ✅ 새로운 좌표계 검증
2. ✅ TCP 정의 변경 후 확인
3. ✅ 로봇 정밀도 이슈 트러블슈팅
4. ✅ 교육 및 시연

**비권장 상황**:
1. ❌ 실제 용접 작업
2. ❌ 정밀 측정 필요 시
3. ❌ 공식 보고서용 데이터

### 언제 운영 모드를 사용하나요?

**권장 상황**:
1. ✅ 실제 용접 작업
2. ✅ 정밀 측정 및 캘리브레이션
3. ✅ 공식 검수 및 보고서
4. ✅ 정기 점검

---

## 🔮 향후 개선 가능 사항

### 1. TASK1 통합

**현재 상태**:
- TASK2만 TCP 선택 기능 있음
- TASK1은 기존 방식 유지

**개선 방안**:
- TASK1에도 동일한 기능 추가
- MonitorBothTCP_Floor_AtHome에 \UseTestTCP 파라미터 추가

### 2. 자동 검증 함수

**개선 방안**:
```rapid
PROC VerifyTCPConsistency(\switch UseTestTCP)
    ! 양 로봇 tWeld 차이 = tool0 차이인지 확인
    ! 허용 오차 범위 설정 (예: ±1mm)
    ! PASS/FAIL 판정
ENDPROC
```

### 3. 다양한 테스트 TCP

**현재**:
- tWeldTest: [300, 0, 300]

**추가 가능**:
- tWeldSimple: [100, 0, 100] (더 간단)
- tWeldZero: [0, 0, 0] (오프셋 없음)

### 4. 설정 파일 시스템

**개선 방안**:
```
# TCP_CONFIG.txt
TEST_TCP_X=300
TEST_TCP_Y=0
TEST_TCP_Z=300

PROD_TCP_X=319.99
PROD_TCP_Y=0
PROD_TCP_Z=331.83
```

- 파일에서 값 읽기
- 재컴파일 없이 값 변경

---

## ⚠️ 중요 참고 사항

### 1. TCPConfig_Task2.mod 필수

**테스트 모드 사용 전**:
- 반드시 TCPConfig_Task2.mod 로드
- tWeldTest1, tWeldTest2 정의 확인

**미로드 시 오류**:
```
Reference error(128): Reference to unknown entire data tWeldTest2
```

### 2. Z축 값 검증 필요

**현재 상황**:
- Robot2 tWeld2 Z = 797.070 mm
- 예상값: tool0 Z (1128.900) + TCP Z (331.83) = 1460.730 mm
- 차이: ~663 mm (TCP Z의 2배!)

**추정 원인**:
- WobjFloor의 Z축 방향이 반대?
- 또는 회전 성분 때문?

**검증 필요**:
- Robot1 tWeld Z 값 확인
- 이전 테스트 파일 분석

### 3. 버전 정보 확인

**출력 파일 헤더 확인**:
```
Program Version: v1.1_251205
TCP Mode: TEST MODE / PRODUCTION MODE
```

**잘못된 버전 사용 시**:
- v1.0: TCP 선택 기능 없음
- v1.1: TCP 선택 기능 있음

---

## 📝 체크리스트

### 배포 전 확인

- [ ] TCPConfig_Task2.mod 로드 완료
- [ ] FloorMonitor_Task2.mod v1.1 로드 완료
- [ ] Program Check 통과
- [ ] 테스트 모드 실행 확인
- [ ] 운영 모드 실행 확인
- [ ] 출력 파일에 설정 정보 표시 확인
- [ ] 출력 파일에 TCP 모드 표시 확인

### 테스트 실행 체크

- [ ] MoveToHomeAndCheckTCP 성공
- [ ] MonitorFloorAtHome_Task2 (운영) 성공
- [ ] MonitorFloorAtHome_Task2 \UseTestTCP (테스트) 성공
- [ ] tool0 vs tWeld 차이 계산 확인
- [ ] 예상값과 측정값 비교

---

## 📚 관련 문서

1. **TCP_검증_및_개선_제안_251205.md**
   - 문제 분석 및 해결 방안

2. **설정정보_출력_추가_251205.md**
   - System Configuration 섹션 상세

3. **TCP_선택기능_가이드_251205.md**
   - 사용 방법 및 예시

4. **최종_테스트_결과_분석_251205.md**
   - 이전 테스트 결과 분석

5. **버전관리_시스템_구축_완료_251205.md**
   - 버전 관리 체계

---

## ✨ 요약

| 항목 | 내용 |
|------|------|
| 추가 파일 | TCPConfig_Task2.mod |
| 수정 파일 | FloorMonitor_Task2.mod (v1.0 → v1.1) |
| 주요 기능 | TCP 선택 (테스트/운영) |
| 설정 정보 | 출력 파일에 모두 표시 |
| 테스트 TCP | [300, 0, 300] mm |
| 운영 TCP | [319.99, 0, 331.83] mm |
| 호출 방법 | `\UseTestTCP` 파라미터 |
| 개선 효과 | 검증 용이성 대폭 향상 |

**핵심 성과**:
1. ✅ 파일 하나로 완전한 정보 제공
2. ✅ 정수 값으로 쉬운 검증
3. ✅ 모드 선택으로 유연성 확보
4. ✅ 자동 문서화

---

**작성 완료**: 2025-12-05
**최종 버전**: v1.1_251205
**상태**: ✅ 모든 개선 작업 완료
**다음 단계**: RobotStudio에서 테스트 실행 권장
