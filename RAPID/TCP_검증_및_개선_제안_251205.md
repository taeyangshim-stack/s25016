# TCP 검증 및 개선 제안

**작성일**: 2025-12-05
**문제 제기자**: 사용자
**분석자**: SP 심태양

---

## 🔴 현재 문제점

### 1. 검증 부족

**현재 상황**:
```
tWeld1 TCP 오프셋: [319.99, 0, 331.83] mm
tWeld2 TCP 오프셋: [319.99, 0, 331.83] mm (동일!)
```

**예상 결과**:
홈 위치에서 양 로봇의 tWeld TCP 차이 = tool0 차이와 동일해야 함
```
Rob1(tool0) - Rob2(tool0) = 488.004 mm
Rob1(tWeld) - Rob2(tWeld) = 488.004 mm (예상)
```

**실제 측정값 검증 필요**:
```
Rob1 tool0: X = 9462.996 mm
Rob2 tool0: X = 9951.000 mm
차이: 488.004 mm ✅

Rob1 tWeld (예상): X = 9462.996 + 319.99 = 9782.986 mm
Rob2 tWeld2: X = 10270.990 mm
차이: 10270.990 - 9782.986 = 488.004 mm (검증 필요)
```

### 2. 수치 파악의 어려움

**현재 TCP 오프셋**:
- X: 319.99 mm (소수점)
- Y: 0 mm
- Z: 331.83 mm (소수점)

**문제**:
- 계산 시 소수점으로 복잡
- 수치 확인 어려움

---

## ✅ 개선 제안

### 제안 1: TCP 오프셋 간소화

**테스트용 TCP 정의**:
```rapid
! 기존 (복잡)
tWeld1: [319.99, 0, 331.83]
tWeld2: [319.99, 0, 331.83]

! 테스트용 (간단)
tWeldTest1: [300, 0, 300]
tWeldTest2: [300, 0, 300]

! 또는 더 간단하게
tWeldSimple: [100, 0, 100]
```

**장점**:
- ✅ 수치 계산 간편
- ✅ 결과 검증 용이
- ✅ 파악 빠름

### 제안 2: 출력 파일에 모든 설정값 표시

**추가할 정보**:
```
========================================
System Configuration
========================================

WobjFloor Definition:
  uframe.trans: [-9500, 5300, 2100] mm
  uframe.rot: [quaternion values]

Tool Definitions:
  tWeld1 (Robot1):
    tframe.trans: [319.99, 0, 331.83] mm
    tframe.rot: [quaternion values]

  tWeld2 (Robot2):
    tframe.trans: [319.99, 0, 331.83] mm
    tframe.rot: [quaternion values]

Robot Mechanical Configuration:
  Robot1 R-axis offset: +488 mm
  Robot2 R-axis offset: -488 mm
  Physical separation: 976 mm

Expected Results:
  tool0 separation: 488 mm
  tWeld separation: 488 mm (same as tool0)
  Reason: Both tools have identical offset
```

### 제안 3: 파라미터로 TCP 선택

**방법 A: 프로시저 파라미터**
```rapid
PROC MonitorFloorAtHome_Task2(num testMode)
    ! testMode = 0: 실제 TCP 사용
    ! testMode = 1: 테스트 TCP 사용 (간소화)

    IF testMode = 1 THEN
        ! Use tWeldTest1, tWeldTest2
    ELSE
        ! Use tWeld1, tWeld2
    ENDIF
ENDPROC
```

**방법 B: CONST 변수로 설정**
```rapid
MODULE FloorMonitor_Task2
    ! Configuration
    CONST num USE_TEST_TCP := 1;  ! 0=실제, 1=테스트

    ! Test TCP definitions
    PERS tooldata tWeldTest1 := [TRUE,[[300,0,300],[1,0,0,0]],[1,[0,0,1],[1,0,0,0],0,0,0]];
    PERS tooldata tWeldTest2 := [TRUE,[[300,0,300],[1,0,0,0]],[1,[0,0,1],[1,0,0,0],0,0,0]];
```

**방법 C: 텍스트 파일 설정** (가장 유연)
```
# TCP_CONFIG.txt
USE_TEST_TCP=1
TEST_TCP_X=300
TEST_TCP_Y=0
TEST_TCP_Z=300
```

---

## 📋 구현 계획

### 단계 1: 현재 결과 재검증

실제 측정값이 맞는지 계산:

```
Robot1 홈 위치:
  tool0: [9462.996, 5300.002, 1128.900]
  tWeld1: tool0 + [319.99, 0, 331.83]
        = [9782.986, 5300.002, 1460.730] (예상)

Robot2 홈 위치:
  tool0: [9951.000, 5300.000, 1128.900]
  tWeld2: tool0 + [319.99, 0, 331.83]
        = [10270.990, 5300.000, 1460.730] (예상)

비교:
  측정값: [10270.990, 5300.000, 797.070]
  예상값: [10270.990, 5300.000, 1460.730]

  X, Y: 일치 ✅
  Z: 불일치 (797 vs 1460) ❌
```

**문제 발견**: Z 값이 다릅니다!

**원인 추정**:
- WobjFloor의 회전 때문에 Z축 방향이 반대?
- 또는 TCP 정의의 회전 성분?

### 단계 2: 간소화된 TCP 생성

**파일**: `RAPID/TASK1/SYSPAR/` 및 `RAPID/TASK2/SYSPAR/`

**내용**:
```rapid
! Test TCP (simplified)
PERS tooldata tWeldTest := [TRUE,[[100,0,100],[1,0,0,0]],[1,[0,0,1],[1,0,0,0],0,0,0]];
```

### 단계 3: 설정 정보 출력 추가

**FloorMonitor_Task2.mod 수정**:
```rapid
PROC MonitorFloorAtHome_Task2()
    ...

    ! Save configuration info
    Write logfile, "========================================";
    Write logfile, "System Configuration";
    Write logfile, "========================================";
    Write logfile, "";
    Write logfile, "WobjFloor uframe.trans:";
    Write logfile, "  X = -9500 mm";
    Write logfile, "  Y = 5300 mm";
    Write logfile, "  Z = 2100 mm";
    Write logfile, "";
    Write logfile, "tWeld1 tframe.trans:";
    Write logfile, "  X = 319.99 mm";
    Write logfile, "  Y = 0 mm";
    Write logfile, "  Z = 331.83 mm";
    Write logfile, "";
    Write logfile, "tWeld2 tframe.trans:";
    Write logfile, "  X = 319.99 mm";
    Write logfile, "  Y = 0 mm";
    Write logfile, "  Z = 331.83 mm";
    Write logfile, "";
    Write logfile, "Robot Configuration:";
    Write logfile, "  Robot1 R-axis offset: +488 mm";
    Write logfile, "  Robot2 R-axis offset: -488 mm";
    Write logfile, "";
    ...
ENDPROC
```

---

## 🔍 Z축 값 검증 필요

### 현재 측정값 분석

```
Robot1 tool0 Z (WobjFloor): 1128.900 mm
Robot1 tWeld Z (예상): 1128.900 + 331.83 = 1460.730 mm
Robot1 tWeld Z (실제 - 이전 테스트): ??? mm

Robot2 tool0 Z (WobjFloor): 1128.900 mm
Robot2 tWeld2 Z (측정): 797.070 mm
Robot2 tWeld2 Z (예상): 1128.900 + 331.83 = 1460.730 mm

차이: 1460.730 - 797.070 = 663.66 mm (2배!)
```

**추정**:
- Z축 방향이 반대? (331.83 * 2 = 663.66)
- WobjFloor의 회전 때문?

### 확인 필요

이전 테스트 파일에서 Robot1 tWeld 값 확인:
```
파일: home_position_test_robot1.txt
항목: tWeld1 - WobjFloor
   Z = ??? mm
```

**만약**:
- Robot1 tWeld Z = 797 mm 정도라면
- 양 로봇 tWeld Z가 동일 → 정상 ✅
- WobjFloor Z축이 반대 방향

---

## 💡 권장 사항

### 즉시 실행

1. **이전 테스트 결과 확인**
   ```
   HOME:/home_position_test_robot1.txt
   → tWeld1 - WobjFloor의 Z 값 확인
   ```

2. **Robot1 tWeld도 측정하도록 코드 수정**
   - 현재: Robot1 active tool만 읽음
   - 개선: Robot1도 tool0, tWeld 분리 측정

3. **간소화된 TCP 생성 및 테스트**
   ```rapid
   tWeldTest: [100, 0, 100]
   ```

### 장기 계획

1. **설정 파일 시스템 구축**
   - TCP 값을 파일에서 읽기
   - 테스트/운영 모드 전환 용이

2. **자동 검증 함수**
   ```rapid
   PROC VerifyTCPConsistency()
       ! 양 로봇 tWeld 차이 = tool0 차이 확인
       ! 허용 오차 범위 설정
   ENDPROC
   ```

3. **상세 보고서 생성**
   - 모든 설정값
   - 예상값 vs 측정값
   - 오차 분석

---

## 📝 다음 단계

1. **현재 데이터 재분석**
   - 이전 Robot1 tWeld 측정값 확인
   - Z축 방향 검증

2. **코드 개선**
   - 설정 정보 출력 추가
   - Robot1 tool0/tWeld 분리 측정

3. **간소화된 TCP 테스트**
   - tWeldTest 생성
   - 검증 용이성 확인

---

**작성 완료**: 2025-12-05
**우선순위**: 높음 (데이터 검증 필요)
**다음**: 이전 테스트 결과 확인 및 Z축 값 분석
