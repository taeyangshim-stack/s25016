<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìš©ì ‘ì„  ê±´ì „ì„± ê²€ì¦ - Weld Line Validation</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --border: #e0e4eb;
      --text: #2c3e50;
      --muted: #7f8c9a;
      --accent: #3498db;
      --line1: #e74c3c;
      --line2: #27ae60;
      --pass: #27ae60;
      --fail: #e74c3c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 13px/1.5 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
    }
    header {
      padding: 16px 20px;
      background: #fff;
      border-bottom: 1px solid var(--border);
    }
    h1 { margin: 0 0 2px; font-size: 18px; }
    .subtitle { color: var(--muted); font-size: 12px; }
    main { padding: 16px; max-width: 1600px; margin: 0 auto; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .panel h2 { margin: 0 0 12px; font-size: 14px; color: var(--accent); font-weight: 600; }

    /* ì…ë ¥ */
    .input-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .line-group {
      display: flex; gap: 12px; padding: 12px;
      background: #fafbfc; border: 1px solid var(--border); border-radius: 8px;
    }
    .line-group.line1 { border-left: 3px solid var(--line1); }
    .line-group.line2 { border-left: 3px solid var(--line2); }
    .point-box h4 { margin: 0 0 6px; font-size: 11px; color: var(--muted); }
    .coords-row { display: flex; gap: 4px; }
    .coord-input { display: flex; flex-direction: column; align-items: center; }
    .coord-input span { font-size: 10px; color: var(--muted); margin-bottom: 2px; }
    .coord-input input {
      width: 60px; padding: 6px 4px; border: 1px solid var(--border);
      border-radius: 4px; background: #fff; font-size: 12px; text-align: center;
    }
    .coord-input input:focus { outline: none; border-color: var(--accent); }

    /* ì„¤ì • */
    .settings-box {
      display: flex; flex-direction: column; gap: 6px; padding: 10px 12px;
      background: #f0f4f8; border: 1px solid var(--border); border-radius: 8px;
    }
    .settings-box h4 { margin: 0 0 4px; font-size: 11px; color: var(--muted); }
    .setting-row { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text); }
    .setting-row input { width: 50px; padding: 4px; border: 1px solid var(--border); border-radius: 3px; text-align: center; font-size: 11px; }

    .btn-group { display: flex; gap: 6px; margin-left: auto; }
    button {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
      background: #fff; font-size: 11px; cursor: pointer; white-space: nowrap;
    }
    button:hover { background: #f8f9fa; border-color: var(--accent); }
    button.primary { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; }

    /* ë©”ì¸ */
    .main-area { display: grid; grid-template-columns: 320px 1fr; gap: 16px; min-height: 480px; }
    @media (max-width: 1100px) {
      .main-area { grid-template-columns: 1fr; }
      .input-row { flex-direction: column; }
      .btn-group { margin-left: 0; margin-top: 12px; width: 100%; }
    }

    /* ê²°ê³¼ */
    .result-panel { display: flex; flex-direction: column; gap: 8px; }
    .result-card {
      padding: 10px 12px; border-radius: 8px;
      border: 2px solid var(--border); background: #fafbfc;
    }
    .result-card.pass { background: linear-gradient(135deg, #d4efdf, #a9dfbf); border-color: var(--pass); }
    .result-card.fail { background: linear-gradient(135deg, #fadbd8, #f5b7b1); border-color: var(--fail); }
    .result-card h3 { margin: 0 0 4px; font-size: 10px; color: var(--muted); display: flex; align-items: center; gap: 4px; }
    .result-status { display: flex; align-items: center; gap: 8px; }
    .result-icon { font-size: 22px; }
    .result-text { font-size: 15px; font-weight: 700; }
    .result-card.pass .result-text { color: var(--pass); }
    .result-card.fail .result-text { color: var(--fail); }
    .result-detail { font-size: 10px; color: var(--muted); margin-top: 2px; }

    .total-result { padding: 14px; border-radius: 10px; text-align: center; margin-top: auto; }
    .total-result.pass { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; }
    .total-result.fail { background: linear-gradient(135deg, #c0392b, #e74c3c); color: #fff; }
    .total-result.waiting { background: #ecf0f1; color: var(--muted); }
    .total-result .total-icon { font-size: 32px; margin-bottom: 4px; }
    .total-result .total-text { font-size: 20px; font-weight: 700; }
    .total-result .total-detail { font-size: 11px; opacity: 0.9; margin-top: 2px; }

    /* ê·¸ë˜í”„ */
    .graph-panel { display: flex; flex-direction: column; }
    .canvas-wrap {
      flex: 1; background: #fff; border: 1px solid var(--border);
      border-radius: 8px; position: relative; min-height: 420px;
    }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .legend {
      position: absolute; top: 10px; right: 10px;
      background: rgba(255,255,255,0.95); padding: 8px 12px;
      border-radius: 6px; font-size: 11px; border: 1px solid var(--border);
    }
    .legend-item { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
    .legend-line { width: 16px; height: 3px; border-radius: 2px; }
    .legend-val { font-size: 10px; color: var(--muted); }

    /* ì½”ë“œ */
    .code-section { margin-top: 16px; }
    .code-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .code-tabs { display: flex; gap: 4px; }
    .code-tab {
      padding: 4px 10px; background: #f8f9fa; border: 1px solid var(--border);
      border-radius: 4px; color: var(--muted); cursor: pointer; font-size: 10px;
    }
    .code-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    pre {
      background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px;
      padding: 14px; overflow-x: auto; font-size: 11px; line-height: 1.5; margin: 0; max-height: 250px;
    }
    .keyword { color: #8e44ad; }
    .type { color: #2980b9; }
    .number { color: #e67e22; }
    .comment { color: #7f8c8d; }
    .method { color: #16a085; }

    /* ëª¨ë“œ ë²„íŠ¼ */
    .mode-btn {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #f8f9fa;
      font-size: 12px;
      cursor: pointer;
      margin-right: 4px;
    }
    .mode-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* ì¼ê´„ ê²€ì‚¬ ì„¹ì…˜ */
    .batch-section { display: none; }
    .batch-section.visible { display: block; }
    .log-textarea {
      width: 100%;
      height: 200px;
      font-family: 'Consolas', monospace;
      font-size: 11px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      resize: vertical;
    }
    .batch-controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }
    .parse-info { font-size: 11px; color: var(--muted); }
    .batch-results {
      margin-top: 16px;
      overflow-x: auto;
    }
    .batch-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .batch-table th, .batch-table td {
      padding: 8px 10px;
      border: 1px solid var(--border);
      text-align: center;
    }
    .batch-table th {
      background: #f5f7fa;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    .batch-table tr:hover { background: #f8f9fa; }
    .batch-table .pass { color: var(--pass); font-weight: 600; }
    .batch-table .fail { color: var(--fail); font-weight: 600; }
    .batch-table .row-pass { background: #e8f8f0; }
    .batch-table .row-fail { background: #fdf2f2; }
    .batch-summary {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    .batch-summary.all-pass { background: linear-gradient(135deg, #d4efdf, #a9dfbf); color: var(--pass); }
    .batch-summary.has-fail { background: linear-gradient(135deg, #fadbd8, #f5b7b1); color: var(--fail); }
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background: #e3f2fd !important; }
  </style>
</head>
<body>
  <header>
    <h1>ìš©ì ‘ì„  ê±´ì „ì„± ê²€ì¦</h1>
    <div class="subtitle">êµì°¨ + ë°©í–¥ + ê¸¸ì´ + ê°ë„ + ê±°ë¦¬ + ì‹œì‘ì  + ëì  ê²€ì‚¬ (7í•­ëª©)</div>
    <div style="margin-top: 8px;">
      <button onclick="toggleMode('manual')" id="modeManual" class="mode-btn active">ìˆ˜ë™ ì…ë ¥</button>
      <button onclick="toggleMode('batch')" id="modeBatch" class="mode-btn">ë¡œê·¸ ì¼ê´„ ê²€ì‚¬</button>
    </div>
  </header>

  <main>
    <!-- ì¼ê´„ ê²€ì‚¬ ì„¹ì…˜ -->
    <div id="batchSection" class="panel batch-section">
      <h2>gRPC ë¡œê·¸ ì¼ê´„ ê²€ì‚¬</h2>
      <p style="font-size: 11px; color: var(--muted); margin-bottom: 10px;">
        GantryRobotControllerService ë¡œê·¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ RequestWeldingOperationStart ìš”ì²­ì—ì„œ ìš©ì ‘ì„  ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì—¬ ì¼ê´„ ê±´ì „ì„± ê²€ì‚¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
      </p>
      <textarea id="logInput" class="log-textarea" placeholder="ë¡œê·¸ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...

ì˜ˆì‹œ:
2026-02-03 08:10:24 INFO - [GantryRobotControllerServiceImpl.RequestWeldingOperationStart()] ENTERED. { &quot;request&quot;: {...}, &quot;weldJobs&quot;: [...] }"></textarea>
      <div class="batch-controls">
        <div class="settings-box" style="flex-direction: row; gap: 12px; padding: 8px 12px;">
          <div class="setting-row">ê¸¸ì´ <input type="number" id="batchLenThreshold" value="20" min="0">mm</div>
          <div class="setting-row">ê°ë„ <input type="number" id="batchAngleThreshold" value="5" min="0">Â°</div>
          <div class="setting-row">ê±°ë¦¬ <input type="number" id="batchDistThreshold" value="20" min="0">mm</div>
          <div class="setting-row">ë³€ìœ„ <input type="number" id="batchOffsetThreshold" value="20" min="0">mm</div>
        </div>
        <button class="primary" onclick="parseLogs()">íŒŒì‹± & ê²€ì‚¬</button>
        <button onclick="clearLogs()">ì´ˆê¸°í™”</button>
        <span class="parse-info" id="parseInfo"></span>
      </div>
      <div id="batchResults" class="batch-results"></div>
    </div>

    <!-- ìˆ˜ë™ ì…ë ¥ ì„¹ì…˜ -->
    <div id="manualSection" class="panel">
      <h2>ì¢Œí‘œ ì…ë ¥ & ê²€ì‚¬ ì„¤ì •</h2>
      <div class="input-row">
        <div class="line-group line1">
          <div class="point-box">
            <h4>ì„ 1 ì‹œì‘</h4>
            <div class="coords-row">
              <div class="coord-input"><span>X</span><input type="number" id="s1x" value="0"></div>
              <div class="coord-input"><span>Y</span><input type="number" id="s1y" value="0"></div>
              <div class="coord-input"><span>Z</span><input type="number" id="s1z" value="0"></div>
            </div>
          </div>
          <div class="point-box">
            <h4>ì„ 1 ë</h4>
            <div class="coords-row">
              <div class="coord-input"><span>X</span><input type="number" id="e1x" value="3000"></div>
              <div class="coord-input"><span>Y</span><input type="number" id="e1y" value="0"></div>
              <div class="coord-input"><span>Z</span><input type="number" id="e1z" value="0"></div>
            </div>
          </div>
        </div>
        <div class="line-group line2">
          <div class="point-box">
            <h4>ì„ 2 ì‹œì‘</h4>
            <div class="coords-row">
              <div class="coord-input"><span>X</span><input type="number" id="s2x" value="0"></div>
              <div class="coord-input"><span>Y</span><input type="number" id="s2y" value="12"></div>
              <div class="coord-input"><span>Z</span><input type="number" id="s2z" value="0"></div>
            </div>
          </div>
          <div class="point-box">
            <h4>ì„ 2 ë</h4>
            <div class="coords-row">
              <div class="coord-input"><span>X</span><input type="number" id="e2x" value="3000"></div>
              <div class="coord-input"><span>Y</span><input type="number" id="e2y" value="12"></div>
              <div class="coord-input"><span>Z</span><input type="number" id="e2z" value="0"></div>
            </div>
          </div>
        </div>
        <div class="settings-box">
          <h4>ê²€ì‚¬ ì„ê³„ê°’</h4>
          <div class="setting-row">ê¸¸ì´ ì˜¤ì°¨ <input type="number" id="lenThreshold" value="20" min="0">mm</div>
          <div class="setting-row">ê°ë„ ì°¨ì´ <input type="number" id="angleThreshold" value="5" min="0">Â°</div>
          <div class="setting-row">ìµœëŒ€ ê±°ë¦¬ <input type="number" id="distThreshold" value="20" min="0">mm</div>
          <div class="setting-row">ì  ë³€ìœ„ <input type="number" id="offsetThreshold" value="20" min="0">mm</div>
        </div>
        <div class="btn-group">
          <button onclick="loadSample('cross')">êµì°¨</button>
          <button onclick="loadSample('dir')">ë°©í–¥</button>
          <button onclick="loadSample('len')">ê¸¸ì´</button>
          <button onclick="loadSample('angle')">ê°ë„</button>
          <button onclick="loadSample('dist')">ê±°ë¦¬</button>
          <button onclick="loadSample('startOff')">ì‹œì‘ì </button>
          <button onclick="loadSample('endOff')">ëì </button>
          <button onclick="loadSample('ok')">ì •ìƒ</button>
          <button class="primary" onclick="runValidation()">ê²€ì‚¬</button>
        </div>
      </div>
    </div>

    <div class="main-area">
      <div class="result-panel panel">
        <h2>ê²€ì‚¬ ê²°ê³¼ (7í•­ëª©)</h2>
        <div id="crossResult" class="result-card"><h3>âœ– êµì°¨</h3><div class="result-status"><span class="result-icon">â³</span><span class="result-text">ëŒ€ê¸°</span></div></div>
        <div id="dirResult" class="result-card"><h3>â¡ ë°©í–¥</h3><div class="result-status"><span class="result-icon">â³</span><span class="result-text">ëŒ€ê¸°</span></div></div>
        <div id="lenResult" class="result-card"><h3>ğŸ“ ê¸¸ì´</h3><div class="result-status"><span class="result-icon">â³</span><span class="result-text">ëŒ€ê¸°</span></div></div>
        <div id="angleResult" class="result-card"><h3>ğŸ“ ê°ë„</h3><div class="result-status"><span class="result-icon">â³</span><span class="result-text">ëŒ€ê¸°</span></div></div>
        <div id="distResult" class="result-card"><h3>â†” ê±°ë¦¬</h3><div class="result-status"><span class="result-icon">â³</span><span class="result-text">ëŒ€ê¸°</span></div></div>
        <div id="startOffResult" class="result-card"><h3>ğŸ¯ ì‹œì‘ì </h3><div class="result-status"><span class="result-icon">â³</span><span class="result-text">ëŒ€ê¸°</span></div></div>
        <div id="endOffResult" class="result-card"><h3>ğŸ ëì </h3><div class="result-status"><span class="result-icon">â³</span><span class="result-text">ëŒ€ê¸°</span></div></div>
        <div id="totalResult" class="total-result waiting">
          <div class="total-icon">â³</div>
          <div class="total-text">ëŒ€ê¸° ì¤‘</div>
          <div class="total-detail">ê²€ì‚¬ ë²„íŠ¼ í´ë¦­</div>
        </div>
      </div>

      <div class="graph-panel panel">
        <h2>XY í‰ë©´ ê·¸ë˜í”„</h2>
        <div class="canvas-wrap">
          <canvas id="canvas"></canvas>
          <div class="legend">
            <div class="legend-item"><div class="legend-line" style="background:var(--line1)"></div>ì„ 1 <span class="legend-val" id="info1"></span></div>
            <div class="legend-item"><div class="legend-line" style="background:var(--line2)"></div>ì„ 2 <span class="legend-val" id="info2"></span></div>
            <div class="legend-item" id="distInfo" style="display:none"><div class="legend-line" style="background:#9b59b6"></div>ê±°ë¦¬ <span class="legend-val" id="distVal"></span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel code-section">
      <div class="code-header">
        <h2>C# ì•Œê³ ë¦¬ì¦˜</h2>
        <div class="code-tabs">
          <div class="code-tab active" onclick="showCode('full')">ì „ì²´</div>
          <div class="code-tab" onclick="showCode('cross')">êµì°¨</div>
          <div class="code-tab" onclick="showCode('dir')">ë°©í–¥</div>
          <div class="code-tab" onclick="showCode('len')">ê¸¸ì´</div>
          <div class="code-tab" onclick="showCode('angle')">ê°ë„</div>
          <div class="code-tab" onclick="showCode('dist')">ê±°ë¦¬</div>
          <div class="code-tab" onclick="showCode('startOff')">ì‹œì‘ì </div>
          <div class="code-tab" onclick="showCode('endOff')">ëì </div>
        </div>
      </div>
      <pre><code id="code-content"></code></pre>
    </div>
  </main>

  <script>
    const csharpCodeFull = `<span class="keyword">public class</span> <span class="type">WeldLineValidator</span>
{
    <span class="comment">// 1. êµì°¨ ê²€ì‚¬ (CCW)</span>
    <span class="keyword">public static bool</span> <span class="method">CheckCrossing</span>(...) { <span class="comment">/* CCW ì•Œê³ ë¦¬ì¦˜ */</span> }

    <span class="comment">// 2. ë°©í–¥ ê²€ì‚¬ (ë‚´ì )</span>
    <span class="keyword">public static bool</span> <span class="method">CheckDirection</span>(...) { <span class="keyword">return</span> dot > <span class="number">0</span>; }

    <span class="comment">// 3. ê¸¸ì´ ê²€ì‚¬ (ì ˆëŒ€ê°’ ì°¨ì´, mm)</span>
    <span class="keyword">public static bool</span> <span class="method">CheckLength</span>(..., <span class="keyword">double</span> threshold) { <span class="keyword">return</span> diff <= threshold; }

    <span class="comment">// 4. ê°ë„ ê²€ì‚¬</span>
    <span class="keyword">public static</span> (<span class="keyword">bool</span>, <span class="keyword">double</span>) <span class="method">CheckAngle</span>(..., <span class="keyword">double</span> thresholdDeg)
    {
        <span class="keyword">double</span> angle1 = Math.Atan2(v1y, v1x) * <span class="number">180</span> / Math.PI;
        <span class="keyword">double</span> angle2 = Math.Atan2(v2y, v2x) * <span class="number">180</span> / Math.PI;
        <span class="keyword">double</span> diff = Math.Abs(angle1 - angle2);
        <span class="keyword">if</span> (diff > <span class="number">180</span>) diff = <span class="number">360</span> - diff;
        <span class="keyword">return</span> (diff <= thresholdDeg, diff);
    }

    <span class="comment">// 5. ê±°ë¦¬ ê²€ì‚¬ (ì -ì„ ë¶„ ìµœì†Œê±°ë¦¬)</span>
    <span class="keyword">public static</span> (<span class="keyword">bool</span>, <span class="keyword">double</span>) <span class="method">CheckDistance</span>(..., <span class="keyword">double</span> maxDist)
    {
        <span class="keyword">double</span> dist = <span class="method">PointToSegmentDistance</span>(mid1, s2, e2);
        <span class="keyword">return</span> (dist <= maxDist, dist);
    }

    <span class="comment">// 6. ì‹œì‘ì  ë³€ìœ„ ê²€ì‚¬</span>
    <span class="keyword">public static</span> (<span class="keyword">bool</span>, <span class="keyword">double</span>) <span class="method">CheckStartOffset</span>(
        <span class="keyword">double</span> s1x, <span class="keyword">double</span> s1y, <span class="keyword">double</span> s2x, <span class="keyword">double</span> s2y,
        <span class="keyword">double</span> threshold = <span class="number">20</span>)
    {
        <span class="keyword">double</span> dist = Math.Sqrt((s2x-s1x)*(s2x-s1x) + (s2y-s1y)*(s2y-s1y));
        <span class="keyword">return</span> (dist <= threshold, dist);
    }

    <span class="comment">// 7. ëì  ë³€ìœ„ ê²€ì‚¬</span>
    <span class="keyword">public static</span> (<span class="keyword">bool</span>, <span class="keyword">double</span>) <span class="method">CheckEndOffset</span>(
        <span class="keyword">double</span> e1x, <span class="keyword">double</span> e1y, <span class="keyword">double</span> e2x, <span class="keyword">double</span> e2y,
        <span class="keyword">double</span> threshold = <span class="number">20</span>)
    {
        <span class="keyword">double</span> dist = Math.Sqrt((e2x-e1x)*(e2x-e1x) + (e2y-e1y)*(e2y-e1y));
        <span class="keyword">return</span> (dist <= threshold, dist);
    }

    <span class="comment">// ì¢…í•© ê²€ì¦ (7í•­ëª©)</span>
    <span class="keyword">public static</span> ValidationResult <span class="method">Validate</span>(...)
    {
        <span class="keyword">return new</span> ValidationResult {
            CrossOK = !CheckCrossing(...),
            DirOK = CheckDirection(...),
            LenOK = CheckLength(...),
            AngleOK = CheckAngle(...),
            DistOK = CheckDistance(...),
            StartOffOK = CheckStartOffset(...),
            EndOffOK = CheckEndOffset(...)
        };
    }
}`;

    const csharpCodeAngle = `<span class="comment">// ê°ë„ ì°¨ì´ ê²€ì‚¬</span>
<span class="keyword">public static</span> (<span class="keyword">bool</span> ok, <span class="keyword">double</span> diff) <span class="method">CheckAngle</span>(
    <span class="keyword">double</span> s1x, <span class="keyword">double</span> s1y, <span class="keyword">double</span> e1x, <span class="keyword">double</span> e1y,
    <span class="keyword">double</span> s2x, <span class="keyword">double</span> s2y, <span class="keyword">double</span> e2x, <span class="keyword">double</span> e2y,
    <span class="keyword">double</span> thresholdDeg = <span class="number">10</span>)
{
    <span class="comment">// ë°©í–¥ ë²¡í„°</span>
    <span class="keyword">double</span> v1x = e1x - s1x, v1y = e1y - s1y;
    <span class="keyword">double</span> v2x = e2x - s2x, v2y = e2y - s2y;

    <span class="comment">// ê°ë„ ê³„ì‚° (ë¼ë””ì•ˆ â†’ ë„)</span>
    <span class="keyword">double</span> angle1 = Math.Atan2(v1y, v1x) * <span class="number">180</span> / Math.PI;
    <span class="keyword">double</span> angle2 = Math.Atan2(v2y, v2x) * <span class="number">180</span> / Math.PI;

    <span class="comment">// ê°ë„ ì°¨ì´ (0~180ë„ ë²”ìœ„)</span>
    <span class="keyword">double</span> diff = Math.Abs(angle1 - angle2);
    <span class="keyword">if</span> (diff > <span class="number">180</span>) diff = <span class="number">360</span> - diff;

    <span class="keyword">return</span> (diff <= thresholdDeg, diff);
}`;

    const csharpCodeCross = `<span class="comment">// êµì°¨ ê²€ì‚¬ (CCW ì•Œê³ ë¦¬ì¦˜)</span>
<span class="comment">// CCW: Counter-Clockwise - ì„¸ ì ì˜ ë°©í–¥ íŒë³„</span>

<span class="keyword">private static int</span> <span class="method">CCW</span>(
    <span class="keyword">double</span> ax, <span class="keyword">double</span> ay,
    <span class="keyword">double</span> bx, <span class="keyword">double</span> by,
    <span class="keyword">double</span> cx, <span class="keyword">double</span> cy)
{
    <span class="comment">// ì™¸ì (Cross Product)ìœ¼ë¡œ ë°©í–¥ íŒë³„</span>
    <span class="keyword">double</span> cross = (bx - ax) * (cy - ay) - (by - ay) * (cx - ax);

    <span class="keyword">if</span> (cross > <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;   <span class="comment">// ë°˜ì‹œê³„ ë°©í–¥</span>
    <span class="keyword">if</span> (cross < <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;  <span class="comment">// ì‹œê³„ ë°©í–¥</span>
    <span class="keyword">return</span> <span class="number">0</span>;                   <span class="comment">// ì¼ì§ì„ </span>
}

<span class="keyword">public static bool</span> <span class="method">CheckCrossing</span>(
    <span class="keyword">double</span> s1x, <span class="keyword">double</span> s1y, <span class="keyword">double</span> e1x, <span class="keyword">double</span> e1y,
    <span class="keyword">double</span> s2x, <span class="keyword">double</span> s2y, <span class="keyword">double</span> e2x, <span class="keyword">double</span> e2y)
{
    <span class="comment">// ì„ ë¶„1 ê¸°ì¤€ìœ¼ë¡œ ì„ ë¶„2ì˜ ë‘ ëì  ë°©í–¥ í™•ì¸</span>
    <span class="keyword">int</span> d1 = CCW(s1x, s1y, e1x, e1y, s2x, s2y);
    <span class="keyword">int</span> d2 = CCW(s1x, s1y, e1x, e1y, e2x, e2y);

    <span class="comment">// ì„ ë¶„2 ê¸°ì¤€ìœ¼ë¡œ ì„ ë¶„1ì˜ ë‘ ëì  ë°©í–¥ í™•ì¸</span>
    <span class="keyword">int</span> d3 = CCW(s2x, s2y, e2x, e2y, s1x, s1y);
    <span class="keyword">int</span> d4 = CCW(s2x, s2y, e2x, e2y, e1x, e1y);

    <span class="comment">// ë‘ ì„ ë¶„ì´ ì„œë¡œ ë‹¤ë¥¸ ë°©í–¥ì— ìˆìœ¼ë©´ êµì°¨</span>
    <span class="keyword">return</span> (d1 * d2 < <span class="number">0</span>) && (d3 * d4 < <span class="number">0</span>);
}

<span class="comment">// ì‚¬ìš© ì˜ˆì‹œ</span>
<span class="keyword">bool</span> isCrossing = CheckCrossing(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y);
<span class="keyword">bool</span> crossOK = !isCrossing;  <span class="comment">// êµì°¨í•˜ì§€ ì•Šì•„ì•¼ Pass</span>`;

    const csharpCodeDir = `<span class="comment">// ë°©í–¥ ê²€ì‚¬ (ë‚´ì /Dot Product)</span>
<span class="comment">// ë‘ ë²¡í„°ì˜ ë‚´ì ì´ ì–‘ìˆ˜ë©´ ê°™ì€ ë°©í–¥, ìŒìˆ˜ë©´ ë°˜ëŒ€ ë°©í–¥</span>

<span class="keyword">public static bool</span> <span class="method">CheckDirection</span>(
    <span class="keyword">double</span> s1x, <span class="keyword">double</span> s1y, <span class="keyword">double</span> e1x, <span class="keyword">double</span> e1y,
    <span class="keyword">double</span> s2x, <span class="keyword">double</span> s2y, <span class="keyword">double</span> e2x, <span class="keyword">double</span> e2y)
{
    <span class="comment">// ë°©í–¥ ë²¡í„° ê³„ì‚°</span>
    <span class="keyword">double</span> v1x = e1x - s1x;  <span class="comment">// ì„ 1ì˜ X ë°©í–¥</span>
    <span class="keyword">double</span> v1y = e1y - s1y;  <span class="comment">// ì„ 1ì˜ Y ë°©í–¥</span>
    <span class="keyword">double</span> v2x = e2x - s2x;  <span class="comment">// ì„ 2ì˜ X ë°©í–¥</span>
    <span class="keyword">double</span> v2y = e2y - s2y;  <span class="comment">// ì„ 2ì˜ Y ë°©í–¥</span>

    <span class="comment">// ë‚´ì (Dot Product) ê³„ì‚°</span>
    <span class="comment">// dot = v1Â·v2 = |v1||v2|cos(Î¸)</span>
    <span class="keyword">double</span> dot = v1x * v2x + v1y * v2y;

    <span class="comment">// dot > 0: ê°™ì€ ë°©í–¥ (0Â° ~ 90Â°)</span>
    <span class="comment">// dot < 0: ë°˜ëŒ€ ë°©í–¥ (90Â° ~ 180Â°)</span>
    <span class="comment">// dot = 0: ì§ê° (90Â°)</span>
    <span class="keyword">return</span> dot > <span class="number">0</span>;
}

<span class="comment">// ì‚¬ìš© ì˜ˆì‹œ</span>
<span class="keyword">bool</span> sameDirection = CheckDirection(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y);
<span class="comment">// sameDirectionì´ trueë©´ Pass</span>`;

    const csharpCodeLen = `<span class="comment">// ê¸¸ì´ ê²€ì‚¬ (ì ˆëŒ€ê°’ ì°¨ì´)</span>
<span class="comment">// ë‘ ì„ ë¶„ì˜ ê¸¸ì´ ì°¨ì´ê°€ ì„ê³„ê°’ ì´ë‚´ì¸ì§€ í™•ì¸</span>

<span class="keyword">private static double</span> <span class="method">GetLength</span>(
    <span class="keyword">double</span> sx, <span class="keyword">double</span> sy,
    <span class="keyword">double</span> ex, <span class="keyword">double</span> ey)
{
    <span class="comment">// ìœ í´ë¦¬ë“œ ê±°ë¦¬ ê³µì‹</span>
    <span class="keyword">double</span> dx = ex - sx;
    <span class="keyword">double</span> dy = ey - sy;
    <span class="keyword">return</span> Math.Sqrt(dx * dx + dy * dy);
}

<span class="keyword">public static</span> (<span class="keyword">bool</span> ok, <span class="keyword">double</span> diff, <span class="keyword">double</span> len1, <span class="keyword">double</span> len2) <span class="method">CheckLength</span>(
    <span class="keyword">double</span> s1x, <span class="keyword">double</span> s1y, <span class="keyword">double</span> e1x, <span class="keyword">double</span> e1y,
    <span class="keyword">double</span> s2x, <span class="keyword">double</span> s2y, <span class="keyword">double</span> e2x, <span class="keyword">double</span> e2y,
    <span class="keyword">double</span> threshold = <span class="number">20</span>)  <span class="comment">// ê¸°ë³¸ê°’ 20mm</span>
{
    <span class="comment">// ê° ì„ ë¶„ì˜ ê¸¸ì´ ê³„ì‚°</span>
    <span class="keyword">double</span> len1 = GetLength(s1x, s1y, e1x, e1y);
    <span class="keyword">double</span> len2 = GetLength(s2x, s2y, e2x, e2y);

    <span class="comment">// ì ˆëŒ€ê°’ ì°¨ì´</span>
    <span class="keyword">double</span> diff = Math.Abs(len1 - len2);

    <span class="comment">// ì°¨ì´ê°€ ì„ê³„ê°’ ì´í•˜ë©´ Pass</span>
    <span class="keyword">return</span> (diff <= threshold, diff, len1, len2);
}

<span class="comment">// ì‚¬ìš© ì˜ˆì‹œ</span>
<span class="keyword">var</span> result = CheckLength(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y, <span class="number">20</span>);
<span class="comment">// result.okê°€ trueë©´ Pass</span>
<span class="comment">// result.diff: ê¸¸ì´ ì°¨ì´ (mm)</span>`;

    const csharpCodeDist = `<span class="comment">// ê±°ë¦¬ ê²€ì‚¬ (ì -ì„ ë¶„ ìµœì†Œ ìˆ˜ì§ê±°ë¦¬)</span>
<span class="comment">// ì„ ë¶„1ì˜ ì¤‘ì ì—ì„œ ì„ ë¶„2ê¹Œì§€ì˜ ìµœì†Œ ê±°ë¦¬ ê³„ì‚°</span>

<span class="keyword">public static double</span> <span class="method">PointToSegmentDistance</span>(
    <span class="keyword">double</span> px, <span class="keyword">double</span> py,
    <span class="keyword">double</span> ax, <span class="keyword">double</span> ay,
    <span class="keyword">double</span> bx, <span class="keyword">double</span> by)
{
    <span class="keyword">double</span> dx = bx - ax, dy = by - ay;
    <span class="keyword">double</span> lenSq = dx * dx + dy * dy;

    <span class="keyword">if</span> (lenSq == <span class="number">0</span>) <span class="keyword">return</span> Math.Sqrt((px-ax)*(px-ax) + (py-ay)*(py-ay));

    <span class="comment">// íˆ¬ì˜ ê³„ìˆ˜ t (0~1 ë²”ìœ„ë¡œ í´ë¨í”„)</span>
    <span class="keyword">double</span> t = Math.Max(<span class="number">0</span>, Math.Min(<span class="number">1</span>, ((px-ax)*dx + (py-ay)*dy) / lenSq));

    <span class="comment">// ì„ ë¶„ ìœ„ ê°€ì¥ ê°€ê¹Œìš´ ì </span>
    <span class="keyword">double</span> projX = ax + t * dx;
    <span class="keyword">double</span> projY = ay + t * dy;

    <span class="keyword">return</span> Math.Sqrt((px-projX)*(px-projX) + (py-projY)*(py-projY));
}

<span class="keyword">public static</span> (<span class="keyword">bool</span> ok, <span class="keyword">double</span> dist) <span class="method">CheckDistance</span>(
    <span class="keyword">double</span> s1x, <span class="keyword">double</span> s1y, <span class="keyword">double</span> e1x, <span class="keyword">double</span> e1y,
    <span class="keyword">double</span> s2x, <span class="keyword">double</span> s2y, <span class="keyword">double</span> e2x, <span class="keyword">double</span> e2y,
    <span class="keyword">double</span> maxDist = <span class="number">20</span>)
{
    <span class="comment">// ì„ ë¶„1 ì¤‘ì ì—ì„œ ì„ ë¶„2ê¹Œì§€ ê±°ë¦¬</span>
    <span class="keyword">double</span> mid1x = (s1x + e1x) / <span class="number">2</span>, mid1y = (s1y + e1y) / <span class="number">2</span>;
    <span class="keyword">double</span> dist = PointToSegmentDistance(mid1x, mid1y, s2x, s2y, e2x, e2y);
    <span class="keyword">return</span> (dist <= maxDist, dist);
}`;

    const csharpCodeStartOff = `<span class="comment">// ì‹œì‘ì  ë³€ìœ„ ê²€ì‚¬</span>
<span class="comment">// ë‘ ì„ ë¶„ì˜ ì‹œì‘ì  ê°„ ê±°ë¦¬ê°€ ì„ê³„ê°’ ì´ë‚´ì¸ì§€ í™•ì¸</span>
<span class="comment">// ëª©ì : í‰í–‰í•˜ê²Œ ì´ë™ëœ(offset) ì„ ë¶„ ê²€ì¶œ</span>

<span class="keyword">public static</span> (<span class="keyword">bool</span> ok, <span class="keyword">double</span> dist) <span class="method">CheckStartOffset</span>(
    <span class="keyword">double</span> s1x, <span class="keyword">double</span> s1y,
    <span class="keyword">double</span> s2x, <span class="keyword">double</span> s2y,
    <span class="keyword">double</span> threshold = <span class="number">20</span>)
{
    <span class="comment">// ë‘ ì‹œì‘ì  ê°„ ìœ í´ë¦¬ë“œ ê±°ë¦¬</span>
    <span class="keyword">double</span> dx = s2x - s1x;
    <span class="keyword">double</span> dy = s2y - s1y;
    <span class="keyword">double</span> dist = Math.Sqrt(dx * dx + dy * dy);

    <span class="comment">// ê±°ë¦¬ê°€ ì„ê³„ê°’ ì´í•˜ë©´ Pass</span>
    <span class="keyword">return</span> (dist <= threshold, dist);
}

<span class="comment">// ì‚¬ìš© ì˜ˆì‹œ</span>
<span class="keyword">var</span> result = CheckStartOffset(s1x, s1y, s2x, s2y, <span class="number">20</span>);
<span class="comment">// result.okê°€ trueë©´ Pass</span>
<span class="comment">// result.dist: ì‹œì‘ì  ê°„ ê±°ë¦¬ (mm)</span>`;

    const csharpCodeEndOff = `<span class="comment">// ëì  ë³€ìœ„ ê²€ì‚¬</span>
<span class="comment">// ë‘ ì„ ë¶„ì˜ ëì  ê°„ ê±°ë¦¬ê°€ ì„ê³„ê°’ ì´ë‚´ì¸ì§€ í™•ì¸</span>
<span class="comment">// ëª©ì : í‰í–‰í•˜ê²Œ ì´ë™ëœ(offset) ì„ ë¶„ ê²€ì¶œ</span>

<span class="keyword">public static</span> (<span class="keyword">bool</span> ok, <span class="keyword">double</span> dist) <span class="method">CheckEndOffset</span>(
    <span class="keyword">double</span> e1x, <span class="keyword">double</span> e1y,
    <span class="keyword">double</span> e2x, <span class="keyword">double</span> e2y,
    <span class="keyword">double</span> threshold = <span class="number">20</span>)
{
    <span class="comment">// ë‘ ëì  ê°„ ìœ í´ë¦¬ë“œ ê±°ë¦¬</span>
    <span class="keyword">double</span> dx = e2x - e1x;
    <span class="keyword">double</span> dy = e2y - e1y;
    <span class="keyword">double</span> dist = Math.Sqrt(dx * dx + dy * dy);

    <span class="comment">// ê±°ë¦¬ê°€ ì„ê³„ê°’ ì´í•˜ë©´ Pass</span>
    <span class="keyword">return</span> (dist <= threshold, dist);
}

<span class="comment">// ì‚¬ìš© ì˜ˆì‹œ</span>
<span class="keyword">var</span> result = CheckEndOffset(e1x, e1y, e2x, e2y, <span class="number">20</span>);
<span class="comment">// result.okê°€ trueë©´ Pass</span>
<span class="comment">// result.dist: ëì  ê°„ ê±°ë¦¬ (mm)</span>`;

    // === Algorithms ===
    function ccw(ax, ay, bx, by, cx, cy) {
      return (bx - ax) * (cy - ay) - (by - ay) * (cx - ax);
    }

    function checkCrossing(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y) {
      const d1 = ccw(s2x, s2y, e2x, e2y, s1x, s1y);
      const d2 = ccw(s2x, s2y, e2x, e2y, e1x, e1y);
      const d3 = ccw(s1x, s1y, e1x, e1y, s2x, s2y);
      const d4 = ccw(s1x, s1y, e1x, e1y, e2x, e2y);
      return ((d1 > 0 && d2 < 0) || (d1 < 0 && d2 > 0)) && ((d3 > 0 && d4 < 0) || (d3 < 0 && d4 > 0));
    }

    function checkDirection(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y) {
      const dot = (e1x - s1x) * (e2x - s2x) + (e1y - s1y) * (e2y - s2y);
      return dot > 0;
    }

    function getLength(sx, sy, ex, ey) {
      return Math.sqrt((ex - sx) ** 2 + (ey - sy) ** 2);
    }

    function checkLength(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y, threshold) {
      const len1 = getLength(s1x, s1y, e1x, e1y);
      const len2 = getLength(s2x, s2y, e2x, e2y);
      const diff = Math.abs(len1 - len2);  // ì ˆëŒ€ê°’ ì°¨ì´ (mm)
      return { ok: diff <= threshold, diff, len1, len2 };
    }

    function checkAngle(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y, threshold) {
      const angle1 = Math.atan2(e1y - s1y, e1x - s1x) * 180 / Math.PI;
      const angle2 = Math.atan2(e2y - s2y, e2x - s2x) * 180 / Math.PI;
      let diff = Math.abs(angle1 - angle2);
      if (diff > 180) diff = 360 - diff;
      return { ok: diff <= threshold, diff, angle1, angle2 };
    }

    function pointToSegmentDist(px, py, ax, ay, bx, by) {
      const dx = bx - ax, dy = by - ay;
      const lenSq = dx * dx + dy * dy;
      if (lenSq === 0) return Math.sqrt((px - ax) ** 2 + (py - ay) ** 2);
      const t = Math.max(0, Math.min(1, ((px - ax) * dx + (py - ay) * dy) / lenSq));
      const projX = ax + t * dx, projY = ay + t * dy;
      return Math.sqrt((px - projX) ** 2 + (py - projY) ** 2);
    }

    function checkDistance(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y, maxDist) {
      const mid1x = (s1x + e1x) / 2, mid1y = (s1y + e1y) / 2;
      const dist = pointToSegmentDist(mid1x, mid1y, s2x, s2y, e2x, e2y);
      return { ok: dist <= maxDist, dist, mid1x, mid1y };
    }

    function checkStartOffset(s1x, s1y, s2x, s2y, threshold) {
      const dx = s2x - s1x, dy = s2y - s1y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      return { ok: dist <= threshold, dist };
    }

    function checkEndOffset(e1x, e1y, e2x, e2y, threshold) {
      const dx = e2x - e1x, dy = e2y - e1y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      return { ok: dist <= threshold, dist };
    }

    // === UI ===
    function getInputValues() {
      const get = id => parseFloat(document.getElementById(id).value) || 0;
      return {
        s1x: get('s1x'), s1y: get('s1y'), s1z: get('s1z'),
        e1x: get('e1x'), e1y: get('e1y'), e1z: get('e1z'),
        s2x: get('s2x'), s2y: get('s2y'), s2z: get('s2z'),
        e2x: get('e2x'), e2y: get('e2y'), e2z: get('e2z'),
        lenThreshold: get('lenThreshold'),
        angleThreshold: get('angleThreshold'),
        distThreshold: get('distThreshold'),
        offsetThreshold: get('offsetThreshold')
      };
    }

    function setInputValues(vals) {
      for (const [k, v] of Object.entries(vals)) {
        const el = document.getElementById(k);
        if (el) el.value = v;
      }
    }

    // ì‹¤ì œ ìš©ì ‘ í™˜ê²½ ê¸°ë°˜ ìƒ˜í”Œ (3000mm ë¼ì¸, 12mm ê°„ê²©)
    const samples = {
      cross: { s1x:0,s1y:0,e1x:3000,e1y:3000, s2x:0,s2y:3000,e2x:3000,e2y:0 },   // êµì°¨
      dir: { s1x:0,s1y:0,e1x:3000,e1y:0, s2x:3000,s2y:12,e2x:0,e2y:12 },          // ë°©í–¥ ì—­ì „
      len: { s1x:0,s1y:0,e1x:3000,e1y:0, s2x:0,s2y:12,e2x:2950,e2y:12 },          // ê¸¸ì´ ì°¨ì´ 50mm
      angle: { s1x:0,s1y:0,e1x:3000,e1y:0, s2x:0,s2y:12,e2x:3000,e2y:312 },       // ê°ë„ ì°¨ì´ ~5.7Â°
      dist: { s1x:0,s1y:0,e1x:3000,e1y:0, s2x:0,s2y:50,e2x:3000,e2y:50 },         // ê±°ë¦¬ 50mm (ì´ˆê³¼)
      startOff: { s1x:0,s1y:0,e1x:3000,e1y:0, s2x:70,s2y:0,e2x:3070,e2y:0 },     // ì‹œì‘ì  70mm ë³€ìœ„ (í‰í–‰ ì´ë™)
      endOff: { s1x:0,s1y:0,e1x:3000,e1y:0, s2x:0,s2y:0,e2x:2930,e2y:0 },         // ëì  70mm ë³€ìœ„
      ok: { s1x:0,s1y:0,e1x:3000,e1y:0, s2x:0,s2y:12,e2x:3000,e2y:12 }            // ì •ìƒ (12mm ê°„ê²©)
    };

    function loadSample(type) {
      setInputValues({...samples[type], s1z:0, e1z:0, s2z:0, e2z:0});
      runValidation();
    }

    function updateResult(id, ok, text, detail) {
      const el = document.getElementById(id);
      el.className = `result-card ${ok ? 'pass' : 'fail'}`;
      el.querySelector('.result-icon').textContent = ok ? 'âœ…' : 'âŒ';
      el.querySelector('.result-text').textContent = text;
      const detailEl = el.querySelector('.result-detail');
      if (detailEl) detailEl.textContent = detail;
      else {
        const d = document.createElement('div');
        d.className = 'result-detail';
        d.textContent = detail;
        el.querySelector('.result-status').appendChild(d);
      }
    }

    function runValidation() {
      const v = getInputValues();

      const cross = checkCrossing(v.s1x, v.s1y, v.e1x, v.e1y, v.s2x, v.s2y, v.e2x, v.e2y);
      const dir = checkDirection(v.s1x, v.s1y, v.e1x, v.e1y, v.s2x, v.s2y, v.e2x, v.e2y);
      const len = checkLength(v.s1x, v.s1y, v.e1x, v.e1y, v.s2x, v.s2y, v.e2x, v.e2y, v.lenThreshold);
      const angle = checkAngle(v.s1x, v.s1y, v.e1x, v.e1y, v.s2x, v.s2y, v.e2x, v.e2y, v.angleThreshold);
      const dist = checkDistance(v.s1x, v.s1y, v.e1x, v.e1y, v.s2x, v.s2y, v.e2x, v.e2y, v.distThreshold);
      const startOff = checkStartOffset(v.s1x, v.s1y, v.s2x, v.s2y, v.offsetThreshold);
      const endOff = checkEndOffset(v.e1x, v.e1y, v.e2x, v.e2y, v.offsetThreshold);

      const crossOK = !cross, dirOK = dir, lenOK = len.ok, angleOK = angle.ok, distOK = dist.ok;
      const startOffOK = startOff.ok, endOffOK = endOff.ok;
      const allOK = crossOK && dirOK && lenOK && angleOK && distOK && startOffOK && endOffOK;

      updateResult('crossResult', crossOK, crossOK ? 'PASS' : 'FAIL', crossOK ? 'êµì°¨ ì—†ìŒ' : 'êµì°¨ ë°œìƒ!');
      updateResult('dirResult', dirOK, dirOK ? 'PASS' : 'FAIL', dirOK ? 'ê°™ì€ ë°©í–¥' : 'ë°©í–¥ ì—­ì „!');
      updateResult('lenResult', lenOK, lenOK ? 'PASS' : 'FAIL', `ì°¨ì´ ${len.diff.toFixed(1)}mm (â‰¤${v.lenThreshold}mm)`);
      updateResult('angleResult', angleOK, angleOK ? 'PASS' : 'FAIL', `ì°¨ì´ ${angle.diff.toFixed(1)}Â° (â‰¤${v.angleThreshold}Â°)`);
      updateResult('distResult', distOK, distOK ? 'PASS' : 'FAIL', `ê±°ë¦¬ ${dist.dist.toFixed(1)}mm (â‰¤${v.distThreshold}mm)`);
      updateResult('startOffResult', startOffOK, startOffOK ? 'PASS' : 'FAIL', `ë³€ìœ„ ${startOff.dist.toFixed(1)}mm (â‰¤${v.offsetThreshold}mm)`);
      updateResult('endOffResult', endOffOK, endOffOK ? 'PASS' : 'FAIL', `ë³€ìœ„ ${endOff.dist.toFixed(1)}mm (â‰¤${v.offsetThreshold}mm)`);

      const fails = [];
      if (!crossOK) fails.push('êµì°¨');
      if (!dirOK) fails.push('ë°©í–¥');
      if (!lenOK) fails.push('ê¸¸ì´');
      if (!angleOK) fails.push('ê°ë„');
      if (!distOK) fails.push('ê±°ë¦¬');
      if (!startOffOK) fails.push('ì‹œì‘ì ');
      if (!endOffOK) fails.push('ëì ');

      const total = document.getElementById('totalResult');
      total.className = `total-result ${allOK ? 'pass' : 'fail'}`;
      total.innerHTML = `
        <div class="total-icon">${allOK ? 'âœ…' : 'âŒ'}</div>
        <div class="total-text">${allOK ? 'ì¢…í•© PASS' : 'ì¢…í•© FAIL'}</div>
        <div class="total-detail">${allOK ? '7ê°œ í•­ëª© ëª¨ë‘ í†µê³¼' : fails.join('+') + ' ë¶ˆí•©ê²©'}</div>
      `;

      document.getElementById('info1').textContent = `L=${len.len1.toFixed(1)} Î¸=${angle.angle1.toFixed(1)}Â°`;
      document.getElementById('info2').textContent = `L=${len.len2.toFixed(1)} Î¸=${angle.angle2.toFixed(1)}Â°`;
      document.getElementById('distInfo').style.display = 'flex';
      document.getElementById('distVal').textContent = dist.dist.toFixed(1);

      drawCanvas(v, {cross, dir, len, angle, dist, startOff, endOff});
    }

    function drawCanvas(v, results) {
      const canvas = document.getElementById('canvas');
      const wrap = canvas.parentElement;
      const rect = wrap.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      const W = rect.width, H = rect.height, P = 60;

      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, W, H);

      const allX = [v.s1x, v.e1x, v.s2x, v.e2x];
      const allY = [v.s1y, v.e1y, v.s2y, v.e2y];
      let minX = Math.min(...allX), maxX = Math.max(...allX);
      let minY = Math.min(...allY), maxY = Math.max(...allY);
      const rX = (maxX - minX) || 100, rY = (maxY - minY) || 100;
      minX -= rX * 0.12; maxX += rX * 0.12;
      minY -= rY * 0.12; maxY += rY * 0.12;

      const scale = Math.min((W - 2*P) / (maxX - minX), (H - 2*P) / (maxY - minY));
      const oX = (W - (maxX - minX) * scale) / 2;
      const oY = (H - (maxY - minY) * scale) / 2;
      const toX = x => oX + (x - minX) * scale;
      const toY = y => H - oY - (y - minY) * scale;

      // Grid
      ctx.strokeStyle = '#e8ecef'; ctx.lineWidth = 1;
      const step = Math.pow(10, Math.floor(Math.log10(Math.max(rX, rY) / 4)));
      ctx.font = '10px system-ui'; ctx.fillStyle = '#95a5a6';
      for (let x = Math.ceil(minX/step)*step; x <= maxX; x += step) {
        ctx.beginPath(); ctx.moveTo(toX(x), P-15); ctx.lineTo(toX(x), H-P+15); ctx.stroke();
        ctx.fillText(x.toFixed(0), toX(x)-8, H-P+28);
      }
      for (let y = Math.ceil(minY/step)*step; y <= maxY; y += step) {
        ctx.beginPath(); ctx.moveTo(P-15, toY(y)); ctx.lineTo(W-P+15, toY(y)); ctx.stroke();
        ctx.fillText(y.toFixed(0), P-35, toY(y)+3);
      }

      // Axes
      ctx.strokeStyle = '#bdc3c7'; ctx.lineWidth = 1.5;
      if (minY <= 0 && maxY >= 0) { ctx.beginPath(); ctx.moveTo(P-15, toY(0)); ctx.lineTo(W-P+15, toY(0)); ctx.stroke(); }
      if (minX <= 0 && maxX >= 0) { ctx.beginPath(); ctx.moveTo(toX(0), P-15); ctx.lineTo(toX(0), H-P+15); ctx.stroke(); }

      // Distance line
      if (results.dist) {
        const {mid1x, mid1y, dist} = results.dist;
        const mid2x = (v.s2x + v.e2x) / 2, mid2y = (v.s2y + v.e2y) / 2;
        ctx.strokeStyle = '#9b59b6'; ctx.lineWidth = 2; ctx.setLineDash([5,5]);
        ctx.beginPath(); ctx.moveTo(toX(mid1x), toY(mid1y)); ctx.lineTo(toX(mid2x), toY(mid2y)); ctx.stroke();
        ctx.setLineDash([]);
        const mx = (toX(mid1x) + toX(mid2x)) / 2, my = (toY(mid1y) + toY(mid2y)) / 2;
        ctx.fillStyle = '#9b59b6'; ctx.font = 'bold 10px system-ui';
        ctx.fillText(`${dist.toFixed(1)}`, mx + 5, my - 5);
      }

      // Arrow function
      const drawArrow = (fx, fy, tx, ty, color) => {
        const angle = Math.atan2(ty - fy, tx - fx);
        ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 4; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(fx, fy); ctx.lineTo(tx, ty); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(tx, ty);
        ctx.lineTo(tx - 12*Math.cos(angle - Math.PI/6), ty - 12*Math.sin(angle - Math.PI/6));
        ctx.lineTo(tx - 12*Math.cos(angle + Math.PI/6), ty - 12*Math.sin(angle + Math.PI/6));
        ctx.closePath(); ctx.fill();
      };

      drawArrow(toX(v.s1x), toY(v.s1y), toX(v.e1x), toY(v.e1y), '#e74c3c');
      drawArrow(toX(v.s2x), toY(v.s2y), toX(v.e2x), toY(v.e2y), '#27ae60');

      // Points
      const drawPt = (x, y, color, label) => {
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(toX(x), toY(y), 7, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = color; ctx.beginPath(); ctx.arc(toX(x), toY(y), 5, 0, Math.PI*2); ctx.fill();
        ctx.font = 'bold 10px system-ui'; ctx.fillStyle = '#2c3e50';
        ctx.fillText(label, toX(x) + 8, toY(y) - 8);
      };

      drawPt(v.s1x, v.s1y, '#e74c3c', 'S1');
      drawPt(v.e1x, v.e1y, '#e74c3c', 'E1');
      drawPt(v.s2x, v.s2y, '#27ae60', 'S2');
      drawPt(v.e2x, v.e2y, '#27ae60', 'E2');

      // Cross point
      if (results.cross) {
        const denom = (v.s1x - v.e1x) * (v.s2y - v.e2y) - (v.s1y - v.e1y) * (v.s2x - v.e2x);
        if (Math.abs(denom) > 0.0001) {
          const t = ((v.s1x - v.s2x) * (v.s2y - v.e2y) - (v.s1y - v.s2y) * (v.s2x - v.e2x)) / denom;
          const ix = v.s1x + t * (v.e1x - v.s1x), iy = v.s1y + t * (v.e1y - v.s1y);
          ctx.strokeStyle = '#c0392b'; ctx.lineWidth = 3;
          const s = 14;
          ctx.beginPath(); ctx.moveTo(toX(ix)-s, toY(iy)-s); ctx.lineTo(toX(ix)+s, toY(iy)+s); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(toX(ix)+s, toY(iy)-s); ctx.lineTo(toX(ix)-s, toY(iy)+s); ctx.stroke();
          ctx.beginPath(); ctx.arc(toX(ix), toY(iy), s+4, 0, Math.PI*2); ctx.stroke();
        }
      }

      // Length labels
      const drawLen = (sx, sy, ex, ey, len, color) => {
        const mx = (toX(sx) + toX(ex)) / 2, my = (toY(sy) + toY(ey)) / 2;
        ctx.fillStyle = color; ctx.font = 'bold 10px system-ui';
        const tw = ctx.measureText(`L=${len.toFixed(1)}`).width;
        ctx.fillRect(mx - tw/2 - 3, my - 7, tw + 6, 14);
        ctx.fillStyle = '#fff';
        ctx.fillText(`L=${len.toFixed(1)}`, mx - tw/2, my + 3);
      };

      drawLen(v.s1x, v.s1y, v.e1x, v.e1y, results.len.len1, '#e74c3c');
      drawLen(v.s2x, v.s2y, v.e2x, v.e2y, results.len.len2, '#27ae60');

      // Warnings
      let wy = P - 30;
      ctx.font = 'bold 12px system-ui';
      if (!results.dir) { ctx.fillStyle = '#e74c3c'; ctx.fillText('âš  ë°©í–¥ ì—­ì „', P, wy); wy += 16; }
      if (!results.len.ok) { ctx.fillStyle = '#e67e22'; ctx.fillText(`âš  ê¸¸ì´ ì°¨ì´ ${results.len.diff.toFixed(1)}mm`, P, wy); wy += 16; }
      if (!results.angle.ok) { ctx.fillStyle = '#8e44ad'; ctx.fillText(`âš  ê°ë„ ì°¨ì´ ${results.angle.diff.toFixed(1)}Â°`, P, wy); wy += 16; }
      if (!results.dist.ok) { ctx.fillStyle = '#9b59b6'; ctx.fillText(`âš  ê±°ë¦¬ ${results.dist.dist.toFixed(1)}mm`, P, wy); wy += 16; }
      if (!results.startOff.ok) { ctx.fillStyle = '#1abc9c'; ctx.fillText(`âš  ì‹œì‘ì  ë³€ìœ„ ${results.startOff.dist.toFixed(1)}mm`, P, wy); wy += 16; }
      if (!results.endOff.ok) { ctx.fillStyle = '#f39c12'; ctx.fillText(`âš  ëì  ë³€ìœ„ ${results.endOff.dist.toFixed(1)}mm`, P, wy); }

      ctx.fillStyle = '#7f8c8d'; ctx.font = 'bold 11px system-ui';
      ctx.fillText('X', W - P + 10, toY(0) - 5);
      ctx.fillText('Y', toX(0) + 6, P - 18);
    }

    function showCode(type) {
      document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      const codes = {
        full: csharpCodeFull,
        cross: csharpCodeCross,
        dir: csharpCodeDir,
        len: csharpCodeLen,
        angle: csharpCodeAngle,
        dist: csharpCodeDist,
        startOff: csharpCodeStartOff,
        endOff: csharpCodeEndOff
      };
      document.getElementById('code-content').innerHTML = codes[type];
    }

    document.addEventListener('DOMContentLoaded', () => {
      showCode('full');
      runValidation();
    });

    window.addEventListener('resize', runValidation);

    // === ëª¨ë“œ ì „í™˜ ===
    function toggleMode(mode) {
      const manual = document.getElementById('manualSection');
      const mainArea = document.querySelector('.main-area');
      const batch = document.getElementById('batchSection');
      const codeSection = document.querySelector('.code-section');
      const btnManual = document.getElementById('modeManual');
      const btnBatch = document.getElementById('modeBatch');

      if (mode === 'batch') {
        manual.style.display = 'none';
        mainArea.style.display = 'none';
        codeSection.style.display = 'none';
        batch.classList.add('visible');
        btnManual.classList.remove('active');
        btnBatch.classList.add('active');
      } else {
        manual.style.display = 'block';
        mainArea.style.display = 'grid';
        codeSection.style.display = 'block';
        batch.classList.remove('visible');
        btnManual.classList.add('active');
        btnBatch.classList.remove('active');
      }
    }

    // === ë¡œê·¸ íŒŒì‹± ===
    function parseLogs() {
      const logText = document.getElementById('logInput').value;
      const lines = logText.split('\n');
      const weldLinePairs = [];

      // RequestWeldingOperationStart ë¡œê·¸ì—ì„œ JSON ì¶”ì¶œ
      for (const line of lines) {
        if (line.includes('RequestWeldingOperationStart') && line.includes('ENTERED')) {
          const jsonStart = line.indexOf('{');
          if (jsonStart === -1) continue;

          try {
            const jsonStr = line.substring(jsonStart);
            const data = JSON.parse(jsonStr);

            if (data.weldJobs && Array.isArray(data.weldJobs)) {
              // Robot 1, 2 ìŒ ì°¾ê¸°
              const robot1 = data.weldJobs.find(j => j.targetRobotId === 1);
              const robot2 = data.weldJobs.find(j => j.targetRobotId === 2);

              if (robot1 && robot2 && robot1.weldLine && robot2.weldLine) {
                weldLinePairs.push({
                  weldLineId: robot1.weldLine.weldLineId,
                  gantryId: robot1.weldLine.gantryId,
                  macroNumber: robot1.weldLine.macroNumber,
                  line1: {
                    start: robot1.weldLine.startPointPosition,
                    end: robot1.weldLine.endPointPosition,
                    length: robot1.weldLine.length
                  },
                  line2: {
                    start: robot2.weldLine.startPointPosition,
                    end: robot2.weldLine.endPointPosition,
                    length: robot2.weldLine.length
                  }
                });
              }
            }
          } catch (e) {
            console.warn('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
          }
        }
      }

      document.getElementById('parseInfo').textContent = `${weldLinePairs.length}ê°œ ìš©ì ‘ì„  ìŒ ì¶”ì¶œ`;

      if (weldLinePairs.length === 0) {
        document.getElementById('batchResults').innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--muted);">
            ìš©ì ‘ì„  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
            RequestWeldingOperationStart ë¡œê·¸ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
          </div>
        `;
        return;
      }

      // ì¼ê´„ ê²€ì¦ ì‹¤í–‰
      runBatchValidation(weldLinePairs);
    }

    function runBatchValidation(pairs) {
      const lenThreshold = parseFloat(document.getElementById('batchLenThreshold').value) || 20;
      const angleThreshold = parseFloat(document.getElementById('batchAngleThreshold').value) || 5;
      const distThreshold = parseFloat(document.getElementById('batchDistThreshold').value) || 20;
      const offsetThreshold = parseFloat(document.getElementById('batchOffsetThreshold').value) || 20;

      const results = pairs.map(pair => {
        const l1 = pair.line1, l2 = pair.line2;
        const s1x = l1.start.x, s1y = l1.start.y;
        const e1x = l1.end.x, e1y = l1.end.y;
        const s2x = l2.start.x, s2y = l2.start.y;
        const e2x = l2.end.x, e2y = l2.end.y;

        const cross = checkCrossing(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y);
        const dir = checkDirection(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y);
        const len = checkLength(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y, lenThreshold);
        const angle = checkAngle(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y, angleThreshold);
        const dist = checkDistance(s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y, distThreshold);
        const startOff = checkStartOffset(s1x, s1y, s2x, s2y, offsetThreshold);
        const endOff = checkEndOffset(e1x, e1y, e2x, e2y, offsetThreshold);

        const crossOK = !cross, dirOK = dir, lenOK = len.ok, angleOK = angle.ok;
        const distOK = dist.ok, startOffOK = startOff.ok, endOffOK = endOff.ok;
        const allOK = crossOK && dirOK && lenOK && angleOK && distOK && startOffOK && endOffOK;

        return {
          ...pair,
          coords: { s1x, s1y, e1x, e1y, s2x, s2y, e2x, e2y },
          crossOK, dirOK, lenOK, angleOK, distOK, startOffOK, endOffOK, allOK,
          lenDiff: len.diff,
          angleDiff: angle.diff,
          distVal: dist.dist,
          startOffDist: startOff.dist,
          endOffDist: endOff.dist,
          len1: len.len1,
          len2: len.len2
        };
      });

      renderBatchResults(results);
    }

    function renderBatchResults(results) {
      const passCount = results.filter(r => r.allOK).length;
      const failCount = results.length - passCount;

      let html = `
        <table class="batch-table">
          <thead>
            <tr>
              <th>#</th>
              <th>WeldLine ID</th>
              <th>Gantry</th>
              <th>êµì°¨</th>
              <th>ë°©í–¥</th>
              <th>ê¸¸ì´ (mm)</th>
              <th>ê°ë„ (Â°)</th>
              <th>ê±°ë¦¬ (mm)</th>
              <th>ì‹œì‘ì  (mm)</th>
              <th>ëì  (mm)</th>
              <th>ê²°ê³¼</th>
            </tr>
          </thead>
          <tbody>
      `;

      results.forEach((r, idx) => {
        const rowClass = r.allOK ? 'row-pass' : 'row-fail';
        html += `
          <tr class="${rowClass} clickable-row" onclick="loadWeldLine(${idx})" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°">
            <td>${idx + 1}</td>
            <td><strong>${r.weldLineId}</strong></td>
            <td>G${r.gantryId}</td>
            <td class="${r.crossOK ? 'pass' : 'fail'}">${r.crossOK ? 'âœ“' : 'âœ—'}</td>
            <td class="${r.dirOK ? 'pass' : 'fail'}">${r.dirOK ? 'âœ“' : 'âœ—'}</td>
            <td class="${r.lenOK ? 'pass' : 'fail'}">${r.lenDiff.toFixed(1)}</td>
            <td class="${r.angleOK ? 'pass' : 'fail'}">${r.angleDiff.toFixed(2)}</td>
            <td class="${r.distOK ? 'pass' : 'fail'}">${r.distVal.toFixed(1)}</td>
            <td class="${r.startOffOK ? 'pass' : 'fail'}">${r.startOffDist.toFixed(1)}</td>
            <td class="${r.endOffOK ? 'pass' : 'fail'}">${r.endOffDist.toFixed(1)}</td>
            <td class="${r.allOK ? 'pass' : 'fail'}"><strong>${r.allOK ? 'PASS' : 'FAIL'}</strong></td>
          </tr>
        `;
      });

      html += `</tbody></table>`;

      html += `
        <div class="batch-summary ${failCount === 0 ? 'all-pass' : 'has-fail'}">
          ${failCount === 0
            ? `âœ… ì „ì²´ ${results.length}ê°œ ìš©ì ‘ì„  ëª¨ë‘ PASS`
            : `âŒ ${results.length}ê°œ ì¤‘ ${failCount}ê°œ FAIL (${passCount}ê°œ PASS)`
          }
        </div>
      `;

      document.getElementById('batchResults').innerHTML = html;

      // ì „ì—­ì— ê²°ê³¼ ì €ì¥ (í–‰ í´ë¦­ ì‹œ ì‚¬ìš©)
      window.batchValidationResults = results;
    }

    function loadWeldLine(idx) {
      const r = window.batchValidationResults[idx];
      if (!r) return;

      // ìˆ˜ë™ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
      toggleMode('manual');

      // ì¢Œí‘œ ì„¤ì •
      setInputValues({
        s1x: r.coords.s1x.toFixed(2),
        s1y: r.coords.s1y.toFixed(2),
        s1z: r.line1.start.z?.toFixed(2) || 0,
        e1x: r.coords.e1x.toFixed(2),
        e1y: r.coords.e1y.toFixed(2),
        e1z: r.line1.end.z?.toFixed(2) || 0,
        s2x: r.coords.s2x.toFixed(2),
        s2y: r.coords.s2y.toFixed(2),
        s2z: r.line2.start.z?.toFixed(2) || 0,
        e2x: r.coords.e2x.toFixed(2),
        e2y: r.coords.e2y.toFixed(2),
        e2z: r.line2.end.z?.toFixed(2) || 0
      });

      // ê²€ì‚¬ ì‹¤í–‰
      runValidation();
    }

    function clearLogs() {
      document.getElementById('logInput').value = '';
      document.getElementById('batchResults').innerHTML = '';
      document.getElementById('parseInfo').textContent = '';
    }
  </script>
</body>
</html>
