<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ë¡ ì¼ê´„ ê´€ë¦¬ - S25016 ê·¼ë¬´ê´€ë¦¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .section h2 { font-size: 24px; margin-bottom: 20px; color: #333; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }
        .table-wrapper { overflow-x: auto; }
        .records-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .records-table th, .records-table td { padding: 12px 10px; border: 1px solid #e0e0e0; text-align: center; font-size: 14px; }
        .records-table thead { background: #f8f9fa; }
        .records-table th { font-weight: 600; color: #666; }
        .records-table tbody tr:hover { background: #f1f3f5; }
        .records-table input, .records-table select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: transparent; }
        .records-table input:focus, .records-table select:focus { background: white; outline: 2px solid #667eea; }
        .records-table .action-cell { width: 50px; }
        .back-link { text-align: center; margin-top: 30px; }
        .back-link a { color: #667eea; text-decoration: none; font-size: 16px; font-weight: 600; }
        .status-message { padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .status-message.success { background: #d4edda; color: #155724; }
        .status-message.error { background: #f8d7da; color: #721c24; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .toolbar .actions { display: flex; gap: 10px; }

        /* ì •ë ¬ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
        .sortable { cursor: pointer; user-select: none; position: relative; }
        .sortable:hover { background: #e9ecef; }
        .sort-icon { display: inline-block; margin-left: 5px; font-size: 12px; opacity: 0.3; }
        .sort-icon.active { opacity: 1; color: #667eea; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ê¸°ë¡ ì¼ê´„ ê´€ë¦¬</h1>
            <p>ì—¬ëŸ¬ ì¶œì… ê¸°ë¡ì„ í•œ ë²ˆì— ë“±ë¡, ìˆ˜ì •, ì‚­ì œí•©ë‹ˆë‹¤.</p>
        </div>

        <!-- ì¼ê´„ ë“±ë¡ ì„¹ì…˜ -->
        <div class="section">
            <h2>ğŸ“ ì‹ ê·œ ê¸°ë¡ ì¼ê´„ ë“±ë¡</h2>
            <div class="toolbar">
                <div>
                    <button class="btn btn-secondary" onclick="addBulkRecordRow()">â• í–‰ ì¶”ê°€</button>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="saveBulkRecords()">ğŸ’¾ ì¼ê´„ ì €ì¥</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="records-table" id="bulkAddTable">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ì¸ì›</th>
                            <th>ìœ„ì¹˜</th>
                            <th>ì…ì‹¤</th>
                            <th>í‡´ì‹¤</th>
                            <th>ì‘ì—…ë‚´ìš©</th>
                            <th>ë¹„ê³ </th>
                            <th class="action-cell">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- í–‰ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ê¸°ì¡´ ê¸°ë¡ ìˆ˜ì •/ì‚­ì œ ì„¹ì…˜ -->
        <div class="section">
            <h2>âœï¸ ê¸°ì¡´ ê¸°ë¡ ìˆ˜ì • ë° ì‚­ì œ</h2>
            <div class="toolbar">
                <div>
                    <button class="btn btn-secondary" onclick="loadAllRecords()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="actions">
                    <button class="btn btn-danger" onclick="deleteSelectedRecords()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
                    <button class="btn btn-primary" onclick="updateAllRecords()">ğŸ’¾ ëª¨ë“  ë³€ê²½ì‚¬í•­ ì €ì¥</button>
                </div>
            </div>
            <div id="statusMessage" class="status-message"></div>
            <div class="table-wrapper">
                <table class="records-table" id="bulkEditTable">
                    <thead>
                        <tr>
                            <th class="action-cell"><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>
                            <th class="sortable" onclick="sortRecords('ë‚ ì§œ')">ë‚ ì§œ <span class="sort-icon"></span></th>
                            <th class="sortable" onclick="sortRecords('ì¸ì›')">ì¸ì› <span class="sort-icon"></span></th>
                            <th class="sortable" onclick="sortRecords('ìœ„ì¹˜')">ìœ„ì¹˜ <span class="sort-icon"></span></th>
                            <th class="sortable" onclick="sortRecords('ì…ì‹¤ì‹œê°„')">ì…ì‹¤ <span class="sort-icon"></span></th>
                            <th class="sortable" onclick="sortRecords('í‡´ì‹¤ì‹œê°„')">í‡´ì‹¤ <span class="sort-icon"></span></th>
                            <th>ì‘ì—…ë‚´ìš©</th>
                            <th>ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="back-link">
            <a href="../index.html">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>

    <script>
        // ==================================================================
        // ì´ˆê¸° ì„¤ì • ë° ë°ì´í„° ë¡œë“œ
        // ==================================================================
        const SCRIPT_URL = '/api/work-records';
        let employees = [];
        let locations = [];
        let allRecords = []; // ì „ì²´ ê¸°ë¡ ì €ì¥
        let sortColumn = null; // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼
        let sortDirection = 'asc'; // ì •ë ¬ ë°©í–¥ ('asc' ë˜ëŠ” 'desc')

        document.addEventListener('DOMContentLoaded', async () => {
            [employees, locations] = await Promise.all([
                fetchDataFromSheet('getEmployees', ['ì‹¬íƒœì–‘', 'ê¹€ì² ìˆ˜']),
                fetchDataFromSheet('getLocations', ['34bay Aë¼ì¸', 'ì‚¬ë¬´ì‹¤'])
            ]);

            addBulkRecordRow(); // ì¼ê´„ ë“±ë¡ í…Œì´ë¸”ì— ê¸°ë³¸ í•œ í–‰ ì¶”ê°€
            loadAllRecords(); // ê¸°ì¡´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        });

        async function fetchDataFromSheet(action, fallback) {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                const data = await response.json();
                if (data.error) {
                    console.warn(`Sheet '${action}' ë¡œë“œ ì‹¤íŒ¨, fallback ì‚¬ìš©:`, data.error);
                    return data.fallback || fallback;
                }
                return data;
            } catch (error) {
                console.error(`${action} ë¡œë“œ ì‹¤íŒ¨:`, error);
                return fallback;
            }
        }

        // ==================================================================
        // ì¼ê´„ ë“±ë¡ ê´€ë ¨ í•¨ìˆ˜
        // ==================================================================
        function addBulkRecordRow() {
            const tbody = document.getElementById('bulkAddTable').querySelector('tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="date" value="${new Date().toISOString().split('T')[0]}"></td>
                <td>${createSelectHTML(employees)}</td>
                <td>${createSelectHTML(locations)}</td>
                <td><input type="time"></td>
                <td><input type="time"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td class="action-cell"><button onclick="this.closest('tr').remove()">âŒ</button></td>
            `;
        }

        async function saveBulkRecords() {
            const tbody = document.getElementById('bulkAddTable').querySelector('tbody');
            const rows = Array.from(tbody.rows);
            const recordsToSave = rows.map(row => {
                const cells = row.cells;
                return {
                    date: cells[0].querySelector('input').value,
                    name: cells[1].querySelector('select').value,
                    location: cells[2].querySelector('select').value,
                    checkIn: cells[3].querySelector('input').value || '-',
                    checkOut: cells[4].querySelector('input').value || '-',
                    workType: cells[5].querySelector('input').value || '-',
                    notes: cells[6].querySelector('input').value || '-',
                    timestamp: new Date().toISOString()
                };
            }).filter(r => r.date && r.name && r.location && (r.checkIn !== '-' || r.checkOut !== '-'));

            if (recordsToSave.length === 0) {
                alert('ì €ì¥í•  ìœ íš¨í•œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm(`${recordsToSave.length}ê°œì˜ ê¸°ë¡ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const response = await fetch(`${SCRIPT_URL}?action=bulkCreate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recordsToSave)
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Unknown error');

                alert(`âœ… ${result.message || 'ì¼ê´„ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'}`);
                tbody.innerHTML = ''; // í…Œì´ë¸” ë¹„ìš°ê¸°
                addBulkRecordRow(); // ìƒˆ í–‰ ì¶”ê°€
                loadAllRecords(); // ì•„ë˜ í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                alert(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ==================================================================
        // ê¸°ì¡´ ê¸°ë¡ ìˆ˜ì •/ì‚­ì œ ê´€ë ¨ í•¨ìˆ˜
        // ==================================================================
        async function loadAllRecords() {
            const tbody = document.getElementById('bulkEditTable').querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="8">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

            try {
                const response = await fetch(`${SCRIPT_URL}?action=getAllRecords`);
                const records = await response.json();
                if (records.error) throw new Error(records.error);

                const enrichedRecords = records.map((record, index) => {
                    if (!record.rowNumber) {
                        record.rowNumber = index + 2;
                    }
                    if (!record.timestamp && record['íƒ€ì„ìŠ¤íƒ¬í”„']) {
                        record.timestamp = record['íƒ€ì„ìŠ¤íƒ¬í”„'];
                    }
                    return record;
                });

                allRecords = enrichedRecords.sort((a, b) => (b.rowNumber || 0) - (a.rowNumber || 0));
                sortColumn = null; // ì •ë ¬ ì´ˆê¸°í™”
                sortDirection = 'asc';
                renderRecords();

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" style="color: red;">ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</td></tr>`;
            }
        }

        function renderRecords() {
            const tbody = document.getElementById('bulkEditTable').querySelector('tbody');

            if (allRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">í‘œì‹œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = allRecords.map(record => `
                <tr data-row-number="${record.rowNumber}" data-timestamp="${record.timestamp || record['íƒ€ì„ìŠ¤íƒ¬í”„'] || ''}">
                    <td class="action-cell"><input type="checkbox"></td>
                    <td><input type="date" value="${record['ë‚ ì§œ'] || ''}"></td>
                    <td>${createSelectHTML(employees, record['ì¸ì›'])}</td>
                    <td>${createSelectHTML(locations, record['ìœ„ì¹˜'])}</td>
                    <td><input type="time" value="${record['ì…ì‹¤ì‹œê°„'] === '-' ? '' : record['ì…ì‹¤ì‹œê°„']}"></td>
                    <td><input type="time" value="${record['í‡´ì‹¤ì‹œê°„'] === '-' ? '' : record['í‡´ì‹¤ì‹œê°„']}"></td>
                    <td><input type="text" value="${record['ì‘ì—…ë‚´ìš©'] === '-' ? '' : record['ì‘ì—…ë‚´ìš©']}"></td>
                    <td><input type="text" value="${record['ë¹„ê³ '] === '-' ? '' : record['ë¹„ê³ ']}"></td>
                </tr>
            `).join('');

            updateSortIcons();
        }

        function sortRecords(column) {
            // ê°™ì€ ì»¬ëŸ¼ í´ë¦­ ì‹œ ë°©í–¥ í† ê¸€, ë‹¤ë¥¸ ì»¬ëŸ¼ í´ë¦­ ì‹œ ì˜¤ë¦„ì°¨ìˆœ
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // ë°ì´í„° ì •ë ¬
            allRecords.sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';

                // ë‚ ì§œ/ì‹œê°„ ë¹„êµ
                if (column === 'ë‚ ì§œ' || column === 'ì…ì‹¤ì‹œê°„' || column === 'í‡´ì‹¤ì‹œê°„') {
                    valA = valA === '-' ? '' : valA;
                    valB = valB === '-' ? '' : valB;
                    if (sortDirection === 'asc') {
                        return valA.localeCompare(valB);
                    } else {
                        return valB.localeCompare(valA);
                    }
                }

                // ë¬¸ìì—´ ë¹„êµ (ì¸ì›, ìœ„ì¹˜)
                if (sortDirection === 'asc') {
                    return String(valA).localeCompare(String(valB), 'ko');
                } else {
                    return String(valB).localeCompare(String(valA), 'ko');
                }
            });

            renderRecords();
        }

        function updateSortIcons() {
            // ëª¨ë“  ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = '';
                icon.classList.remove('active');
            });

            // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ì˜ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            if (sortColumn) {
                const headers = {
                    'ë‚ ì§œ': 0,
                    'ì¸ì›': 1,
                    'ìœ„ì¹˜': 2,
                    'ì…ì‹¤ì‹œê°„': 3,
                    'í‡´ì‹¤ì‹œê°„': 4
                };
                const headerIndex = headers[sortColumn];
                if (headerIndex !== undefined) {
                    const th = document.querySelectorAll('#bulkEditTable th.sortable')[headerIndex];
                    const icon = th.querySelector('.sort-icon');
                    icon.classList.add('active');
                    icon.textContent = sortDirection === 'asc' ? 'â–²' : 'â–¼';
                }
            }
        }

        async function updateAllRecords() {
            const rows = document.querySelectorAll('#bulkEditTable tbody tr');
            const recordsToUpdate = Array.from(rows).map(row => {
                const cells = row.cells;
                return {
                    rowNumber: row.dataset.rowNumber,
                    timestamp: row.dataset.timestamp || '',
                    date: cells[1].querySelector('input').value,
                    name: cells[2].querySelector('select').value,
                    location: cells[3].querySelector('select').value,
                    checkIn: cells[4].querySelector('input').value || '-',
                    checkOut: cells[5].querySelector('input').value || '-',
                    workType: cells[6].querySelector('input').value || '-',
                    notes: cells[7].querySelector('input').value || '-',
                };
            });

            if (recordsToUpdate.length === 0) {
                alert('ìˆ˜ì •í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

            showStatus('ì €ì¥ ì¤‘...', 'info');

            try {
                const response = await fetch(`${SCRIPT_URL}?action=bulkUpdate`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recordsToUpdate)
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                showStatus('âœ… ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadAllRecords();
            } catch (error) {
                showStatus(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function deleteSelectedRecords() {
            const selectedRows = Array.from(document.querySelectorAll('#bulkEditTable tbody input[type="checkbox"]:checked'))
                .map(cb => cb.closest('tr'));
            
            if (selectedRows.length === 0) {
                alert('ì‚­ì œí•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!confirm(`${selectedRows.length}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

            const recordsToDelete = selectedRows.map(row => ({
                rowNumber: row.dataset.rowNumber,
                timestamp: row.dataset.timestamp
            }));

            showStatus('ì‚­ì œ ì¤‘...', 'info');

            try {
                const response = await fetch(`${SCRIPT_URL}?action=bulkDelete`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recordsToDelete)
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                showStatus('âœ… ì„ íƒí•œ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadAllRecords();
            } catch (error) {
                showStatus(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ==================================================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ==================================================================
        function createSelectHTML(options, selectedValue) {
            return `
                <select>
                    ${options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            `;
        }

        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('#bulkEditTable tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }

    </script>
</body>
</html>
