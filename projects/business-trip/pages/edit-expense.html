<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§€ì¶œê²°ì˜ì„œ ìˆ˜ì • | S25016</title>
  <link rel="stylesheet" href="../../../shared/styles/variables.css">
  <link rel="stylesheet" href="../../../shared/styles/reset.css">
  <style>
    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #10b981;
      color: white;
    }

    .btn-primary:hover {
      background: #059669;
    }

    .btn-secondary {
      background: white;
      color: #667eea;
    }

    .btn-secondary:hover {
      background: #f3f4f6;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .expense-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }

    .expense-table th,
    .expense-table td {
      border: 1px solid #d1d5db;
      padding: 8px;
      text-align: center;
    }

    .expense-table th {
      background: #f3f4f6;
      font-weight: 600;
      color: #374151;
      font-size: 13px;
    }

    .expense-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
      text-align: right;
    }

    .expense-table input.note-input {
      text-align: left;
    }

    .expense-table .date-col {
      background: #fef9e7;
      font-weight: 600;
      width: 100px;
    }

    .expense-table .total-row {
      background: #dbeafe;
      font-weight: 700;
      color: #1e40af;
    }

    .expense-table .total-row td {
      font-size: 14px;
      padding: 12px;
    }

    .add-row-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .add-row-btn:hover {
      background: #5568d3;
    }

    .totals-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .total-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .total-card.grand {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      grid-column: 1 / -1;
    }

    .total-card .label {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .total-card .value {
      font-size: 24px;
      font-weight: 700;
    }

    .info-box {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .info-box h4 {
      margin: 0 0 8px 0;
      color: #1e40af;
      font-size: 14px;
    }

    .info-box p {
      margin: 0;
      color: #1e3a8a;
      font-size: 13px;
      line-height: 1.6;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ ì§€ì¶œê²°ì˜ì„œ ìˆ˜ì •</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.history.back()">â† ëŒì•„ê°€ê¸°</button>
        <button class="btn btn-primary" onclick="saveExpense()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>

    <div class="content" id="content">
      <div class="loading">ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <script src="/projects/business-trip/scripts/expense.js"></script>
  <script src="/projects/business-trip/scripts/business-trip.js"></script>
  <script>
    let expenseData = null;
    let dailyExpenses = [];

    // URLì—ì„œ id ì¶”ì¶œ
    const urlParams = new URLSearchParams(window.location.search);
    const expenseId = urlParams.get('id');

    // í˜ì´ì§€ ì´ˆê¸°í™”
    async function init() {
      try {
        if (!expenseId) {
          alert('ì§€ì¶œê²°ì˜ì„œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
          window.location.href = 'expense-list.html';
          return;
        }

        // ê¸°ì¡´ ì§€ì¶œê²°ì˜ì„œ ë°ì´í„° ë¡œë“œ
        expenseData = await getExpenseById(expenseId);

        // ì¼ë³„ ì§€ì¶œ ë‚´ì—­ íŒŒì‹±
        dailyExpenses = parseExpenseDetail(expenseData.expenseDetail);

        if (dailyExpenses.length === 0) {
          dailyExpenses = [createEmptyRow()];
        }

        renderForm();
      } catch (error) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ë¹ˆ í–‰ ìƒì„±
    function createEmptyRow() {
      return {
        date: new Date().toISOString().split('T')[0],
        toll: 0,
        fuel: 0,
        allowance: 0,
        meal: 0,
        note: ''
      };
    }

    // í¼ ë Œë”ë§
    function renderForm() {
      const content = document.getElementById('content');

      content.innerHTML = `
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="section">
          <div class="section-title">ğŸ“Œ ê¸°ë³¸ ì •ë³´</div>

          <div class="form-grid">
            <div class="form-group">
              <label>ì œëª© *</label>
              <input type="text" id="title" value="${expenseData.title || ''}" required>
            </div>
            <div class="form-group">
              <label>ë¬¸ì„œë²ˆí˜¸</label>
              <input type="text" id="documentNumber" value="${expenseData.documentNumber || ''}" readonly>
            </div>
            <div class="form-group">
              <label>ì‹ ì²­ë²ˆí˜¸</label>
              <input type="text" id="requestNumber" value="${expenseData.requestNumber || ''}" readonly>
            </div>
            <div class="form-group">
              <label>ê¸°ì•ˆì¼ *</label>
              <input type="date" id="draftDate" value="${expenseData.draftDate || ''}" required>
            </div>
            <div class="form-group">
              <label>ê¸°ì•ˆì *</label>
              <select id="drafter" required>
                <option value="">ì„ íƒ</option>
                <option value="ì‹¬íƒœì–‘" ${expenseData.drafter === 'ì‹¬íƒœì–‘' ? 'selected' : ''}>ì‹¬íƒœì–‘</option>
                <option value="ì´ê´‘ì¬" ${expenseData.drafter === 'ì´ê´‘ì¬' ? 'selected' : ''}>ì´ê´‘ì¬</option>
                <option value="ê¹€ë‚˜ë˜" ${expenseData.drafter === 'ê¹€ë‚˜ë˜' ? 'selected' : ''}>ê¹€ë‚˜ë˜</option>
                <option value="ë³€ì¬íƒœ" ${expenseData.drafter === 'ë³€ì¬íƒœ' ? 'selected' : ''}>ë³€ì¬íƒœ</option>
              </select>
            </div>
            <div class="form-group">
              <label>ìƒíƒœ</label>
              <select id="status">
                <option value="ì‘ì„±ì¤‘" ${expenseData.status === 'ì‘ì„±ì¤‘' ? 'selected' : ''}>ğŸŸ¡ ì‘ì„±ì¤‘</option>
                <option value="ì œì¶œ" ${expenseData.status === 'ì œì¶œ' ? 'selected' : ''}>ğŸ”µ ì œì¶œ</option>
                <option value="ìŠ¹ì¸" ${expenseData.status === 'ìŠ¹ì¸' ? 'selected' : ''}>ğŸŸ¢ ìŠ¹ì¸</option>
                <option value="ë°˜ë ¤" ${expenseData.status === 'ë°˜ë ¤' ? 'selected' : ''}>ğŸ”´ ë°˜ë ¤</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ìœ ë¥˜ë¹„ ê³„ì‚° ì •ë³´ -->
        <div class="section">
          <div class="section-title">â›½ ìœ ë¥˜ë¹„ ê³„ì‚° ì •ë³´</div>
          <div class="form-grid">
            <div class="form-group">
              <label>ìœ ë¥˜ë‹¨ê°€ (ì›/ë¦¬í„°) *</label>
              <input type="number" id="fuelPrice" value="${expenseData.fuelPrice || 1619.10}" step="0.01" required>
            </div>
            <div class="form-group">
              <label>ì—°ë¹„ (km/ë¦¬í„°)</label>
              <input type="number" id="fuelEfficiency" value="${expenseData.fuelEfficiency || 9}" step="0.1">
            </div>
            <div class="form-group">
              <label>ìœ ë¥˜ë‹¨ê°€ ì¶œì²˜</label>
              <input type="text" id="fuelPriceSource" value="${expenseData.fuelPriceSource || 'ì˜¤í”¼ë„· ì „êµ­ ê²½ìœ  í‰ê· '}" placeholder="ì˜ˆ: ì˜¤í”¼ë„· ì „êµ­ í‰ê· ">
            </div>
          </div>
        </div>

        <!-- ì¼ë³„ ì§€ì¶œ ë‚´ì—­ -->
        <div class="section">
          <div class="section-title">ğŸ’° ì¼ë³„ ì§€ì¶œ ë‚´ì—­</div>
          <table class="expense-table" id="expenseTable">
            <thead>
              <tr>
                <th style="width: 100px;">ë‚ ì§œ</th>
                <th style="width: 120px;">êµí†µë¹„</th>
                <th style="width: 120px;">ìœ ë¥˜ë¹„</th>
                <th style="width: 120px;">ì¶œì¥ë¹„</th>
                <th style="width: 120px;">ì‹ëŒ€</th>
                <th>ë‚´ìš©</th>
                <th style="width: 50px;">ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody id="expenseTableBody">
            </tbody>
          </table>
          <button class="add-row-btn" onclick="addRow()">â• í–‰ ì¶”ê°€</button>
        </div>

        <!-- í•©ê³„ -->
        <div class="section">
          <div class="section-title">ğŸ“Š í•©ê³„</div>
          <div class="totals-display" id="totalsDisplay">
            <div class="total-card">
              <div class="label">ì´ êµí†µë¹„</div>
              <div class="value" id="totalToll">0ì›</div>
            </div>
            <div class="total-card">
              <div class="label">ì´ ìœ ë¥˜ë¹„</div>
              <div class="value" id="totalFuel">0ì›</div>
            </div>
            <div class="total-card">
              <div class="label">ì´ ì¶œì¥ë¹„</div>
              <div class="value" id="totalAllowance">0ì›</div>
            </div>
            <div class="total-card">
              <div class="label">ì´ ì‹ëŒ€</div>
              <div class="value" id="totalMeal">0ì›</div>
            </div>
            <div class="total-card grand">
              <div class="label">ì´ í•©ê³„</div>
              <div class="value" id="grandTotal">0ì›</div>
            </div>
          </div>
        </div>

        <!-- ë¹„ê³  -->
        <div class="section">
          <div class="section-title">ğŸ“ ë¹„ê³ </div>
          <div class="form-group">
            <textarea id="remarks" rows="4" placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì°¸ê³ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”">${expenseData.remarks || ''}</textarea>
          </div>
        </div>
      `;

      renderTable();
      calculateAndDisplayTotals();
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
      const tbody = document.getElementById('expenseTableBody');

      const rows = dailyExpenses.map((row, index) => {
        return `
          <tr>
            <td class="date-col">
              <input type="date" value="${row.date}" onchange="updateRow(${index}, 'date', this.value)">
            </td>
            <td><input type="number" value="${row.toll}" onchange="updateRow(${index}, 'toll', this.value)" placeholder="0"></td>
            <td><input type="number" value="${row.fuel}" onchange="updateRow(${index}, 'fuel', this.value)" placeholder="0"></td>
            <td><input type="number" value="${row.allowance}" onchange="updateRow(${index}, 'allowance', this.value)" placeholder="0"></td>
            <td><input type="number" value="${row.meal}" onchange="updateRow(${index}, 'meal', this.value)" placeholder="0"></td>
            <td><input type="text" class="note-input" value="${row.note}" onchange="updateRow(${index}, 'note', this.value)" placeholder="ë‚´ìš© ì…ë ¥"></td>
            <td><button onclick="deleteRow(${index})" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Ã—</button></td>
          </tr>
        `;
      }).join('');

      // í•©ê³„ í–‰
      const totals = calculateTotals(dailyExpenses);
      const totalRow = `
        <tr class="total-row">
          <td>í•©ê³„</td>
          <td>${formatNumber(totals.toll)}ì›</td>
          <td>${formatNumber(totals.fuel)}ì›</td>
          <td>${formatNumber(totals.allowance)}ì›</td>
          <td>${formatNumber(totals.meal)}ì›</td>
          <td colspan="2" style="text-align: right; padding-right: 20px;">ì´í•©ê³„: <strong style="font-size: 16px;">${formatNumber(totals.grand)}ì›</strong></td>
        </tr>
      `;

      tbody.innerHTML = rows + totalRow;
    }

    // í–‰ ì—…ë°ì´íŠ¸
    function updateRow(index, field, value) {
      if (field === 'toll' || field === 'fuel' || field === 'allowance' || field === 'meal') {
        dailyExpenses[index][field] = parseFloat(value) || 0;
      } else {
        dailyExpenses[index][field] = value;
      }

      renderTable();
      calculateAndDisplayTotals();
    }

    // í–‰ ì¶”ê°€
    function addRow() {
      dailyExpenses.push(createEmptyRow());
      renderTable();
    }

    // í–‰ ì‚­ì œ
    function deleteRow(index) {
      if (dailyExpenses.length <= 1) {
        alert('ìµœì†Œ 1ê°œ í–‰ì€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }
      dailyExpenses.splice(index, 1);
      renderTable();
      calculateAndDisplayTotals();
    }

    // í•©ê³„ ê³„ì‚° ë° í‘œì‹œ
    function calculateAndDisplayTotals() {
      const totals = calculateTotals(dailyExpenses);

      document.getElementById('totalToll').textContent = formatNumber(totals.toll) + 'ì›';
      document.getElementById('totalFuel').textContent = formatNumber(totals.fuel) + 'ì›';
      document.getElementById('totalAllowance').textContent = formatNumber(totals.allowance) + 'ì›';
      document.getElementById('totalMeal').textContent = formatNumber(totals.meal) + 'ì›';
      document.getElementById('grandTotal').textContent = formatNumber(totals.grand) + 'ì›';
    }

    // ì €ì¥
    async function saveExpense() {
      try {
        const title = document.getElementById('title').value;
        const draftDate = document.getElementById('draftDate').value;
        const drafter = document.getElementById('drafter').value;

        if (!title || !draftDate || !drafter) {
          alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }

        const totals = calculateTotals(dailyExpenses);

        const data = {
          title,
          tripIds: expenseData.tripIds || [],
          documentNumber: document.getElementById('documentNumber').value,
          requestNumber: document.getElementById('requestNumber').value,
          draftDate,
          drafter,
          status: document.getElementById('status').value,
          totalToll: totals.toll,
          totalFuel: totals.fuel,
          totalAllowance: totals.allowance,
          totalMeal: totals.meal,
          expenseDetail: createExpenseDetail(dailyExpenses),
          fuelPrice: parseFloat(document.getElementById('fuelPrice').value) || 0,
          fuelEfficiency: parseFloat(document.getElementById('fuelEfficiency').value) || 9,
          fuelPriceSource: document.getElementById('fuelPriceSource').value,
          remarks: document.getElementById('remarks').value
        };

        await updateExpense(expenseId, data);
        alert('âœ… ì§€ì¶œê²°ì˜ì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');

        window.location.href = `detail-expense.html?id=${expenseId}`;
      } catch (error) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
        alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    init();
  </script>
</body>
</html>
