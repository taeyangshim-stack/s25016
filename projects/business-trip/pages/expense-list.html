<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§€ì¶œê²°ì˜ì„œ ëª©ë¡ | S25016</title>
  <link rel="stylesheet" href="../../../shared/styles/variables.css">
  <link rel="stylesheet" href="../../../shared/styles/reset.css">
  <style>
    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      margin: 0;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn-white {
      background: white;
      color: #d97706;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-card .label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }

    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 30px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h2 {
      font-size: 18px;
      margin: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f9fafb;
    }

    th {
      padding: 12px 20px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 1px solid #e5e7eb;
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-ì‘ì„±ì¤‘ { background: #fef3c7; color: #92400e; }
    .status-ì œì¶œ { background: #dbeafe; color: #1e40af; }
    .status-ìŠ¹ì¸ { background: #d1fae5; color: #065f46; }
    .status-ë°˜ë ¤ { background: #fee2e2; color: #991b1b; }

    .amount {
      font-weight: 600;
      color: #1f2937;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #6b7280;
    }

    .empty {
      text-align: center;
      padding: 60px;
      color: #9ca3af;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-edit {
      background: #667eea;
      color: white;
    }

    .btn-delete {
      background: #ef4444;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ ì§€ì¶œê²°ì˜ì„œ ê´€ë¦¬</h1>
      <div style="display: flex; gap: 10px;">
        <a href="/" class="btn btn-white">â† ë©”ì¸</a>
        <a href="create-expense.html" class="btn btn-primary">+ ìƒˆ ì§€ê²° ì‘ì„±</a>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div style="background: white; border-radius: 12px; margin-bottom: 20px; display: flex; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <a href="/business-trip" style="flex: 1; padding: 16px 24px; text-align: center; color: #6b7280; font-weight: 600; text-decoration: none; transition: all 0.2s; border-bottom: 3px solid transparent;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
        âœˆï¸ ì¶œì¥ì‹ ì²­ì„œ
      </a>
      <div style="flex: 1; padding: 16px 24px; text-align: center; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600; cursor: default; border-bottom: 3px solid #f59e0b;">
        ğŸ’° ì§€ì¶œê²°ì˜ì„œ
      </div>
    </div>

    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="label">ì „ì²´</div>
        <div class="value">-</div>
      </div>
      <div class="stat-card">
        <div class="label">ğŸŸ¡ ì‘ì„±ì¤‘</div>
        <div class="value">-</div>
      </div>
      <div class="stat-card">
        <div class="label">ğŸ”µ ì œì¶œ</div>
        <div class="value">-</div>
      </div>
      <div class="stat-card">
        <div class="label">ğŸŸ¢ ìŠ¹ì¸</div>
        <div class="value">-</div>
      </div>
      <div class="stat-card">
        <div class="label">ì´ ì§€ì¶œì•¡</div>
        <div class="value">-</div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h2>ì§€ì¶œê²°ì˜ì„œ ëª©ë¡</h2>
      </div>
      <div id="tableContent">
        <div class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>

  <script src="/projects/business-trip/scripts/expense.js">
  <script>
    let expenses = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    async function init() {
      try {
        expenses = await getAllExpenses();
        renderStats();
        renderTable();
      } catch (error) {
        console.error('ë¡œë”© ì˜¤ë¥˜:', error);
        document.getElementById('tableContent').innerHTML = `
          <div class="empty">
            <p>âš ï¸ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</p>
            <p style="font-size: 12px; margin-top: 8px;">Notion ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
          </div>
        `;
      }
    }

    // í†µê³„ ë Œë”ë§
    function renderStats() {
      const total = expenses.length;
      const draft = expenses.filter(e => e.status === 'ì‘ì„±ì¤‘').length;
      const submitted = expenses.filter(e => e.status === 'ì œì¶œ').length;
      const approved = expenses.filter(e => e.status === 'ìŠ¹ì¸').length;
      const totalAmount = expenses.reduce((sum, e) => sum + (e.grandTotal || 0), 0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card">
          <div class="label">ì „ì²´</div>
          <div class="value">${total}ê±´</div>
        </div>
        <div class="stat-card">
          <div class="label">ğŸŸ¡ ì‘ì„±ì¤‘</div>
          <div class="value">${draft}ê±´</div>
        </div>
        <div class="stat-card">
          <div class="label">ğŸ”µ ì œì¶œ</div>
          <div class="value">${submitted}ê±´</div>
        </div>
        <div class="stat-card">
          <div class="label">ğŸŸ¢ ìŠ¹ì¸</div>
          <div class="value">${approved}ê±´</div>
        </div>
        <div class="stat-card">
          <div class="label">ì´ ì§€ì¶œì•¡</div>
          <div class="value">${formatNumber(totalAmount)}ì›</div>
        </div>
      `;
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
      if (expenses.length === 0) {
        document.getElementById('tableContent').innerHTML = `
          <div class="empty">
            <p>ğŸ“­ ë“±ë¡ëœ ì§€ì¶œê²°ì˜ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <a href="create-expense.html" class="btn btn-primary" style="margin-top: 20px;">+ ìƒˆ ì§€ê²° ì‘ì„±</a>
          </div>
        `;
        return;
      }

      const rows = expenses.map(exp => `
        <tr onclick="viewDetail('${exp.id}')">
          <td>${formatDate(exp.draftDate)}</td>
          <td><strong>${exp.title || '-'}</strong></td>
          <td>${exp.drafter || '-'}</td>
          <td><span class="status-badge status-${exp.status}">${exp.status || '-'}</span></td>
          <td class="amount">${formatNumber(exp.grandTotal)}ì›</td>
          <td>
            <div class="actions" onclick="event.stopPropagation()">
              <button class="btn-sm btn-edit" onclick="editExpense('${exp.id}')">ìˆ˜ì •</button>
              <button class="btn-sm btn-delete" onclick="deleteExpenseConfirm('${exp.id}')">ì‚­ì œ</button>
            </div>
          </td>
        </tr>
      `).join('');

      document.getElementById('tableContent').innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width: 120px;">ê¸°ì•ˆì¼</th>
              <th>ì œëª©</th>
              <th style="width: 100px;">ê¸°ì•ˆì</th>
              <th style="width: 100px;">ìƒíƒœ</th>
              <th style="width: 150px;">ì´ì•¡</th>
              <th style="width: 150px;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // ìƒì„¸ ë³´ê¸°
    function viewDetail(id) {
      window.location.href = `detail-expense.html?id=${id}`;
    }

    // ìˆ˜ì •
    function editExpense(id) {
      window.location.href = `edit-expense.html?id=${id}`;
    }

    // ì‚­ì œ í™•ì¸
    async function deleteExpenseConfirm(id) {
      if (!confirm('ì´ ì§€ì¶œê²°ì˜ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await deleteExpense(id);
        alert('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        init(); // ìƒˆë¡œê³ ì¹¨
      } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ì´ˆê¸°í™”
    init();
  </script>
</body>
</html>
