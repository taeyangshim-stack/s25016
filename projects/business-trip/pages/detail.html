<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¶œì¥ì‹ ì²­ì„œ ìƒì„¸ - S25016</title>
  <link rel="stylesheet" href="../../../shared/styles/variables.css">
  <link rel="stylesheet" href="../../../shared/styles/reset.css">
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --gray: #6b7280;
      --bg: #f0f2f5;
      --card-bg: #ffffff;
      --warning-bg: #fff9db;
      --warning-border: #f1c40f;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: var(--bg);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 24px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.3rem;
    }

    .header-meta {
      text-align: right;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* ì½˜í…ì¸  */
    .content {
      padding: 30px;
    }

    /* ìƒíƒœ ë±ƒì§€ (í°) */
    .status-badge-large {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 700;
      color: white;
      margin-bottom: 20px;
    }

    .status-draft { background: var(--gray); }
    .status-submitted { background: var(--info); }
    .status-approved { background: var(--success); }
    .status-rejected { background: var(--danger); }
    .status-completed { background: #8b5cf6; }

    /* ì •ë³´ í…Œì´ë¸” */
    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    .info-table th,
    .info-table td {
      border: 1px solid #ddd;
      padding: 12px 16px;
      text-align: left;
    }

    .info-table th {
      background: #f8f9fa;
      width: 25%;
      font-weight: 600;
      color: #555;
    }

    /* ì„¹ì…˜ */
    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #eee;
    }

    /* ì¼ì • í…Œì´ë¸” */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
    }

    .schedule-table th,
    .schedule-table td {
      border: 1px solid #ddd;
      padding: 10px 14px;
      text-align: left;
    }

    .schedule-table th {
      background: #f0f0f0;
      font-weight: 600;
    }

    .schedule-table tbody tr:nth-child(even) {
      background: #fafafa;
    }

    /* ë¹„ìš© */
    .cost-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .cost-item {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .cost-item .label {
      font-size: 13px;
      color: var(--gray);
      margin-bottom: 4px;
    }

    .cost-item .value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #333;
    }

    .cost-item.total {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }

    .cost-item.total .label,
    .cost-item.total .value {
      color: white;
    }

    /* íŠ¹ê¸°ì‚¬í•­ */
    .remarks-box {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 16px;
      white-space: pre-wrap;
    }

    /* ì¸ë ¥ê³µë°± ê²½ê³  */
    .vacancy-warning {
      background: var(--warning-bg);
      padding: 16px;
      border-left: 5px solid var(--warning-border);
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .vacancy-warning strong {
      color: var(--danger);
    }

    /* ë²„íŠ¼ */
    .actions {
      display: flex;
      gap: 12px;
      padding: 24px 30px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .spacer {
      flex: 1;
    }

    /* ë¡œë”© */
    .loading {
      text-align: center;
      padding: 60px;
      color: var(--gray);
    }

    /* ì—ëŸ¬ */
    .error {
      text-align: center;
      padding: 60px;
      color: var(--danger);
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; gap: 10px; }
      .content { padding: 20px; }
      .info-table th { width: 35%; }
      .actions { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <div class="loading">ë°ì´í„° ë¡œë”©ì¤‘...</div>
  </div>

  <script src="/projects/business-trip/scripts/business-trip.js"></script>
  <script>
    const api = new BusinessTripAPI({ useMock: false });
    const utils = BusinessTripUtils;

    let tripData = null;

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', loadTrip);

    // ë°ì´í„° ë¡œë”©
    async function loadTrip() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');

      if (!id) {
        showError('ì‹ ì²­ì„œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        const result = await api.getById(id);

        if (result.success && result.data) {
          tripData = result.data;
          render();
        } else {
          showError('ì‹ ì²­ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Load error:', error);
        showError('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë Œë”ë§
    function render() {
      const days = utils.calculateDays(tripData.startDate, tripData.endDate);
      const startFormatted = utils.formatDate(tripData.startDate, 'YYYY-MM-DD(ddd)');
      const endFormatted = utils.formatDate(tripData.endDate, 'YYYY-MM-DD(ddd)');
      const period = `${startFormatted} ~ ${endFormatted} (${days}ì¼)`;

      const statusClass = getStatusClass(tripData.status);

      // ì¼ì • íŒŒì‹± (JSON ë˜ëŠ” í…ìŠ¤íŠ¸)
      let schedule = [];
      let scheduleText = '';
      try {
        schedule = utils.parseSchedule(tripData.schedule);
      } catch (e) {
        scheduleText = tripData.schedule || '';
      }
      if (!schedule || schedule.length === 0) {
        scheduleText = tripData.schedule || '';
      }

      // ì¸ë ¥ê³µë°± ê²½ê³ 
      const vacancyWarning = tripData.hasVacancy ? `
        <div class="vacancy-warning">
          <strong>ì¸ë ¥ ê³µë°± ë°œìƒ:</strong> ì´ ì¶œì¥ ê¸°ê°„ ì¤‘ ì¸ë ¥ ê³µë°±ì´ ë°œìƒí•©ë‹ˆë‹¤.
        </div>
      ` : '';

      // ì¼ì • í‘œì‹œ (JSON í…Œì´ë¸” ë˜ëŠ” í…ìŠ¤íŠ¸)
      let scheduleHtml = '';
      if (schedule.length > 0) {
        // JSON í˜•ì‹ì˜ ì¼ì • í…Œì´ë¸”
        scheduleHtml = `
          <table class="schedule-table">
            <thead>
              <tr>
                <th>ì¼ì</th>
                <th>ì‹œê°„</th>
                <th>ë°©ë¬¸ì²˜</th>
                <th>ì—…ë¬´ ë‚´ìš©</th>
              </tr>
            </thead>
            <tbody>
              ${schedule.map(s => `
                <tr>
                  <td>${utils.formatDate(s.date, 'MM/DD(ddd)')}</td>
                  <td>${s.time || '-'}</td>
                  <td>${escapeHtml(s.location) || '-'}</td>
                  <td>${escapeHtml(s.content) || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else if (scheduleText) {
        // í…ìŠ¤íŠ¸ í˜•ì‹ì˜ ì¼ì • (ë§ˆí¬ë‹¤ìš´/ì¼ë°˜ í…ìŠ¤íŠ¸)
        scheduleHtml = parseMarkdownSchedule(scheduleText);
      } else {
        scheduleHtml = '<p style="color: var(--gray);">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }

      document.getElementById('main-container').innerHTML = `
        <!-- í—¤ë” -->
        <header class="header">
          <div>
            <h1>ì¶œì¥ì‹ ì²­ì„œ</h1>
          </div>
          <div class="header-meta">
            <div>${tripData.requestNumber || '-'}</div>
            <div>${utils.formatDate(tripData.createdTime, 'YYYY-MM-DD')}</div>
          </div>
        </header>

        <!-- ì½˜í…ì¸  -->
        <div class="content">
          <span class="status-badge-large ${statusClass}">${tripData.status}</span>

          ${vacancyWarning}

          <div class="section">
            <h3 class="section-title">ê¸°ë³¸ ì •ë³´</h3>
            <table class="info-table">
              <tr>
                <th>ì œëª©</th>
                <td colspan="3">${escapeHtml(tripData.title)}</td>
              </tr>
              <tr>
                <th>ì‹ ì²­ì</th>
                <td>${tripData.applicant || '-'}</td>
                <th>ê¸°ì•ˆë¶€ì„œ</th>
                <td>${tripData.department || '-'}</td>
              </tr>
              <tr>
                <th>êµ¬ë¶„</th>
                <td>${tripData.tripCategory || '-'}</td>
                <th>ì¶œì¥ìœ í˜•</th>
                <td>${tripData.tripType || '-'}</td>
              </tr>
              <tr>
                <th>ëª©ì ì§€</th>
                <td>${tripData.destination || '-'} ${tripData.destinationDetail ? '(' + escapeHtml(tripData.destinationDetail) + ')' : ''}</td>
                <th>ê¸°ê°„</th>
                <td>${period}</td>
              </tr>
              <tr>
                <th>ìš°ì„ ìˆœìœ„</th>
                <td>${tripData.priority || 'ë³´í†µ'}</td>
                <th>í€ì¹˜ë¦¬ìŠ¤íŠ¸</th>
                <td>${formatPunchlistIds(tripData.punchlistId)}</td>
              </tr>
            </table>
          </div>

          <div class="section">
            <h3 class="section-title">ì¶œì¥ ëª©ì </h3>
            <div class="remarks-box">${escapeHtml(tripData.purpose) || '-'}</div>
          </div>

          <div class="section">
            <h3 class="section-title">ìƒì„¸ ì¼ì •</h3>
            ${scheduleHtml}
          </div>

          <div class="section">
            <h3 class="section-title">ì¶œì¥ë¹„</h3>
            <div class="cost-summary">
              <div class="cost-item">
                <div class="label">ìˆ™ë°•ë¹„</div>
                <div class="value">${utils.formatCurrency(tripData.accommodationCost)}</div>
              </div>
              <div class="cost-item">
                <div class="label">êµí†µë¹„</div>
                <div class="value">${utils.formatCurrency(tripData.transportCost)}</div>
              </div>
              <div class="cost-item">
                <div class="label">ì‹ëŒ€</div>
                <div class="value">${utils.formatCurrency(tripData.mealCost)}</div>
              </div>
              <div class="cost-item">
                <div class="label">ê¸°íƒ€</div>
                <div class="value">${utils.formatCurrency(tripData.otherCost)}</div>
              </div>
              <div class="cost-item total">
                <div class="label">ì´ ì˜ˆìƒë¹„ìš©</div>
                <div class="value">${utils.formatCurrency(tripData.totalCost)}</div>
              </div>
            </div>
          </div>

          ${tripData.remarks ? `
          <div class="section">
            <h3 class="section-title">íŠ¹ê¸° ì‚¬í•­ / ë¹„ê³ </h3>
            <div class="remarks-box">${formatRemarks(tripData.remarks)}</div>
          </div>
          ` : ''}
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="actions">
          <a href="/business-trip" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>

          <a href="create-expense.html?tripId=${tripData.id}" class="btn btn-primary" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">ğŸ“‹ ì§€ê²° ì‘ì„±</a>

          <span class="spacer"></span>

          ${tripData.status === 'ì‹ ì²­ì™„ë£Œ' ? `
            <button class="btn btn-success" onclick="approveTrip()">ìŠ¹ì¸</button>
            <button class="btn btn-danger" onclick="rejectTrip()">ë°˜ë ¤</button>
          ` : ''}

          ${tripData.status === 'ì‘ì„±ì¤‘' || tripData.status === 'ë°˜ë ¤' ? `
            <button class="btn btn-primary" onclick="editTrip()">ìˆ˜ì •</button>
          ` : ''}

          <button class="btn btn-danger" onclick="deleteTrip()">ì‚­ì œ</button>
        </div>
      `;
    }

    // ìƒíƒœ í´ë˜ìŠ¤
    function getStatusClass(status) {
      const map = {
        'ì‘ì„±ì¤‘': 'status-draft',
        'ì‹ ì²­ì™„ë£Œ': 'status-submitted',
        'ìŠ¹ì¸': 'status-approved',
        'ë°˜ë ¤': 'status-rejected',
        'ì™„ë£Œ': 'status-completed'
      };
      return map[status] || 'status-draft';
    }

    // ìŠ¹ì¸
    async function approveTrip() {
      if (!confirm('ì´ ì¶œì¥ì‹ ì²­ì„œë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const result = await api.updateStatus(tripData.id, 'ìŠ¹ì¸');
        if (result.success) {
          alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } else {
          alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('Approve error:', error);
        alert('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë°˜ë ¤
    async function rejectTrip() {
      const reason = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (reason === null) return;

      try {
        const result = await api.update(tripData.id, {
          status: 'ë°˜ë ¤',
          remarks: tripData.remarks + '\n\n[ë°˜ë ¤ì‚¬ìœ ] ' + reason
        });
        if (result.success) {
          alert('ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } else {
          alert('ë°˜ë ¤ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('Reject error:', error);
        alert('ë°˜ë ¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìˆ˜ì • (create í˜ì´ì§€ë¡œ ì´ë™)
    function editTrip() {
      // TODO: ìˆ˜ì • ëª¨ë“œ êµ¬í˜„
      alert('ìˆ˜ì • ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
    }

    // ì‚­ì œ
    async function deleteTrip() {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

      try {
        const result = await api.delete(tripData.id);
        if (result.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.href = '../index.html';
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      document.getElementById('main-container').innerHTML = `
        <div class="error">
          <p>${message}</p>
          <a href="../index.html" class="btn btn-secondary" style="margin-top: 20px;">ëª©ë¡ìœ¼ë¡œ</a>
        </div>
      `;
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // ë§ˆí¬ë‹¤ìš´ ì¼ì •ì„ HTMLë¡œ ë³€í™˜
    function parseMarkdownSchedule(text) {
      if (!text) return '<p style="color: var(--gray);">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';

      const lines = text.split('\n').filter(line => line.trim());
      let html = '';
      let inTable = false;
      let tableRows = [];

      for (const line of lines) {
        const trimmed = line.trim();

        // ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ê°ì§€ (| ë¡œ ì‹œì‘í•˜ê³  ëë‚˜ëŠ” ì¤„)
        if (trimmed.startsWith('|') && trimmed.endsWith('|')) {
          // êµ¬ë¶„ì„ (---|---)ì€ ìŠ¤í‚µ
          if (/^\|[\s\-:|]+\|$/.test(trimmed)) continue;

          const cells = trimmed.split('|').filter((_, i, arr) => i > 0 && i < arr.length - 1);
          tableRows.push(cells.map(c => c.trim()));
          inTable = true;
        } else {
          // í…Œì´ë¸”ì´ ëë‚¬ìœ¼ë©´ ë Œë”ë§
          if (inTable && tableRows.length > 0) {
            html += renderScheduleTable(tableRows);
            tableRows = [];
            inTable = false;
          }

          // ì œëª© (## ë˜ëŠ” **ì œëª©**)
          if (trimmed.startsWith('## ')) {
            html += `<h4 style="margin: 20px 0 12px; color: var(--primary-dark); font-size: 15px;">${escapeHtml(trimmed.slice(3))}</h4>`;
          } else if (trimmed.startsWith('**') && trimmed.endsWith('**')) {
            html += `<h4 style="margin: 16px 0 10px; color: #333; font-size: 14px;">${escapeHtml(trimmed.slice(2, -2))}</h4>`;
          } else if (trimmed) {
            // ì¼ë°˜ í…ìŠ¤íŠ¸
            html += `<p style="margin: 8px 0; color: #555;">${escapeHtml(trimmed)}</p>`;
          }
        }
      }

      // ë§ˆì§€ë§‰ í…Œì´ë¸” ì²˜ë¦¬
      if (tableRows.length > 0) {
        html += renderScheduleTable(tableRows);
      }

      return html || '<p style="color: var(--gray);">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    // ì¼ì • í…Œì´ë¸” ë Œë”ë§
    function renderScheduleTable(rows) {
      if (rows.length === 0) return '';

      const header = rows[0];
      const body = rows.slice(1);

      // í—¤ë”ì— ë”°ë¥¸ ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
      const colWidths = header.map(h => {
        if (h.includes('ë‚ ì§œ') || h.includes('ì¼ì')) return '100px';
        if (h.includes('ì‹œê°„')) return '80px';
        return 'auto';
      });

      let html = `<table class="schedule-table" style="margin-bottom: 20px;">`;
      html += '<thead><tr>';
      header.forEach((h, i) => {
        html += `<th style="width: ${colWidths[i]}; white-space: nowrap;">${escapeHtml(h)}</th>`;
      });
      html += '</tr></thead>';

      html += '<tbody>';
      let prevDate = '';
      body.forEach(row => {
        html += '<tr>';
        row.forEach((cell, i) => {
          // ì²« ë²ˆì§¸ ì—´(ë‚ ì§œ)ì´ ì´ì „ê³¼ ê°™ìœ¼ë©´ ë³‘í•© íš¨ê³¼
          let style = '';
          if (i === 0) {
            if (cell === prevDate) {
              style = 'color: transparent; border-top: none;';
            } else {
              prevDate = cell;
              style = 'font-weight: 600; background: #f8f9fa;';
            }
          }
          // ì„¸ë¶€ í•­ëª© ì—´ì€ ì‘ì€ ê¸€ì”¨
          if (header[i] && (header[i].includes('ì„¸ë¶€') || header[i].includes('í•­ëª©'))) {
            style += 'font-size: 12px; line-height: 1.5;';
          }
          html += `<td style="${style}">${formatCellContent(cell)}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table>';

      return html;
    }

    // ë¹„ê³  í¬ë§·íŒ… (ë§ˆí¬ë‹¤ìš´ ë§í¬, ì œëª©, PLë²ˆí˜¸ ì§€ì›)
    function formatRemarks(text) {
      if (!text) return '';
      // Notionì˜ {{url}} í˜•ì‹ ì œê±°
      let cleaned = text.replace(/\{\{([^}]+)\}\}/g, '$1');
      // <br> íƒœê·¸ë¥¼ \nìœ¼ë¡œ ë³€í™˜ (ë¨¼ì € ì²˜ë¦¬)
      cleaned = cleaned.replace(/<br\s*\/?>/gi, '\n');

      // ì¤„ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
      const lines = cleaned.split('\n');
      let html = '';

      for (let line of lines) {
        line = line.trim();
        if (!line) {
          html += '<br>';
          continue;
        }

        // ë§ˆí¬ë‹¤ìš´ ë§í¬ ì²˜ë¦¬
        line = line.replace(/\[([^\]]+)\]\(([^)]+)\)/g,
          '<a href="$2" target="_blank" style="color: #4338ca; text-decoration: underline;">$1</a>');

        // PL ë²ˆí˜¸ ë§í¬
        line = line.replace(/(PL-\d{4}-\d{3})/g,
          '<a href="/punchlist/pages/detail?id=$1" target="_blank" style="background: #e0e7ff; padding: 1px 4px; border-radius: 3px; font-size: 11px; color: #4338ca; text-decoration: none;">$1</a>');

        // ## ì œëª©
        if (line.startsWith('## ')) {
          html += `<strong style="display: block; margin-top: 16px; margin-bottom: 8px; color: var(--primary-dark); font-size: 14px;">${line.slice(3)}</strong>`;
        }
        // ### ì†Œì œëª©
        else if (line.startsWith('### ')) {
          html += `<strong style="display: block; margin-top: 12px; margin-bottom: 6px; color: #555; font-size: 13px;">${line.slice(4)}</strong>`;
        }
        // ë¦¬ìŠ¤íŠ¸ í•­ëª©
        else if (line.startsWith('- ')) {
          html += `<div style="margin: 4px 0; padding-left: 16px;">â€¢ ${line.slice(2)}</div>`;
        }
        // ì¼ë°˜ í…ìŠ¤íŠ¸
        else {
          html += `<div style="margin: 4px 0;">${line}</div>`;
        }
      }

      return html;
    }

    // í€ì¹˜ë¦¬ìŠ¤íŠ¸ ID ë§í¬ í¬ë§·íŒ…
    function formatPunchlistIds(ids) {
      if (!ids) return '-';
      return ids.replace(/(PL-\d{4}-\d{3})/g,
        '<a href="/punchlist/pages/detail?id=$1" target="_blank" style="background: #e0e7ff; padding: 2px 6px; border-radius: 4px; font-size: 12px; color: #4338ca; text-decoration: none; margin-right: 4px; display: inline-block; margin-bottom: 2px;" title="í€ì¹˜ë¦¬ìŠ¤íŠ¸ ìƒì„¸ë³´ê¸°">$1</a>');
    }

    // ì…€ ë‚´ìš© í¬ë§·íŒ… (PL ë²ˆí˜¸ ë§í¬, ì¹´í…Œê³ ë¦¬ ê°•ì¡° ë“±)
    function formatCellContent(text) {
      if (!text) return '-';
      return escapeHtml(text)
        // PL ë²ˆí˜¸ë¥¼ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ë¡œ ë³€í™˜
        .replace(/(PL-\d{4}-\d{3})/g, '<a href="/punchlist/pages/detail?id=$1" target="_blank" style="background: #e0e7ff; padding: 1px 4px; border-radius: 3px; font-size: 11px; color: #4338ca; text-decoration: none; cursor: pointer;" title="í€ì¹˜ë¦¬ìŠ¤íŠ¸ ìƒì„¸ë³´ê¸°">$1</a>')
        // ëŒ€ê´„í˜¸ ì¹´í…Œê³ ë¦¬ ê°•ì¡°
        .replace(/\[([^\]]+)\]/g, '<span style="background: #fef3c7; padding: 1px 6px; border-radius: 3px; font-size: 11px; color: #92400e; font-weight: 600;">$1</span>');
    }
  </script>
</body>
</html>
