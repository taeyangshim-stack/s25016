<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¶œì¥ì‹ ì²­ì„œ ê´€ë¦¬ - S25016</title>
  <link rel="stylesheet" href="../../shared/styles/variables.css">
  <link rel="stylesheet" href="../../shared/styles/reset.css">
  <link rel="stylesheet" href="../../shared/styles/components.css">
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --gray: #6b7280;
      --bg: #f0f2f5;
      --card-bg: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* í—¤ë” */
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    /* ì•¡ì…˜ ë°” */
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-primary {
      background: white;
      color: var(--primary);
    }

    .btn-primary:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.3);
    }

    /* KPI ì¹´ë“œ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .kpi-card .label {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .kpi-card .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .kpi-card.total .value { color: var(--primary); }
    .kpi-card.pending .value { color: var(--info); }
    .kpi-card.approved .value { color: var(--success); }
    .kpi-card.ongoing .value { color: var(--warning); }

    /* í•„í„° ì˜ì—­ */
    .filter-bar {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .filter-bar select,
    .filter-bar input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-width: 140px;
    }

    .filter-bar input[type="text"] {
      min-width: 200px;
    }

    .filter-bar select:focus,
    .filter-bar input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* í…Œì´ë¸” */
    .table-container {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      font-size: 13px;
      text-transform: uppercase;
    }

    tr:hover {
      background: #f8f9fa;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* ë±ƒì§€ */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .badge-draft { background: var(--gray); }
    .badge-submitted { background: var(--info); }
    .badge-approved { background: var(--success); }
    .badge-rejected { background: var(--danger); }
    .badge-completed { background: #8b5cf6; }

    .badge-urgent { background: var(--danger); }
    .badge-high { background: var(--warning); }
    .badge-normal { background: var(--info); }
    .badge-low { background: var(--gray); }

    /* ë§í¬ */
    .trip-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }

    .trip-link:hover {
      text-decoration: underline;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray);
    }

    .empty-state p {
      font-size: 16px;
      margin-bottom: 16px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .header h1 { font-size: 1.5rem; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .filter-bar { flex-direction: column; align-items: stretch; }
      .table-container { overflow-x: auto; }
      table { min-width: 800px; }
    }

    /* ë¡œë”© */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    /* ì¸ë ¥ê³µë°± í‘œì‹œ */
    .vacancy-badge {
      background: #fef3c7;
      color: #d97706;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <header class="header">
      <h1>ì¶œì¥ì‹ ì²­ì„œ ê´€ë¦¬</h1>
      <p>S25016 í”„ë¡œì íŠ¸ ì¶œì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
    </header>

    <!-- ì•¡ì…˜ ë°” -->
    <div class="action-bar">
      <div style="display:flex;gap:10px;">
        <a href="/business-trip/create" class="btn btn-primary">
          + ìƒˆ ì¶œì¥ ì‹ ì²­
        </a>
        <a href="/business-trip/draft" class="btn btn-primary" style="background:#10b981;">
          ì´ˆì•ˆ ì‘ì„±
        </a>
      </div>
      <div>
        <a href="/" class="btn btn-secondary">ë©”ì¸ ëŒ€ì‹œë³´ë“œ</a>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div style="background: var(--card-bg); border-radius: 12px; padding: 0; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; overflow: hidden;">
      <div style="flex: 1; padding: 16px 24px; text-align: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-weight: 600; cursor: default; border-bottom: 3px solid var(--primary);">
        âœˆï¸ ì¶œì¥ì‹ ì²­ì„œ
      </div>
      <a href="/business-trip/expense-list" style="flex: 1; padding: 16px 24px; text-align: center; color: var(--gray); font-weight: 600; text-decoration: none; transition: all 0.2s; border-bottom: 3px solid transparent;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
        ğŸ’° ì§€ì¶œê²°ì˜ì„œ
      </a>
    </div>

    <!-- KPI ì¹´ë“œ -->
    <div class="kpi-grid">
      <div class="kpi-card total">
        <div class="label">ì „ì²´ ì‹ ì²­</div>
        <div class="value" id="kpi-total">-</div>
      </div>
      <div class="kpi-card pending">
        <div class="label">ìŠ¹ì¸ ëŒ€ê¸°</div>
        <div class="value" id="kpi-pending">-</div>
      </div>
      <div class="kpi-card approved">
        <div class="label">ìŠ¹ì¸ë¨</div>
        <div class="value" id="kpi-approved">-</div>
      </div>
      <div class="kpi-card ongoing">
        <div class="label">ì§„í–‰ì¤‘</div>
        <div class="value" id="kpi-ongoing">-</div>
      </div>
    </div>

    <!-- ì¶œì¥ì—¬ë¹„ ê·œì • -->
    <div class="expense-rules" style="background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="font-size: 16px; color: #333; margin: 0;">ğŸ“‹ ì¶œì¥ì—¬ë¹„ ì§€ê¸‰ ê·œì •</h3>
        <span style="font-size: 12px; color: var(--gray);">íš¨ë ¥: 2025.04.01 ~ (2025.05.14 ê²Œì‹œ)</span>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
        <div style="text-align: center; padding: 16px; background: #f0f9ff; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--info); font-weight: 600; margin-bottom: 8px;">í‰ì¼ í•©ê³„</div>
          <div style="font-size: 24px; font-weight: 700; color: var(--info);">45,000ì›</div>
          <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">ì¼ë¹„ 15,000 + ì‹ë¹„ 30,000</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #fef3c7; border-radius: 8px;">
          <div style="font-size: 12px; color: #d97706; font-weight: 600; margin-bottom: 8px;">íœ´ì¼ í•©ê³„</div>
          <div style="font-size: 24px; font-weight: 700; color: #d97706;">50,000ì›</div>
          <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">ì¼ë¹„ 20,000 + ì‹ë¹„ 30,000</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #fce7f3; border-radius: 8px;">
          <div style="font-size: 12px; color: #be185d; font-weight: 600; margin-bottom: 8px;">íŠ¹ë³„ ì§€ì¹¨</div>
          <div style="font-size: 13px; color: #be185d; font-weight: 600;">ê³µíœ´ì¼/ì—­ê³µê¸° 50%</div>
          <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">ì—­ê³µê¸° ì•¼ê°„ 100%</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #ecfdf5; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--success); font-weight: 600; margin-bottom: 8px;">ê·¼ê±° ë¬¸ì„œ</div>
          <div style="font-size: 11px; color: #333;">SPS-WR-04</div>
          <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">ì¸ì‚¬íŒ€ (ì´ì¬ì°¬ ëŒ€ë¦¬)</div>
        </div>
      </div>
    </div>

    <!-- í•„í„° ë°” -->
    <div class="filter-bar">
      <select id="filter-status">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <option value="ì‘ì„±ì¤‘">ì‘ì„±ì¤‘</option>
        <option value="ì‹ ì²­ì™„ë£Œ">ì‹ ì²­ì™„ë£Œ</option>
        <option value="ìŠ¹ì¸">ìŠ¹ì¸</option>
        <option value="ë°˜ë ¤">ë°˜ë ¤</option>
        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
      </select>

      <select id="filter-type">
        <option value="">ì „ì²´ ìœ í˜•</option>
        <option value="ì‹œìš´ì „">ì‹œìš´ì „</option>
        <option value="íšŒì˜">íšŒì˜</option>
        <option value="êµìœ¡">êµìœ¡</option>
        <option value="ì ê²€">ì ê²€</option>
        <option value="ê¸°ìˆ ì§€ì›">ê¸°ìˆ ì§€ì›</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>

      <input type="text" id="filter-search" placeholder="ê²€ìƒ‰ (ì œëª©, ëª©ì ì§€...)">

      <button class="btn btn-secondary" onclick="resetFilters()" style="background: #ddd; color: #333;">
        í•„í„° ì´ˆê¸°í™”
      </button>
    </div>

    <!-- í…Œì´ë¸” -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ì‹ ì²­ë²ˆí˜¸</th>
            <th>ì œëª©</th>
            <th>ì¶œì¥ìœ í˜•</th>
            <th>ëª©ì ì§€</th>
            <th>ê¸°ê°„</th>
            <th>ì‹ ì²­ì</th>
            <th>ìƒíƒœ</th>
            <th>ìš°ì„ ìˆœìœ„</th>
          </tr>
        </thead>
        <tbody id="trip-table-body">
          <tr>
            <td colspan="8" class="loading">ë°ì´í„° ë¡œë”©ì¤‘...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="/projects/business-trip/scripts/business-trip.js"></script>
  <script>
    // API ì¸ìŠ¤í„´ìŠ¤ (Mock ëª¨ë“œë¡œ ì‹œì‘, Notion ì—°ë™ ì‹œ falseë¡œ ë³€ê²½)
    const api = new BusinessTripAPI({ useMock: false });
    const utils = BusinessTripUtils;

    let allTrips = [];

    // ì´ˆê¸° ë¡œë”©
    document.addEventListener('DOMContentLoaded', loadTrips);

    // í•„í„° ì´ë²¤íŠ¸
    document.getElementById('filter-status').addEventListener('change', applyFilters);
    document.getElementById('filter-type').addEventListener('change', applyFilters);
    document.getElementById('filter-search').addEventListener('input', debounce(applyFilters, 300));

    // ë°ì´í„° ë¡œë”©
    async function loadTrips() {
      try {
        console.log('[DEBUG] Loading trips from:', api.baseUrl);
        const result = await api.getAll();
        console.log('[DEBUG] API Response:', result);

        if (result.success) {
          allTrips = result.data || [];
          console.log('[DEBUG] Loaded trips:', allTrips.length, allTrips);
          updateKPIs();
          renderTable(allTrips);
        } else {
          console.error('[DEBUG] API returned failure:', result);
          showError('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + (result.error || result.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('[DEBUG] Load error:', error);
        showError('API ì˜¤ë¥˜: ' + error.message);
      }
    }

    // KPI ì—…ë°ì´íŠ¸
    function updateKPIs() {
      const total = allTrips.length;
      const pending = allTrips.filter(t => t.status === 'ì‹ ì²­ì™„ë£Œ').length;
      const approved = allTrips.filter(t => t.status === 'ìŠ¹ì¸').length;

      // ì§„í–‰ì¤‘: ìŠ¹ì¸ë˜ì—ˆê³  ì˜¤ëŠ˜ì´ ì¶œì¥ ê¸°ê°„ ë‚´ì¸ ê²½ìš°
      const today = new Date().toISOString().split('T')[0];
      const ongoing = allTrips.filter(t => {
        return t.status === 'ìŠ¹ì¸' && t.startDate <= today && t.endDate >= today;
      }).length;

      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-pending').textContent = pending;
      document.getElementById('kpi-approved').textContent = approved;
      document.getElementById('kpi-ongoing').textContent = ongoing;
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(trips) {
      const tbody = document.getElementById('trip-table-body');

      if (trips.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <p>ì¶œì¥ì‹ ì²­ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              <a href="/business-trip/create" class="btn btn-primary">ìƒˆ ì¶œì¥ ì‹ ì²­</a>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = trips.map(trip => {
        let period = '-';
        try {
          if (trip.startDate && trip.endDate) {
            const days = utils.calculateDays(trip.startDate, trip.endDate);
            const startFormatted = utils.formatDate(trip.startDate, 'MM/DD(ddd)');
            const endFormatted = utils.formatDate(trip.endDate, 'MM/DD(ddd)');
            period = `${startFormatted} ~ ${endFormatted} (${days}ì¼)`;
          } else if (trip.startDate) {
            period = utils.formatDate(trip.startDate, 'MM/DD(ddd)') + ' ~';
          }
        } catch (e) {
          console.warn('Date format error for trip:', trip.id, e);
        }

        const statusClass = getStatusClass(trip.status);
        const priorityClass = getPriorityClass(trip.priority);

        const vacancyBadge = trip.hasVacancy
          ? '<span class="vacancy-badge">ì¸ë ¥ê³µë°±</span>'
          : '';

        return `
          <tr>
            <td>${trip.requestNumber || '-'}</td>
            <td>
              <a href="/business-trip/detail?id=${trip.id}" class="trip-link">
                ${escapeHtml(trip.title)}
              </a>
              ${vacancyBadge}
            </td>
            <td>${trip.tripType || '-'}</td>
            <td>${trip.destination || '-'}</td>
            <td>${period}</td>
            <td>${trip.applicant || '-'}</td>
            <td><span class="badge ${statusClass}">${trip.status}</span></td>
            <td><span class="badge ${priorityClass}">${trip.priority || 'ë³´í†µ'}</span></td>
          </tr>
        `;
      }).join('');
    }

    // í•„í„° ì ìš©
    function applyFilters() {
      const status = document.getElementById('filter-status').value;
      const type = document.getElementById('filter-type').value;
      const search = document.getElementById('filter-search').value.toLowerCase();

      let filtered = allTrips;

      if (status) {
        filtered = filtered.filter(t => t.status === status);
      }

      if (type) {
        filtered = filtered.filter(t => t.tripType === type);
      }

      if (search) {
        filtered = filtered.filter(t =>
          (t.title && t.title.toLowerCase().includes(search)) ||
          (t.destination && t.destination.toLowerCase().includes(search)) ||
          (t.applicant && t.applicant.toLowerCase().includes(search)) ||
          (t.requestNumber && t.requestNumber.toLowerCase().includes(search))
        );
      }

      renderTable(filtered);
    }

    // í•„í„° ì´ˆê¸°í™”
    function resetFilters() {
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-type').value = '';
      document.getElementById('filter-search').value = '';
      renderTable(allTrips);
    }

    // ìœ í‹¸ë¦¬í‹°
    function getStatusClass(status) {
      const map = {
        'ì‘ì„±ì¤‘': 'badge-draft',
        'ì‹ ì²­ì™„ë£Œ': 'badge-submitted',
        'ìŠ¹ì¸': 'badge-approved',
        'ë°˜ë ¤': 'badge-rejected',
        'ì™„ë£Œ': 'badge-completed'
      };
      return map[status] || 'badge-draft';
    }

    function getPriorityClass(priority) {
      const map = {
        'ê¸´ê¸‰': 'badge-urgent',
        'ë†’ìŒ': 'badge-high',
        'ë³´í†µ': 'badge-normal',
        'ë‚®ìŒ': 'badge-low'
      };
      return map[priority] || 'badge-normal';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function showError(message) {
      document.getElementById('trip-table-body').innerHTML = `
        <tr>
          <td colspan="8" class="empty-state">
            <p style="color: var(--danger);">${message}</p>
          </td>
        </tr>
      `;
    }
  </script>
</body>
</html>
