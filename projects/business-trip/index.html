<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>출장신청서 관리 - S25016</title>
  <link rel="stylesheet" href="../../shared/styles/variables.css">
  <link rel="stylesheet" href="../../shared/styles/reset.css">
  <link rel="stylesheet" href="../../shared/styles/components.css">
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --gray: #6b7280;
      --bg: #f0f2f5;
      --card-bg: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* 헤더 */
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    /* 액션 바 */
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-primary {
      background: white;
      color: var(--primary);
    }

    .btn-primary:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.3);
    }

    /* KPI 카드 */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .kpi-card .label {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .kpi-card .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .kpi-card.total .value { color: var(--primary); }
    .kpi-card.pending .value { color: var(--info); }
    .kpi-card.approved .value { color: var(--success); }
    .kpi-card.ongoing .value { color: var(--warning); }

    /* 필터 영역 */
    .filter-bar {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .filter-bar select,
    .filter-bar input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-width: 140px;
    }

    .filter-bar input[type="text"] {
      min-width: 200px;
    }

    .filter-bar select:focus,
    .filter-bar input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* 테이블 */
    .table-container {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      font-size: 13px;
      text-transform: uppercase;
    }

    tr:hover {
      background: #f8f9fa;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* 뱃지 */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .badge-draft { background: var(--gray); }
    .badge-submitted { background: var(--info); }
    .badge-approved { background: var(--success); }
    .badge-rejected { background: var(--danger); }
    .badge-completed { background: #8b5cf6; }

    .badge-urgent { background: var(--danger); }
    .badge-high { background: var(--warning); }
    .badge-normal { background: var(--info); }
    .badge-low { background: var(--gray); }

    /* 링크 */
    .trip-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }

    .trip-link:hover {
      text-decoration: underline;
    }

    /* 빈 상태 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray);
    }

    .empty-state p {
      font-size: 16px;
      margin-bottom: 16px;
    }

    /* 반응형 */
    @media (max-width: 768px) {
      .header h1 { font-size: 1.5rem; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .filter-bar { flex-direction: column; align-items: stretch; }
      .table-container { overflow-x: auto; }
      table { min-width: 800px; }
    }

    /* 로딩 */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    /* 인력공백 표시 */
    .vacancy-badge {
      background: #fef3c7;
      color: #d97706;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <header class="header">
      <h1>출장신청서 관리</h1>
      <p>S25016 프로젝트 출장 관리 시스템</p>
    </header>

    <!-- 액션 바 -->
    <div class="action-bar">
      <div style="display:flex;gap:10px;">
        <a href="/business-trip/create" class="btn btn-primary">
          + 새 출장 신청
        </a>
        <a href="/business-trip/draft" class="btn btn-primary" style="background:#10b981;">
          초안 작성
        </a>
      </div>
      <div>
        <a href="/" class="btn btn-secondary">메인 대시보드</a>
      </div>
    </div>

    <!-- KPI 카드 -->
    <div class="kpi-grid">
      <div class="kpi-card total">
        <div class="label">전체 신청</div>
        <div class="value" id="kpi-total">-</div>
      </div>
      <div class="kpi-card pending">
        <div class="label">승인 대기</div>
        <div class="value" id="kpi-pending">-</div>
      </div>
      <div class="kpi-card approved">
        <div class="label">승인됨</div>
        <div class="value" id="kpi-approved">-</div>
      </div>
      <div class="kpi-card ongoing">
        <div class="label">진행중</div>
        <div class="value" id="kpi-ongoing">-</div>
      </div>
    </div>

    <!-- 필터 바 -->
    <div class="filter-bar">
      <select id="filter-status">
        <option value="">전체 상태</option>
        <option value="작성중">작성중</option>
        <option value="신청완료">신청완료</option>
        <option value="승인">승인</option>
        <option value="반려">반려</option>
        <option value="완료">완료</option>
      </select>

      <select id="filter-type">
        <option value="">전체 유형</option>
        <option value="시운전">시운전</option>
        <option value="회의">회의</option>
        <option value="교육">교육</option>
        <option value="점검">점검</option>
        <option value="기술지원">기술지원</option>
        <option value="기타">기타</option>
      </select>

      <input type="text" id="filter-search" placeholder="검색 (제목, 목적지...)">

      <button class="btn btn-secondary" onclick="resetFilters()" style="background: #ddd; color: #333;">
        필터 초기화
      </button>
    </div>

    <!-- 테이블 -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>신청번호</th>
            <th>제목</th>
            <th>출장유형</th>
            <th>목적지</th>
            <th>기간</th>
            <th>신청자</th>
            <th>상태</th>
            <th>우선순위</th>
          </tr>
        </thead>
        <tbody id="trip-table-body">
          <tr>
            <td colspan="8" class="loading">데이터 로딩중...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="scripts/business-trip.js"></script>
  <script>
    // API 인스턴스 (Mock 모드로 시작, Notion 연동 시 false로 변경)
    const api = new BusinessTripAPI({ useMock: false });
    const utils = BusinessTripUtils;

    let allTrips = [];

    // 초기 로딩
    document.addEventListener('DOMContentLoaded', loadTrips);

    // 필터 이벤트
    document.getElementById('filter-status').addEventListener('change', applyFilters);
    document.getElementById('filter-type').addEventListener('change', applyFilters);
    document.getElementById('filter-search').addEventListener('input', debounce(applyFilters, 300));

    // 데이터 로딩
    async function loadTrips() {
      try {
        const result = await api.getAll();
        if (result.success) {
          allTrips = result.data;
          updateKPIs();
          renderTable(allTrips);
        } else {
          showError('데이터 로딩 실패');
        }
      } catch (error) {
        console.error('Load error:', error);
        showError('데이터 로딩 중 오류 발생');
      }
    }

    // KPI 업데이트
    function updateKPIs() {
      const total = allTrips.length;
      const pending = allTrips.filter(t => t.status === '신청완료').length;
      const approved = allTrips.filter(t => t.status === '승인').length;

      // 진행중: 승인되었고 오늘이 출장 기간 내인 경우
      const today = new Date().toISOString().split('T')[0];
      const ongoing = allTrips.filter(t => {
        return t.status === '승인' && t.startDate <= today && t.endDate >= today;
      }).length;

      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-pending').textContent = pending;
      document.getElementById('kpi-approved').textContent = approved;
      document.getElementById('kpi-ongoing').textContent = ongoing;
    }

    // 테이블 렌더링
    function renderTable(trips) {
      const tbody = document.getElementById('trip-table-body');

      if (trips.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <p>출장신청서가 없습니다.</p>
              <a href="/business-trip/create" class="btn btn-primary">새 출장 신청</a>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = trips.map(trip => {
        const days = utils.calculateDays(trip.startDate, trip.endDate);
        const startFormatted = utils.formatDate(trip.startDate, 'MM/DD(ddd)');
        const endFormatted = utils.formatDate(trip.endDate, 'MM/DD(ddd)');
        const period = `${startFormatted} ~ ${endFormatted} (${days}일)`;

        const statusClass = getStatusClass(trip.status);
        const priorityClass = getPriorityClass(trip.priority);

        const vacancyBadge = trip.hasVacancy
          ? '<span class="vacancy-badge">인력공백</span>'
          : '';

        return `
          <tr>
            <td>${trip.requestNumber || '-'}</td>
            <td>
              <a href="/business-trip/detail?id=${trip.id}" class="trip-link">
                ${escapeHtml(trip.title)}
              </a>
              ${vacancyBadge}
            </td>
            <td>${trip.tripType || '-'}</td>
            <td>${trip.destination || '-'}</td>
            <td>${period}</td>
            <td>${trip.applicant || '-'}</td>
            <td><span class="badge ${statusClass}">${trip.status}</span></td>
            <td><span class="badge ${priorityClass}">${trip.priority || '보통'}</span></td>
          </tr>
        `;
      }).join('');
    }

    // 필터 적용
    function applyFilters() {
      const status = document.getElementById('filter-status').value;
      const type = document.getElementById('filter-type').value;
      const search = document.getElementById('filter-search').value.toLowerCase();

      let filtered = allTrips;

      if (status) {
        filtered = filtered.filter(t => t.status === status);
      }

      if (type) {
        filtered = filtered.filter(t => t.tripType === type);
      }

      if (search) {
        filtered = filtered.filter(t =>
          (t.title && t.title.toLowerCase().includes(search)) ||
          (t.destination && t.destination.toLowerCase().includes(search)) ||
          (t.applicant && t.applicant.toLowerCase().includes(search)) ||
          (t.requestNumber && t.requestNumber.toLowerCase().includes(search))
        );
      }

      renderTable(filtered);
    }

    // 필터 초기화
    function resetFilters() {
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-type').value = '';
      document.getElementById('filter-search').value = '';
      renderTable(allTrips);
    }

    // 유틸리티
    function getStatusClass(status) {
      const map = {
        '작성중': 'badge-draft',
        '신청완료': 'badge-submitted',
        '승인': 'badge-approved',
        '반려': 'badge-rejected',
        '완료': 'badge-completed'
      };
      return map[status] || 'badge-draft';
    }

    function getPriorityClass(priority) {
      const map = {
        '긴급': 'badge-urgent',
        '높음': 'badge-high',
        '보통': 'badge-normal',
        '낮음': 'badge-low'
      };
      return map[priority] || 'badge-normal';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function showError(message) {
      document.getElementById('trip-table-body').innerHTML = `
        <tr>
          <td colspan="8" class="empty-state">
            <p style="color: var(--danger);">${message}</p>
          </td>
        </tr>
      `;
    }
  </script>
</body>
</html>
