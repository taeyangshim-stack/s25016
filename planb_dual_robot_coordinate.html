<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlanB - 듀얼 로봇 좌표계 구조 분석</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e17;color:#c8d6e5;font-family:'Segoe UI',sans-serif;line-height:1.7;padding:24px}
.container{max-width:960px;margin:0 auto}
h1{color:#00d4ff;font-size:1.6em;border-bottom:2px solid #1a2744;padding-bottom:12px;margin-bottom:24px}
h2{color:#ffd700;font-size:1.2em;margin:28px 0 12px;padding:8px 12px;background:#111827;border-left:3px solid #ffd700;border-radius:4px}
h3{color:#00d4ff;font-size:1.05em;margin:20px 0 8px}
p,li{font-size:0.95em;margin-bottom:8px}
ul{padding-left:24px}
.card{background:#111827;border:1px solid #1e3a5f;border-radius:8px;padding:20px;margin:16px 0}
.card-title{color:#00d4ff;font-weight:700;font-size:1.05em;margin-bottom:12px}
table{width:100%;border-collapse:collapse;margin:12px 0;font-size:0.9em}
th{background:#1a2744;color:#ffd700;padding:8px 12px;text-align:left;border:1px solid #1e3a5f}
td{padding:8px 12px;border:1px solid #1e3a5f}
tr:nth-child(even){background:#0d1320}
.ok{color:#2ecc71}.ng{color:#ff4757}.warn{color:#ffa502}
code{background:#1a2744;color:#ff6b81;padding:2px 6px;border-radius:3px;font-size:0.9em}
pre{background:#0d1320;border:1px solid #1e3a5f;border-radius:6px;padding:16px;overflow-x:auto;font-size:0.85em;line-height:1.5;color:#a0d2db;margin:12px 0}
.diagram{background:#0d1320;border:1px solid #1e3a5f;border-radius:6px;padding:20px;margin:12px 0;font-family:'Courier New',monospace;font-size:0.82em;line-height:1.4;white-space:pre;overflow-x:auto;color:#7fdbca}
.highlight{background:#1a3a2e;border-left:3px solid #2ecc71;padding:12px 16px;margin:12px 0;border-radius:4px}
.warning{background:#3a2a1a;border-left:3px solid #ffa502;padding:12px 16px;margin:12px 0;border-radius:4px}
.critical{background:#3a1a1a;border-left:3px solid #ff4757;padding:12px 16px;margin:12px 0;border-radius:4px}
.meta{color:#636e72;font-size:0.85em;margin-bottom:20px}
.back{display:inline-block;color:#00d4ff;text-decoration:none;margin-bottom:16px;font-size:0.9em}
.back:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="container">
<a href="index.html" class="back">&larr; 메인 대시보드로 돌아가기</a>
<h1>PlanB - 듀얼 로봇 좌표계 구조 분석</h1>
<p class="meta">S25016 34bay 자동용접 | 문서 작성: 2026-02-21 | RAPID v1.9.48 / v1.9.43</p>

<h2>1. 물리적 구성</h2>
<div class="card">
<div class="card-title">갠트리 + 듀얼 로봇 배치</div>
<div class="diagram">
              Floor 좌표계 (WobjFloor)
              원점: 바닥면 기준
              X: 갠트리 이동 방향 (Beam 따라)
              Y: 갠트리 횡방향
              Z: 상향 (바닥→천장)

  갠트리 HOME 위치 (Floor 좌표): [9500, 5300, 2100]

                        R축 센터
                          |
         Robot1 Base      |      Robot2 Base
          (-488mm)        |       (+488mm)
              |           |           |
              v           v           v
  ========[ROB1]=======[ R ]=======[ROB2]========  &lt;- 갠트리 빔 (Z=2100)
              |                       |
              |   (거꾸로 매달림)      |   (거꾸로 매달림)
              v                       v
           tWeld1                  tWeld2
              \                     /
               \                   /
                \                 /
                 v               v
                  ---- TCP ----        &lt;- R축 센터, Z=1100 (1000mm 아래)
                   만남점 (용접점)

  Floor Z=2100 ─── 갠트리 빔
  Floor Z=1100 ─── TCP 만남점 (빔에서 1000mm 아래)
  Floor Z=0    ─── 바닥
</div>
</div>

<h2>2. Robot1 좌표계 (갠트리 연동)</h2>
<div class="card">
<div class="card-title">Robot1 + GantryRob = 하나의 연동 로봇</div>
<ul>
<li><strong>MOC.cfg 설정:</strong> <code>base_frame_coordinated "GantryRob"</code></li>
<li><strong>Base 위치:</strong> R축 센터에서 488mm 오프셋 (LOCKED_EAW_11 length=0.488)</li>
<li><strong>좌표계 원점:</strong> 로봇 베이스가 아닌 <strong>R축 센터</strong>에 위치</li>
<li><strong>base_frame_orient:</strong> <code>[1, 0, 0, ~0]</code> (항등, GantryRob이 회전 처리)</li>
</ul>

<h3>Robot1 좌표축 방향 (vs Floor)</h3>
<table>
<tr><th>Robot1 축</th><th>Floor 좌표 방향</th><th>설명</th></tr>
<tr><td>X축</td><td>Floor -X 방향</td><td>로봇 좌측 (통상과 다름: 정면이 Y축)</td></tr>
<tr><td>Y축</td><td>Floor -Y 방향</td><td>로봇 정면 (통상 X인데 여기서는 Y)</td></tr>
<tr><td>Z축</td><td>Floor <strong>-Z</strong> 방향</td><td>거꾸로 매달림 &rarr; Z 부호 반전</td></tr>
</table>

<div class="highlight">
<strong>TCP [0, 0, 1000] 의미:</strong><br>
Robot1 좌표계에서 Z방향으로 1000mm = Floor 기준 <strong>아래로</strong> 1000mm<br>
&rarr; Floor Z = 2100 - 1000 = <strong>1100mm</strong> (R축 센터 수직 하방)
</div>

<h3>WobjFloor 정의 (Robot1용)</h3>
<pre>
PERS wobjdata WobjFloor := [FALSE, TRUE, "",
    [[-9500, 5300, 2100], [0, 1, 0, 0]],   ! uframe: 갠트리HOME + 180&deg; Y회전
    [[0, 0, 0], [1, 0, 0, 0]]];            ! oframe: 항등

! 회전 [0, 1, 0, 0] = 180&deg; Y축 회전
!   Robot1 좌표 &rarr; Floor 좌표 변환:
!   Floor_X = -(Rob1_X) + 9500
!   Floor_Y = Rob1_Y + 5300
!   Floor_Z = -(Rob1_Z) + 2100
</pre>
</div>

<h2>3. Robot2 좌표계 (갠트리 미연동)</h2>
<div class="card">
<div class="card-title">Robot2 = 독립 로봇 (갠트리와 계산으로 연동)</div>

<div class="critical">
<strong>ABB 제약:</strong> Robot2는 GantryRob과 <code>base_frame_coordinated</code> 설정 불가.<br>
RAPID 코드에서 계산으로 좌표 변환을 구현해야 함.
</div>

<ul>
<li><strong>MOC.cfg 설정:</strong> <code>base_frame_orient [0, 0.707107, 0.707107, 0]</code> (base_frame_coordinated 없음)</li>
<li><strong>Base 위치:</strong> R축 센터에서 488mm 오프셋 (Robot1 반대편)</li>
<li><strong>좌표계 원점:</strong> 로봇 <strong>베이스</strong>에 위치 (Robot1과 다름!)</li>
<li><strong>Robot1과 마주봄:</strong> Robot1이 -Y를 보면, Robot2는 +Y를 봄</li>
</ul>

<h3>Robot2 좌표축 방향 (vs Floor)</h3>
<table>
<tr><th>Robot2 축</th><th>Floor 좌표 방향</th><th>설명</th></tr>
<tr><td>X축</td><td>Floor +X 방향</td><td>Floor과 동일</td></tr>
<tr><td>Y축</td><td>Floor +Y 방향</td><td>로봇 정면, Floor과 동일</td></tr>
<tr><td>Z축</td><td>Floor <strong>+Z</strong> 방향</td><td>물리적으로 거꾸로지만 좌표계는 <strong>상향</strong></td></tr>
</table>

<div class="highlight">
<strong>핵심 차이:</strong> Robot2는 물리적으로 거꾸로 매달려 있지만,
좌표계 방향은 Floor 좌표계와 <strong>동일</strong>합니다.
(Robot1은 Z가 반전, Robot2는 Z가 동일)
</div>

<h3>Robot2 TCP [0, 488, -1000] 의미</h3>
<pre>
Robot2 좌표계 기준 (원점 = Robot2 베이스):
  X = 0      : 좌우 중립
  Y = 488    : 정면(+Y) 방향 488mm = R축 센터 방향
  Z = -1000  : 아래로 1000mm (Floor Z와 동일 방향이므로 -가 아래)

Floor 좌표 기준:
  X = 9500 (갠트리 X)
  Y = 4812 + 488 = 5300 (Robot2 베이스 Y + 488mm = R축 센터 Y)
  Z = 1100 (2100 - 1000 = TCP 높이)
</pre>
</div>

<h2>4. 좌표계 차이 원인 분석</h2>
<div class="card">
<div class="card-title">CRobT(\WObj:=WobjFloor) 측정 결과 (2026-02-21)</div>
<table>
<tr><th></th><th>Robot1 tWeld1</th><th>Robot2 tWeld2</th><th>차이</th><th>원인</th></tr>
<tr><td><strong>X</strong></td><td>9500.002</td><td>9500.001</td><td class="ok">0.001mm</td><td>정상 (일치)</td></tr>
<tr><td><strong>Y</strong></td><td>5300.044</td><td>4812.008</td><td class="ng">488mm</td><td>Robot1: R축센터 기준 / Robot2: 베이스 기준</td></tr>
<tr><td><strong>Z</strong></td><td>1100.018</td><td>3100.006</td><td class="ng">2000mm</td><td>Robot1: Z반전 / Robot2: Z동일</td></tr>
</table>

<h3>Y 차이 (488mm)</h3>
<div class="warning">
<strong>Robot1:</strong> 좌표 원점 = R축 센터 (베이스에서 488mm)<br>
<strong>Robot2:</strong> 좌표 원점 = 베이스 (R축 센터에서 488mm)<br>
&rarr; 동일 물리점이지만 기준점이 다르므로 Y값이 488mm 차이
</div>

<h3>Z 차이 (2000mm)</h3>
<div class="warning">
<strong>Robot1:</strong> Z축이 Floor과 <strong>반대</strong> &rarr; Floor Z = 2100 - Rob1_Z<br>
<strong>Robot2:</strong> Z축이 Floor과 <strong>동일</strong> &rarr; Floor Z = Rob2_base_Z + Rob2_Z<br>
&rarr; 같은 WobjFloor 적용 시 Z에 2000mm 차이 발생
</div>

<h3>MOC.cfg 관련 파라미터</h3>
<pre>
! GantryRob 5번째 축 (R축 바디에서 로봇 베이스까지의 오프셋)
LOCKED_EAW_11: length = 0.488 (488mm)
               theta_home_position = -3.14159 (-180&deg;)
               lock_joint_in_hardware / ipol / servo (고정 축)

! Robot1 base frame
ROB_1: base_frame_orient = [1, 0, 0, ~0]  (항등)
       base_frame_coordinated = "GantryRob"

! Robot2 base frame
ROB_2: base_frame_orient = [~0, 0.707107, 0.707107, ~0]
       (base_frame_coordinated 없음!)
</pre>
</div>

<h2>5. WobjFloor_Rob2 보정 계산</h2>
<div class="card">
<div class="card-title">Robot2 전용 Floor 좌표계 보정</div>

<h3>현재 (잘못된 값)</h3>
<pre>
PERS wobjdata WobjFloor_Rob2 := [FALSE, TRUE, "",
    [[-9500, 5300, 2100], [1, 0, 0, 0]],    ! 항등 회전 (오류!)
    [[0, 0, 0], [1, 0, 0, 0]]];
</pre>

<h3>수학적 보정</h3>
<pre>
두 로봇 "world" 프레임 오프셋 (측정 기반):
  p_world_1 - p_world_2 = (0, 488, 2000)

WobjFloor_Rob2 보정:
  회전: WobjFloor과 동일 = [0, 1, 0, 0] (180&deg; Y축)
  위치: t_floor - world_offset
      = [-9500, 5300, 2100] - [0, -488, -2000]
      = [-9500, 4812, 100]
</pre>

<h3>보정된 값</h3>
<pre>
PERS wobjdata WobjFloor_Rob2 := [FALSE, TRUE, "",
    [[-9500, 4812, 100], [0, 1, 0, 0]],     ! Y-488, Z-2000, 180&deg; Y회전
    [[0, 0, 0], [1, 0, 0, 0]]];
</pre>

<div class="highlight">
<strong>검증 필요:</strong> 이 값은 갠트리 HOME (R=0) 기준 측정에서 도출.<br>
R축 회전 시에도 정상 동작하는지 추가 검증 필요 (R=45&deg;, R=90&deg; 등).
</div>
</div>

<h2>6. 488mm 오프셋 문제 — 원인 및 수정 (2026-02-21)</h2>
<div class="card">
<div class="card-title">문제: UI에서 Robot2 Y = 4812 (정상값 5300에서 488mm 부족)</div>

<h3>원인 추적</h3>
<p>UI에 TCP 값을 제공하는 실제 코드는 <strong>TASK7</strong>의 <code>CalcCurrentTcp(\R2)</code> (Static.mod):</p>
<pre>
! TASK7 Static.mod — UI 데이터 소스 (TASK8 아님!)
pR2 := CRobT(\taskname:="T_ROB2"\Tool:=tWeld2\WObj:=wobj0);
gantryAngle := MonitorPosition.monExt.eax_d;

nRotX := (pR2.trans.x * Cos(gantryAngle)) - (pR2.trans.y * Sin(gantryAngle));
nRotY := (pR2.trans.x * Sin(gantryAngle)) + (pR2.trans.y * Cos(gantryAngle));

result.trans.x := GantryX + nRotX;
result.trans.y := GantryY - nRotY;    &larr; 여기서 문제 발생
result.trans.z := GantryZ + pR2.trans.z;
</pre>

<div class="critical">
<strong>근본 원인:</strong><br>
<code>CRobT(T_ROB2, tWeld2, wobj0)</code>의 <code>pR2.y = 488</code>은
Robot2 베이스에서 R-축 중심까지의 거리(LOCKED_EAW_11 = 488mm).<br>
이 값을 <strong>R-축 중심 기준으로 변환하지 않고</strong> 그대로 회전 계산에 사용하여,<br>
<code>result.y = 5300 - 488 = 4812</code>가 됨.
</div>

<h3>수정 내용</h3>
<pre>
! 수정 전 (오류)
nRotX := (pR2.trans.x * Cos(R)) - (pR2.trans.y * Sin(R));
nRotY := (pR2.trans.x * Sin(R)) + (pR2.trans.y * Cos(R));

! 수정 후 (정상) — pR2.y에서 488mm 차감하여 R-축 중심 기준으로 변환
nRotX := (pR2.trans.x * Cos(R)) - ((pR2.trans.y - 488) * Sin(R));
nRotY := (pR2.trans.x * Sin(R)) + ((pR2.trans.y - 488) * Cos(R));
</pre>

<div class="highlight">
<strong>왜 488을 빼는가?</strong><br>
pR2.y에는 Robot2 베이스→R축 중심 거리 488mm가 포함됨.<br>
회전 공식은 R-축 중심을 기준으로 해야 하므로, 488mm를 빼서<br>
"R-축 중심 기준 오프셋"으로 변환한 뒤 회전을 적용해야 정확함.<br>
<br>
<strong>Robot1은 왜 정상?</strong><br>
Robot1은 <code>WobjFloor</code>로 직접 CRobT를 호출하며, 갠트리 조정(coordinated)이므로<br>
ABB 컨트롤러가 LOCKED_EAW_11 오프셋을 자동 처리함.
</div>
</div>

<h2>7. 수정 후 검증 결과 (2026-02-21)</h2>
<div class="card">
<div class="card-title">R-축 회전 각도별 TCP 비교</div>
<table>
<tr><th>R-축</th><th>Robot1 X</th><th>Robot1 Y</th><th>Robot2 X</th><th>Robot2 Y</th><th>XY 차이</th><th>상태</th></tr>
<tr><td><strong>0&deg;</strong></td><td>9500.00</td><td>5300.04</td><td>9500.00</td><td>5300.00</td><td>0.04mm</td><td class="ok">PASS</td></tr>
<tr><td><strong>30&deg;</strong></td><td>9499.99</td><td>5300.03</td><td>9500.00</td><td>5300.00</td><td>0.03mm</td><td class="ok">PASS</td></tr>
<tr><td><strong>90&deg;</strong></td><td>9499.97</td><td>5300.00</td><td>9500.00</td><td>5300.00</td><td>0.03mm</td><td class="ok">PASS</td></tr>
<tr><td><strong>-45&deg;</strong></td><td>9500.03</td><td>5300.03</td><td>9500.00</td><td>5300.00</td><td>0.04mm</td><td class="ok">PASS</td></tr>
</table>

<div class="highlight">
<strong>검증 완료:</strong> 모든 R-축 각도에서 Robot1/Robot2 TCP가 <strong>0.04mm 이내</strong>로 일치.<br>
TCP가 R-축 중심 (9500, 5300)에 고정되어, 회전해도 위치 변동 없음 확인.
</div>

<h3>수정 파일 목록</h3>
<table>
<tr><th>파일</th><th>변경</th><th>커밋</th></tr>
<tr><td>TASK7/PROGMOD/Static.mod</td><td>CalcCurrentTcp: pR2.y - 488 보정 추가</td><td><code>5d106a6</code></td></tr>
<tr><td>TASK8/PROGMOD/Head_Data.mod</td><td>wobjRotCtr2 origin [488,0,0]&rarr;[0,0,0]</td><td><code>c865acc</code></td></tr>
</table>
</div>

<h2>8. UI 표시값 현황 (수정 후)</h2>
<div class="card">
<div class="card-title">상위 시스템(UI)에서 수신하는 TCP 값</div>
<table>
<tr><th></th><th>Robot1</th><th>Robot2</th><th>상태</th></tr>
<tr><td><strong>X (mm)</strong></td><td>9500.00</td><td>9500.00</td><td class="ok">정상</td></tr>
<tr><td><strong>Y (mm)</strong></td><td>5300.04</td><td>5300.00</td><td class="ok">정상 (수정 완료)</td></tr>
<tr><td><strong>Z (mm)</strong></td><td>1100.02</td><td>1100.00</td><td class="ok">정상</td></tr>
<tr><td><strong>Rx (&deg;)</strong></td><td>90.00</td><td>-90.00</td><td class="warn">부호 반전 (물리적 반전 반영, 정상)</td></tr>
<tr><td><strong>Ry (&deg;)</strong></td><td>-80.00</td><td>-80.00</td><td class="ok">동일</td></tr>
<tr><td><strong>Rz (&deg;)</strong></td><td>-0.00</td><td>0.00</td><td class="ok">동일</td></tr>
</table>
</div>

</div>
</body>
</html>
