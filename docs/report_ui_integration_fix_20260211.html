<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>S25016 PlanB 상위제어 UI 연동 오류 조치 보고서</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', -apple-system, sans-serif; margin: 0; padding: 40px 50px; color: #2d3748; line-height: 1.9; font-size: 14px; background: #f8fafc; }
  .container { max-width: 1100px; margin: 0 auto; background: #fff; padding: 50px 60px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

  h1 { color: #1a365d; border-bottom: 3px solid #3182ce; padding-bottom: 12px; font-size: 24px; margin-bottom: 8px; letter-spacing: -0.5px; }
  .subtitle { color: #718096; font-size: 14px; margin-bottom: 35px; }
  h2 { color: #fff; background: #2b6cb0; padding: 10px 18px; border-radius: 6px; margin-top: 45px; font-size: 16px; letter-spacing: -0.3px; }
  h3 { color: #2c5282; margin-top: 30px; font-size: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; }
  h4 { color: #4a5568; margin-top: 22px; font-size: 14px; }

  table { border-collapse: collapse; width: 100%; margin: 12px 0 20px; font-size: 13px; }
  th { background: #edf2f7; color: #2d3748; padding: 10px 14px; text-align: left; font-weight: 600; border: 1px solid #e2e8f0; }
  td { border: 1px solid #e2e8f0; padding: 9px 14px; vertical-align: top; }
  tr:hover { background: #f7fafc; }

  .box { border-radius: 8px; padding: 16px 20px; margin: 14px 0; }
  .box-error { background: #fff5f5; border-left: 4px solid #e53e3e; }
  .box-fix { background: #f0fff4; border-left: 4px solid #38a169; }
  .box-info { background: #ebf8ff; border-left: 4px solid #3182ce; }
  .box-warn { background: #fffaf0; border-left: 4px solid #dd6b20; }
  .box-grey { background: #f7fafc; border-left: 4px solid #a0aec0; }
  .box strong { display: block; margin-bottom: 4px; }

  code { background: #edf2f7; padding: 2px 7px; border-radius: 4px; font-family: 'Consolas', 'D2Coding', monospace; font-size: 12.5px; color: #c53030; }
  pre { background: #1a202c; color: #e2e8f0; padding: 18px 22px; border-radius: 8px; overflow-x: auto; font-size: 12px; line-height: 1.7; margin: 12px 0; }
  .tag { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .tag-error { background: #fed7d7; color: #c53030; }
  .tag-fix { background: #c6f6d5; color: #276749; }
  .tag-new { background: #bee3f8; color: #2a4365; }
  .tag-warn { background: #fefcbf; color: #975a16; }
  .field-desc { font-size: 12px; color: #718096; line-height: 1.5; }
  ul, ol { margin: 6px 0; padding-left: 22px; }
  li { margin: 5px 0; }

  /* 요약 카드 */
  .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 20px 0 30px; }
  .summary-card { border-radius: 10px; padding: 20px; text-align: center; }
  .summary-card .number { font-size: 36px; font-weight: 700; line-height: 1.2; }
  .summary-card .label { font-size: 13px; color: #718096; margin-top: 4px; }
  .card-error { background: #fff5f5; border: 1px solid #feb2b2; }
  .card-error .number { color: #e53e3e; }
  .card-fix { background: #f0fff4; border: 1px solid #9ae6b4; }
  .card-fix .number { color: #38a169; }
  .card-file { background: #ebf8ff; border: 1px solid #90cdf4; }
  .card-file .number { color: #3182ce; }

  /* 헤더 정보 */
  .header-table { border: none; background: #f7fafc; border-radius: 8px; overflow: hidden; }
  .header-table td { border: none; padding: 7px 18px; font-size: 13px; }
  .header-table td:first-child { font-weight: 600; color: #4a5568; width: 120px; background: #edf2f7; }

  /* 다이어그램 */
  .diagram { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 22px; margin: 14px 0; font-family: 'Consolas', 'D2Coding', monospace; font-size: 12px; line-height: 1.7; white-space: pre; overflow-x: auto; }

  /* 서명 */
  .signature { margin-top: 50px; padding-top: 20px; border-top: 2px solid #e2e8f0; color: #718096; font-size: 13px; }

  /* 에러 그룹 카드 */
  .error-group { border: 1px solid #e2e8f0; border-radius: 8px; margin: 14px 0; overflow: hidden; }
  .error-group-header { background: #f7fafc; padding: 12px 18px; font-weight: 600; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .error-group-body { padding: 16px 18px; }

  /* 스텝 인디케이터 */
  .step { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: #3182ce; color: #fff; font-size: 13px; font-weight: 700; margin-right: 8px; flex-shrink: 0; }

  /* 비교 레이아웃 */
  .compare { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 14px 0; }
  .compare-before { background: #fff5f5; border-radius: 8px; padding: 16px; border: 1px solid #feb2b2; }
  .compare-after { background: #f0fff4; border-radius: 8px; padding: 16px; border: 1px solid #9ae6b4; }
  .compare-title { font-weight: 600; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; }
  .compare-before .compare-title { color: #c53030; }
  .compare-after .compare-title { color: #276749; }

  @media print {
    body { background: #fff; padding: 20px; }
    .container { box-shadow: none; padding: 0; }
    h2 { break-after: avoid; }
    table { break-inside: avoid; }
  }
</style>
</head>
<body>
<div class="container">

<h1>S25016 PlanB 상위제어 UI 연동 오류 조치 보고서</h1>
<div class="subtitle">삼성중공업 거제조선소 34bay 자동용접 로봇 시스템 | B라인 PlanB</div>

<table class="header-table">
<tr><td>컨트롤러</td><td>ABB IRC5 / RobotWare 6.16.1028 (RobotStudio 가상 컨트롤러)</td></tr>
<tr><td>상위 UI</td><td>SubAssemblyWeldingSystem_BLine_PlanB (디파인시스템 / DF.SubAssembly.MainGui)</td></tr>
<tr><td>작성일</td><td>2026-02-11</td></tr>
<tr><td>작성자</td><td>심태양 / 에스피시스템스</td></tr>
</table>

<!-- ============================================ -->
<!-- 핵심 요약 -->
<!-- ============================================ -->

<h2>핵심 요약</h2>

<div class="summary-grid">
  <div class="summary-card card-error">
    <div class="number">9건</div>
    <div class="label">RAPID 심볼 미발견 에러</div>
  </div>
  <div class="summary-card card-fix">
    <div class="number">9건</div>
    <div class="label">전체 해결 완료</div>
  </div>
  <div class="summary-card card-file">
    <div class="number">5개</div>
    <div class="label">변경/신규 파일</div>
  </div>
</div>

<div class="box box-error">
  <strong>문제</strong>
  상위제어 UI가 PlanB 컨트롤러에 접속 시, 9개의 RAPID 변수를 찾지 못해 초기화 실패.
</div>
<div class="box box-info">
  <strong>원인</strong>
  PlanB 개발 시 태스크를 10개 &rarr; 8개로 축소하며, UI가 참조하는 백그라운드 모니터링(T_BG)과 용접 파라미터(T_Teaching) 태스크의 변수가 누락됨.
</div>
<div class="box box-fix">
  <strong>조치</strong>
  PlanA 레퍼런스 코드 기반으로 누락 태스크/변수를 PlanB에 이식. 기존 TASK1/TASK2 로직 영향 없음.
</div>

<!-- ============================================ -->
<h2>1. 배경 및 연동 구조</h2>
<!-- ============================================ -->

<p>
2대의 ABB IRB 1200-5/0.9 로봇이 4축 갠트리(X, Y, Z, R) 위에서 동시 용접을 수행하는 시스템입니다.
상위 UI는 <strong>ABB PC SDK</strong>를 통해 컨트롤러의 RAPID 변수에 직접 접근하여 실시간 모니터링과 제어를 수행합니다.
</p>

<div class="diagram">
+---------------------------+       ABB PC SDK        +---------------------------+
|     상위제어 UI (PC)      | &lt;=====================&gt; |    ABB IRC5 컨트롤러      |
+---------------------------+    Ethernet TCP/IP       +---------------------------+
|                           |                          |                           |
|  갠트리/로봇 위치 표시    | &lt;-- T_BG.Static.       |  TASK7(T_BG) Static.mod   |
|  모터 토크 그래프         |     MonitorPosition      |  - 위치/토크/용접상태     |
|  용접 상태 표시           |     nTorques, stWeld1/2  |    실시간 모니터링        |
|                           |                          |                           |
|  워밍업 진행률 표시       | &lt;-- T_Head.Head_Data.  |  TASK8(T_Head)            |
|                           |     nWarmUpCycle          |  - 상위 커맨드 디스패처   |
|                           |                          |                           |
|  용접전압/WFS 표시        | &lt;-- T_Teaching.        |  TASK9(T_Teaching)        |
|  운전자 실시간 보정 입력  | --&gt; Teaching.           |  - 용접 파라미터 계산     |
|                           |     nCurrentTarget*      |    (목표값+실시간보정)    |
|                           |     nRealTime*           |                           |
+---------------------------+                          +---------------------------+

  * UI는 [태스크명].[모듈명].[변수명] 경로로 RAPID 변수를 바인딩
  * 경로가 존재하지 않으면 GenericControllerException 발생
</div>


<!-- ============================================ -->
<h2>2. 에러 현황</h2>
<!-- ============================================ -->

<p>
UI 초기화 시 <strong>9건의 RAPID symbol not found</strong> 에러가 발생하여 정상 연결 불가.<br>
로그 위치: <code>SubAssemblyWeldingSystem_BLine_PlanB/logs/RapidInitFailReport.txt</code>
</p>

<!-- 그룹 1 -->
<div class="error-group">
  <div class="error-group-header">
    <span>그룹 1 &mdash; T_BG (백그라운드 모니터링)</span>
    <span class="tag tag-error">4건</span>
  </div>
  <div class="error-group-body">
    <table>
    <tr><th style="width:60px;">No.</th><th style="width:170px;">UI Key</th><th>RAPID 심볼 경로</th><th style="width:110px;">데이터 타입</th></tr>
    <tr><td>1</td><td>MonRobs</td><td><code>T_BG.Static.MonitorPosition</code></td><td>monRobs RECORD</td></tr>
    <tr><td>2</td><td>CurrentTorque</td><td><code>T_BG.Static.nTorques</code></td><td>num{18} 배열</td></tr>
    <tr><td>3</td><td>WeldDataStatus</td><td><code>T_BG.Static.stWeld1</code></td><td>StatusWeld RECORD</td></tr>
    <tr><td>4</td><td>WeldDataStatus2</td><td><code>T_BG.Static.stWeld2</code></td><td>StatusWeld RECORD</td></tr>
    </table>
    <p style="margin:8px 0 0; color:#718096; font-size:13px;">
      <strong>원인:</strong> PlanB TASK7의 Static.mod에 위치 업데이트 1개 함수만 존재. UI가 필요로 하는 RECORD 정의 및 모니터링 변수가 모두 누락.
    </p>
  </div>
</div>

<!-- 그룹 2 -->
<div class="error-group">
  <div class="error-group-header">
    <span>그룹 2 &mdash; T_Head (상위 제어)</span>
    <span class="tag tag-error">1건</span>
  </div>
  <div class="error-group-body">
    <table>
    <tr><th style="width:60px;">No.</th><th style="width:170px;">UI Key</th><th>RAPID 심볼 경로</th><th style="width:110px;">데이터 타입</th></tr>
    <tr><td>5</td><td>WarmUpPeriod</td><td><code>T_Head.Head_Data.nWarmUpCycle</code></td><td>num</td></tr>
    </table>
    <p style="margin:8px 0 0; color:#718096; font-size:13px;">
      <strong>원인:</strong> PlanA에도 없는 UI 신규 요구 변수. 워밍업 "진행 사이클 카운트"를 표시하기 위한 변수.
    </p>
  </div>
</div>

<!-- 그룹 3 -->
<div class="error-group">
  <div class="error-group-header">
    <span>그룹 3 &mdash; T_Teaching (용접 파라미터)</span>
    <span class="tag tag-error">4건</span>
  </div>
  <div class="error-group-body">
    <table>
    <tr><th style="width:60px;">No.</th><th style="width:170px;">UI Key</th><th>RAPID 심볼 경로</th><th style="width:110px;">데이터 타입</th></tr>
    <tr><td>6</td><td>CurrentTargetVoltage</td><td><code>T_Teaching.Teaching.nCurrentTargetVoltage</code></td><td>num{2} 배열</td></tr>
    <tr><td>7</td><td>CurrentTargetWfs</td><td><code>T_Teaching.Teaching.nCurrentTargetWfs</code></td><td>num{2} 배열</td></tr>
    <tr><td>8</td><td>RealTimeVoltage</td><td><code>T_Teaching.Teaching.nRealTimeVoltage</code></td><td>num{2} 배열</td></tr>
    <tr><td>9</td><td>RealTimeWfs</td><td><code>T_Teaching.Teaching.nRealTimeWfs</code></td><td>num{2} 배열</td></tr>
    </table>
    <p style="margin:8px 0 0; color:#718096; font-size:13px;">
      <strong>원인:</strong> PlanB에 T_Teaching 태스크 자체가 존재하지 않음 (TASK 폴더 없음, SYS.cfg 미등록).
    </p>
  </div>
</div>


<!-- ============================================ -->
<h2>3. 근본 원인: PlanA vs PlanB 태스크 구조 차이</h2>
<!-- ============================================ -->

<h3>3.1 Mechanical Unit Group 구성 차이</h3>

<table>
<tr><th style="width:140px;">항목</th><th>PlanA (실 컨트롤러, RW 6.16.0025)</th><th>PlanB (RobotStudio, RW 6.16.1028)</th></tr>
<tr>
  <td><strong>rob1 그룹</strong></td>
  <td>ROB_1만 (Motion Planner 1)</td>
  <td>ROB_1 + <strong>GantryRob + ELM_X</strong> (갠트리 통합)</td>
</tr>
<tr>
  <td><strong>rob2 그룹</strong></td>
  <td>ROB_2 (Motion Planner 2)</td>
  <td>ROB_2 (Motion Planner 2)</td>
</tr>
<tr>
  <td><strong>Gantry 그룹</strong></td>
  <td>GantryRob_7 + ELM_X (Motion Planner 3)</td>
  <td style="color:#c53030;"><strong>없음</strong> &mdash; rob1에 통합</td>
</tr>
</table>

<div class="box box-info">
  <strong>핵심 차이</strong>
  PlanA는 갠트리가 독립 그룹이므로 <code>T_Gantry</code> 태스크에서 별도 제어. PlanB는 갠트리가 Robot1 외부축에 통합되어 <code>T_ROB1</code>에서 직접 제어.
  이로 인해 PlanB는 T_Gantry 태스크가 불필요해져 전체 태스크를 10개 &rarr; 8개로 축소.
</div>

<h3>3.2 RAPID 태스크 비교</h3>

<table>
<tr>
  <th>TASK</th>
  <th>PlanA (10 태스크)</th>
  <th>PlanB 조치 전 (8 태스크)</th>
  <th>에러</th>
</tr>
<tr><td>1</td><td>T_ROB1 &mdash; Robot1 용접 제어</td><td>T_ROB1 &mdash; Robot1 + 갠트리 통합 제어</td><td>-</td></tr>
<tr><td>2</td><td>T_ROB2 &mdash; Robot2 용접 제어</td><td>T_ROB2 &mdash; Robot2 용접 제어</td><td>-</td></tr>
<tr><td>3~6</td><td colspan="2" style="text-align:center; color:#a0aec0;">(시스템 예약)</td><td>-</td></tr>
<tr>
  <td>7</td>
  <td>T_Gantry &mdash; 갠트리 모션 제어</td>
  <td style="color:#c53030;">T_BG &mdash; Static.mod <strong>1.6KB</strong><br><span class="field-desc">함수 1개만 존재. 모니터링 변수 없음.</span></td>
  <td><span class="tag tag-error">4건</span></td>
</tr>
<tr>
  <td>8</td>
  <td>T_Head &mdash; 상위 커맨드 디스패처</td>
  <td>T_Head &mdash; 동일 (nWarmUpCycle만 누락)</td>
  <td><span class="tag tag-error">1건</span></td>
</tr>
<tr style="background:#fff5f5;">
  <td>9</td>
  <td><strong>T_BG</strong> &mdash; 백그라운드 모니터링<br><span class="field-desc">Static.mod 16KB, 482줄, 프로시저 10+개</span></td>
  <td style="color:#c53030;"><strong>폴더 없음</strong><br><span class="field-desc">삭제됨. 일부 기능만 TASK1에 흡수.</span></td>
  <td><span class="tag tag-error">&uarr; 4건</span></td>
</tr>
<tr style="background:#fff5f5;">
  <td>10</td>
  <td><strong>T_Teaching</strong> &mdash; 용접 파라미터 계산<br><span class="field-desc">Teaching.mod 1.6KB</span></td>
  <td style="color:#c53030;"><strong>폴더 없음</strong><br><span class="field-desc">삭제됨. SYS.cfg에도 미정의.</span></td>
  <td><span class="tag tag-error">4건</span></td>
</tr>
</table>


<!-- ============================================ -->
<h2>4. 에러별 변수 상세 및 용도</h2>
<!-- ============================================ -->

<h3>4.1 MonitorPosition &mdash; 로봇/갠트리 실시간 위치 (monRobs RECORD)</h3>

<p>갠트리 4축 + Robot1/Robot2 6축의 실시간 위치를 하나의 구조체로 UI에 제공합니다.</p>

<table>
<tr><th>필드</th><th>타입</th><th>설명</th></tr>
<tr><td><code>monExt</code></td><td>extjoint</td><td>갠트리 외부축 &mdash; eax_a(X), eax_b(Y), eax_c(Z), eax_d(R). Floor 좌표 변환값.</td></tr>
<tr><td><code>monJoint1</code></td><td>robjoint</td><td>Robot1 조인트 각도 (rax_1~6). CJointT(\TaskName:="T_ROB1")에서 읽기.</td></tr>
<tr><td><code>monJoint2</code></td><td>robjoint</td><td>Robot2 조인트 각도 (rax_1~6). CJointT(\TaskName:="T_ROB2")에서 읽기.</td></tr>
<tr><td><code>monPose1</code></td><td>pose</td><td>Robot1 TCP 위치 (Floor 좌표계). 갠트리 위치 + R축 회전 고려한 절대좌표.</td></tr>
<tr><td><code>monPose2</code></td><td>pose</td><td>Robot2 TCP 위치 (Floor 좌표계). 2R formula 좌표 변환 적용.</td></tr>
</table>

<h3>4.2 nTorques{18} &mdash; 모터 토크 모니터링</h3>

<table>
<tr><th>인덱스</th><th>대상</th><th>상태</th></tr>
<tr><td>{1~6}</td><td>Robot1 축 1~6</td><td><span class="tag tag-warn">주석처리</span> PlanA에서도 비활성</td></tr>
<tr><td>{7~12}</td><td>Robot2 축 1~6</td><td><span class="tag tag-warn">주석처리</span> PlanA에서도 비활성</td></tr>
<tr><td>{13~16}</td><td>갠트리 X, Y, Z, R</td><td><span class="tag tag-fix">활성</span> GetMotorTorque로 실시간 읽기</td></tr>
<tr><td>{17}</td><td>예비</td><td>9E+09 (미사용)</td></tr>
<tr><td>{18}</td><td>Linked Motor X2</td><td><span class="tag tag-fix">활성</span></td></tr>
</table>

<h3>4.3 stWeld1 / stWeld2 &mdash; 용접 상태 추적 (StatusWeld RECORD)</h3>

<table>
<tr><th>필드</th><th>타입</th><th>설명</th></tr>
<tr><td><code>WeldTimeForTotal</code></td><td>num</td><td>전체 사이클 경과 시간 (초)</td></tr>
<tr><td><code>WeldTimeForLine</code></td><td>num</td><td>현재 용접선 경과 시간 (초)</td></tr>
<tr><td><code>WorkingAngle</code></td><td>num</td><td>작업각 (도) &mdash; EulerZYX(\y) 계산</td></tr>
<tr><td><code>TravelAngle</code></td><td>num</td><td>진행각 (도) &mdash; EulerZYX(\z) 계산</td></tr>
<tr><td><code>StatusForArc</code></td><td>num</td><td>아크 상태 (1=ON / 0=OFF)</td></tr>
<tr><td><code>cpm</code></td><td>num</td><td>분당 용접 횟수 (Cuts Per Minute)</td></tr>
<tr><td><code>rpm, nDummy8~10</code></td><td>num</td><td>예비 필드 (향후 확장용)</td></tr>
</table>

<h3>4.4 nWarmUpCycle &mdash; 워밍업 진행 카운트</h3>

<p>PlanA에도 없는 <strong>UI 신규 요구 변수</strong>입니다. 기존 워밍업 관련 변수와의 관계:</p>

<table>
<tr><th>변수</th><th>역할</th><th>상태</th></tr>
<tr><td><code>nWarmUp_Speed</code></td><td>워밍업 속도 (mm/s)</td><td>기존 (값: 10)</td></tr>
<tr><td><code>nWarmUp_Distance</code></td><td>워밍업 거리 (mm)</td><td>기존 (값: 100)</td></tr>
<tr><td><code>nWarmUp_Count</code></td><td>워밍업 <strong>목표</strong> 횟수</td><td>기존 (값: 2)</td></tr>
<tr><td><code>nWarmUpCycle</code></td><td>워밍업 <strong>현재 진행</strong> 횟수</td><td><span class="tag tag-new">신규 추가</span> (초기값: 0)</td></tr>
</table>

<h3>4.5 T_Teaching 변수 4종 &mdash; 실시간 용접 파라미터</h3>

<div class="diagram">
[Lincoln 용접기 #1/#2]
   |  siLn1Current, siLn2Current     (용접전류 감지)
   |  siLn1TouchActive, siLn2TouchActive
   v
+------------------------------------------------------------------+
|  T_Teaching  -  rCurrentTargetUpData()                           |
|                                                                  |
|  용접 중:  목표값 = Welds{현재스텝}.voltage + 운전자 보정값      |
|  비용접:   목표값 = 0                                            |
+------------------------------------------------------------------+
       |  (UI Read)                     ^  (UI Write)
       v                                |
  nCurrentTargetVoltage{2}         nRealTimeVoltage{2}
  nCurrentTargetWfs{2}             nRealTimeWfs{2}
       |                                |
       v                                |
+------------------------------------------------------------------+
|  상위제어 UI                                                     |
|  [화면] 목표전압: 28.5V          [조정] 전압보정: +0.3V          |
|  [화면] 목표WFS:  12.0 m/min     [조정] WFS보정: -0.2 m/min     |
+------------------------------------------------------------------+
</div>

<table>
<tr><th>변수</th><th>방향</th><th>설명</th></tr>
<tr><td><code>nCurrentTargetVoltage{2}</code></td><td>RAPID &rarr; UI</td><td>현재 스텝 기본 전압 + 운전자 보정값 합계. {1}=Robot1, {2}=Robot2.</td></tr>
<tr><td><code>nCurrentTargetWfs{2}</code></td><td>RAPID &rarr; UI</td><td>현재 스텝 Wire Feed Speed + 운전자 보정값 합계.</td></tr>
<tr><td><code>nRealTimeVoltage{2}</code></td><td>UI &rarr; RAPID</td><td>운전자 실시간 전압 보정 입력. 양수=증가, 음수=감소.</td></tr>
<tr><td><code>nRealTimeWfs{2}</code></td><td>UI &rarr; RAPID</td><td>운전자 실시간 WFS 보정 입력.</td></tr>
</table>


<!-- ============================================ -->
<h2>5. 조치 내용</h2>
<!-- ============================================ -->

<!-- 조치 1 -->
<h3><span class="step">1</span> TASK7/Static.mod 전면 교체 <span class="tag tag-fix">4건 해결</span></h3>

<p>PlanA TASK9의 전체 백그라운드 모니터링 코드를 PlanB TASK7에 이식했습니다.</p>

<div class="compare">
  <div class="compare-before">
    <div class="compare-title">변경 전 (PlanB)</div>
    <ul style="font-size:13px; margin:0;">
      <li>1.6 KB (49줄)</li>
      <li>RECORD 정의: 없음</li>
      <li>UI 변수: 없음</li>
      <li>프로시저: 1개 (updateCurrentPosition)</li>
    </ul>
  </div>
  <div class="compare-after">
    <div class="compare-title">변경 후 (PlanA 이식)</div>
    <ul style="font-size:13px; margin:0;">
      <li>~13 KB (480+ 줄)</li>
      <li>RECORD 4종: monRobs, StatusWeld, pointgroup, targetdata</li>
      <li>UI 변수: MonitorPosition, nTorques, stWeld1/2 + 50여 PERS</li>
      <li>프로시저 10개 + 함수 3개</li>
    </ul>
  </div>
</div>

<p><strong>포함된 주요 프로시저:</strong></p>
<table>
<tr><th>프로시저</th><th>기능</th></tr>
<tr><td><code>rReadMotorTorque</code></td><td>갠트리 4축 + ELM_X 모터 토크를 읽어 nTorques 배열에 저장</td></tr>
<tr><td><code>rUpdateCurrentPosition</code></td><td>갠트리/로봇 위치를 읽어 MonitorPosition 구조체 갱신</td></tr>
<tr><td><code>rUpdateWeldStatus</code></td><td>용접 각도/시간/아크 상태 계산 &rarr; stWeld1/stWeld2 갱신</td></tr>
<tr><td><code>rWireTouch1/2</code></td><td>Robot1/Robot2 와이어 터치 감지</td></tr>
<tr><td><code>rNotifyHome</code></td><td>HOME 위치 판정 (0.5mm 이내) &rarr; po03_Home 출력</td></tr>
<tr><td><code>rShockSensorOperation</code></td><td>충격 센서 감시, 자동모드+모터ON 시 에러 로깅</td></tr>
<tr><td><code>rErrorTouch</code></td><td>아크 터치 에러 감지 &rarr; 축별 홈복귀 신호</td></tr>
<tr><td><code>rMacroNo0_1_2 / 3_4</code></td><td>매크로별 용접 시퀀스 관리 (PosHold 타이밍)</td></tr>
</table>

<div class="box box-info">
  <strong>PlanA 대비 수정 사항 (1곳)</strong>
  <code>rUpdateCurrentPosition()</code>에서 갠트리 위치 읽기를
  <code>CJointT(\TaskName:="T_Gantry")</code> &rarr; <code>CJointT(\TaskName:="T_Rob1")</code>로 변경.
  PlanB에서는 갠트리가 Robot1 외부축에 통합되어 있으므로 T_Rob1의 extax에서 갠트리 위치를 읽어야 합니다.
  나머지 코드는 PlanA 원본 그대로 유지.
</div>

<!-- 조치 2 -->
<h3><span class="step">2</span> TASK8/Head_Data.mod 변수 추가 <span class="tag tag-fix">1건 해결</span></h3>

<pre>
! Head_Data.mod - 워밍업 관련 변수 영역 (Line 609~612)
PERS num nWarmUp_Speed:=10;       ! 기존: 워밍업 속도
PERS num nWarmUp_Distance:=100;   ! 기존: 워밍업 거리
PERS num nWarmUp_Count:=2;        ! 기존: 목표 횟수
PERS num nWarmUpCycle:=0;         ! <strong>추가:</strong> 현재 진행 사이클 (UI 표시용)
</pre>

<!-- 조치 3 -->
<h3><span class="step">3</span> TASK9(T_Teaching) 신규 생성 <span class="tag tag-new">4건 해결</span></h3>

<p><strong>디렉토리 구조:</strong></p>
<pre>
RAPID/TASK9/                    &lt;-- 신규 생성
  PROGMOD/Teaching.mod          &lt;-- PlanA TASK10 기반 이식
  SYSMOD/user.sys               &lt;-- 기본 시스템 모듈
</pre>

<p><strong>Teaching.mod 핵심 로직:</strong></p>
<pre>
PROC rCurrentTargetUpData()
    ! Robot1: 용접전류 감지 OR 아크ON 시 목표값 계산
    IF (siLn1Current=1 AND siLn1TouchActive=0) OR bArc_On{1}=TRUE THEN
        nCurrentTargetVoltage{1} := Welds1{nRunningStep{1}}.voltage
                                    + nRealTimeVoltage{1};
        nCurrentTargetWfs{1}     := Welds1{nRunningStep{1}}.wfs
                                    + nRealTimeWfs{1};
    ELSE
        nCurrentTargetVoltage{1} := 0;
        nCurrentTargetWfs{1}     := 0;
    ENDIF
    ! Robot2: 동일 로직 (인덱스 {2}, Welds2 참조)
    ...
ENDPROC
</pre>

<p><strong>SYS.cfg 태스크 등록:</strong></p>
<pre>
! CAB_TASKS 섹션 - T_Head 다음에 추가
-Name "T_Teaching" -TrustLevel "None" -UseMechanicalUnitGroup "rob1"
</pre>

<div class="box box-grey">
PlanA에서는 T_Teaching이 Gantry 그룹에 할당되어 있으나, PlanB에는 별도 Gantry 그룹이 없으므로 <code>rob1</code> 그룹에 할당.
T_Teaching은 모션이 아닌 PERS 변수 계산만 수행하므로 그룹 할당은 동작에 영향 없음.
</div>


<!-- ============================================ -->
<h2>6. 변경 파일 종합</h2>
<!-- ============================================ -->

<table>
<tr><th>#</th><th>파일 경로</th><th>유형</th><th>변경 내용</th><th>해결 에러</th></tr>
<tr>
  <td>1</td>
  <td><code>TASK7/PROGMOD/Static.mod</code></td>
  <td><span class="tag tag-fix">교체</span></td>
  <td>PlanA TASK9 전체 코드 이식 (RECORD 4종 + PERS 50개 + 프로시저 13개)</td>
  <td>#1~4</td>
</tr>
<tr>
  <td>2</td>
  <td><code>TASK8/PROGMOD/Head_Data.mod</code></td>
  <td><span class="tag tag-fix">1행 추가</span></td>
  <td><code>PERS num nWarmUpCycle:=0;</code></td>
  <td>#5</td>
</tr>
<tr>
  <td>3</td>
  <td><code>TASK9/PROGMOD/Teaching.mod</code></td>
  <td><span class="tag tag-new">신규</span></td>
  <td>PlanA TASK10 기반 (targetdata RECORD + UI변수 4개 + 계산 프로시저)</td>
  <td>#6~9</td>
</tr>
<tr>
  <td>4</td>
  <td><code>TASK9/SYSMOD/user.sys</code></td>
  <td><span class="tag tag-new">신규</span></td>
  <td>T_Teaching 기본 시스템 모듈</td>
  <td>-</td>
</tr>
<tr>
  <td>5</td>
  <td><code>SYSPAR/SYS.cfg</code></td>
  <td><span class="tag tag-fix">1항 추가</span></td>
  <td>CAB_TASKS에 T_Teaching 태스크 정의</td>
  <td>태스크 인식</td>
</tr>
</table>


<!-- ============================================ -->
<h2>7. 조치 후 크로스 태스크 데이터 흐름</h2>
<!-- ============================================ -->

<p>모든 공유 데이터는 <code>PERS</code> (Persistent) 변수로 선언되어 태스크 간 직접 참조가 가능합니다.</p>

<div class="diagram">
+------------------+       +------------------+       +--------------------+
|  TASK1 (T_ROB1)  |       |  TASK2 (T_ROB2)  |       |  TASK8 (T_Head)    |
|  MainModule      |       |  Rob2_MainModule |       |  Head_Data         |
|                  |       |                  |       |                    |
|  Welds1{40}  ----+------&gt;|  Welds2{40}      |       |  nWarmUpCycle  NEW |
|  nRunningStep{2} |&lt;-----&gt;|  nRunningStep{2} |       |  stCommand/stReact |
|  bArc_On{2}      |&lt;-----&gt;|  bArc_On{2}      |       |                    |
|  stCommand       |&lt;-----&gt;|  stCommand       |&lt;-----&gt;|  stCommand         |
+--------+---------+       +--------+---------+       +--------------------+
         |                          |
         v                          v
+--------+---------+       +--------+---------+
|  TASK7 (T_BG)    |       |  TASK9            |
|  Static.mod      |       |  (T_Teaching)     |
|  RESTORED        |       |  NEW              |
|                  |       |                   |
|  MonitorPosition |       |  nCurrentTarget-  |
|  nTorques{18}    |       |    Voltage{2}     |
|  stWeld1/stWeld2 |       |  nCurrentTarget-  |
|                  |       |    Wfs{2}         |
|  PERS 참조:      |       |  nRealTime-       |
|   Welds1/2{40}   |       |    Voltage{2}     |
|   nRunningStep   |       |  nRealTimeWfs{2}  |
|   tWeld1/2       |       |                   |
+--------+---------+       +--------+----------+
         |                          |
         v                          v
+-------------------------------------------------------+
|              상위제어 UI (PC)                          |
|         ABB PC SDK로 PERS 변수 Read / Write           |
+-------------------------------------------------------+
</div>


<!-- ============================================ -->
<h2>8. 적용 절차</h2>
<!-- ============================================ -->

<ol style="line-height: 2.2;">
  <li><strong>RobotStudio 가상 컨트롤러 중지</strong></li>
  <li>변경 파일 복사:
    <ul>
      <li><code>TASK7/PROGMOD/Static.mod</code> &mdash; 기존 파일 교체</li>
      <li><code>TASK8/PROGMOD/Head_Data.mod</code> &mdash; 기존 파일 교체</li>
      <li><code>TASK9/</code> 폴더 전체 &mdash; 신규 복사</li>
      <li><code>SYSPAR/SYS.cfg</code> &mdash; 기존 파일 교체</li>
    </ul>
  </li>
  <li><strong>컨트롤러 Warm Start</strong> (SYS.cfg 변경 &rarr; 태스크 재인식 필수)</li>
  <li>상위 UI 재시작 후 <code>RapidInitFailReport.txt</code> 에러 건수 <strong>0건</strong> 확인</li>
</ol>


<!-- ============================================ -->
<h2>9. 주의사항 및 후속 작업</h2>
<!-- ============================================ -->

<div class="box box-warn">
  <strong>즉시 확인 필요</strong>
  <ol style="margin:8px 0 0;">
    <li><strong>EIO.cfg I/O 신호 정의 확인</strong> &mdash; Static.mod가 참조하는 모든 I/O 신호가 PlanB의 EIO.cfg에 정의되어 있어야 합니다. 미정의 시 RAPID 로드 에러 발생.
      <ul style="font-size:12px; color:#718096;">
        <li>입력: siLn1Current, siLn1Voltage, siLn1TouchActive, siLn1Arc_Est, siLn2Current, siLn2Voltage, siLn2TouchActive, siLn2Arc_Est, di17_Head1Shock, di19_Head2Shock, co001_AutoMode, co002_PrgRun, co004_MotorOn, pi53_SetTeachingPoint</li>
        <li>출력: cgo05_AxisX_Current, intMoveHome_Head/RBT1/RBT2/Gantry, intTouch_1/2, intReHoldGantry_1/2, so_MoveG_PosHold, soLn1/2TouchActive, po03_Home, po08_RobotMoving, po53_SetTeachingPoint</li>
      </ul>
    </li>
    <li><strong>공유 PERS 변수 초기값</strong> &mdash; tWeld1/2 (용접 툴데이터), wobjWeldLine1/2, wobjRotCtr1/2 (작업좌표계)가 T_ROB1/T_ROB2에서 올바르게 정의되어 있어야 T_BG에서 참조 가능.</li>
  </ol>
</div>

<div class="box box-info">
  <strong>후속 작업 (디파인시스템 협의)</strong>
  <ul style="margin:8px 0 0;">
    <li><strong>nWarmUpCycle 실제 연동:</strong> 현재 초기값 0. Head_MoveControl.mod 워밍업 루프 내에서 카운트 업데이트 로직 추가 필요.</li>
    <li><strong>Robot1/2 토크 읽기:</strong> nTorques{1~12}는 주석처리 상태 (PlanA도 동일). 필요 시 주석 해제 + Mechanical Unit 이름 확인.</li>
    <li><strong>추가 에러 가능성:</strong> 위 9건은 UI 초기화 단계 에러. 실제 운용(용접/이동) 시 추가 심볼 요구 가능. 전체 기능 테스트 필요.</li>
  </ul>
</div>


<!-- ============================================ -->
<h2>10. PlanA &harr; PlanB 태스크 매핑 (최종)</h2>
<!-- ============================================ -->

<table>
<tr><th>TASK</th><th>PlanA</th><th>PlanB (조치 후)</th><th>상태</th></tr>
<tr><td>1</td><td>T_ROB1 &mdash; Robot1 용접</td><td>T_ROB1 &mdash; Robot1 + 갠트리 통합</td><td>-</td></tr>
<tr><td>2</td><td>T_ROB2 &mdash; Robot2 용접</td><td>T_ROB2 &mdash; Robot2 용접</td><td>-</td></tr>
<tr><td>7</td><td>T_Gantry &mdash; 갠트리 모션</td><td>T_BG &mdash; 백그라운드 모니터링</td><td><span class="tag tag-fix">복원</span></td></tr>
<tr><td>8</td><td>T_Head &mdash; 커맨드 디스패처</td><td>T_Head &mdash; +nWarmUpCycle</td><td><span class="tag tag-fix">+1변수</span></td></tr>
<tr><td>9</td><td>T_BG &mdash; 백그라운드 모니터링</td><td>T_Teaching &mdash; 용접 파라미터 계산</td><td><span class="tag tag-new">신규</span></td></tr>
<tr><td>10</td><td>T_Teaching &mdash; 용접 파라미터</td><td>(해당 없음)</td><td>-</td></tr>
</table>

<div class="box box-grey">
  <strong>참고:</strong> PlanA와 PlanB의 TASK 폴더 번호가 다르지만, UI는 폴더 번호가 아닌 <strong>태스크 이름</strong>(T_BG, T_Teaching)으로 변수에 접근합니다.
  태스크 이름과 모듈/변수명이 일치하면 폴더 위치와 무관하게 정상 동작합니다.
</div>


<div class="signature">
<p>
<strong>심태양</strong> | 에스피시스템스<br>
S25016 프로젝트 담당<br>
taeyang@spsystems.kr
</p>
</div>

</div><!-- /.container -->
</body>
</html>
