<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒˆ ì´ìŠˆ ë“±ë¡ - S25016 í€ì¹˜ë¦¬ìŠ¤íŠ¸</title>

    <link rel="stylesheet" href="../../shared/styles/variables.css">
    <link rel="stylesheet" href="../../shared/styles/reset.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: var(--space-5);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .header {
            background: var(--color-primary-gradient);
            color: var(--color-white);
            padding: var(--space-8);
            text-align: center;
        }

        /* í…œí”Œë¦¿ ì„ íƒ */
        .template-selection {
            padding: var(--space-8);
            background: var(--color-gray-50);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .template-card {
            background: var(--color-white);
            padding: var(--space-5);
            border-radius: var(--border-radius-lg);
            border: 2px solid var(--color-gray-300);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .template-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .template-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }

        .template-name {
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-2);
        }

        .template-description {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
        }

        /* í¼ */
        .form-content {
            padding: var(--space-8);
        }

        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-group label {
            display: block;
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-2);
            color: var(--color-gray-700);
        }

        .form-group label .required {
            color: var(--color-danger);
        }

        .form-group label .helper {
            font-weight: normal;
            font-size: var(--font-sm);
            color: var(--color-gray-500);
            margin-left: var(--space-2);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-base);
            font-size: var(--font-base);
            transition: var(--transition-base);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .button-group {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-8);
        }

        .helper-text {
            font-size: var(--font-sm);
            color: var(--color-gray-500);
            margin-top: var(--space-2);
        }

        .section-title {
            font-size: var(--font-lg);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin: var(--space-8) 0 var(--space-4);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--color-gray-200);
        }

        /* ì»¤ìŠ¤í…€ í•„ë“œ */
        #customFieldsContainer {
            margin-top: var(--space-6);
        }

        .custom-field {
            margin-bottom: var(--space-4);
        }

        /* ì²´í¬ë°•ìŠ¤ */
        .checkbox-field {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .checkbox-field input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â• ìƒˆ ì´ìŠˆ ë“±ë¡</h1>
            <p>í€ì¹˜ë¦¬ìŠ¤íŠ¸ì— ìƒˆë¡œìš´ ì´ìŠˆë¥¼ ë“±ë¡í•©ë‹ˆë‹¤</p>
        </div>

        <!-- í…œí”Œë¦¿ ì„ íƒ -->
        <div class="template-selection">
            <h3>ğŸ“‹ í…œí”Œë¦¿ ì„ íƒ (ì„ íƒì‚¬í•­)</h3>
            <p class="helper-text">ì´ìŠˆ ìœ í˜•ì— ë§ëŠ” í…œí”Œë¦¿ì„ ì„ íƒí•˜ë©´ í•„ìš”í•œ í•­ëª©ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤</p>

            <div class="template-grid" id="templateGrid">
                <!-- ë™ì  ìƒì„± -->
            </div>
        </div>

        <div class="form-content">
            <form id="createIssueForm">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="section-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</div>

                <div class="form-group">
                    <label>ì œëª© <span class="required">*</span></label>
                    <input type="text" id="title" name="title" required placeholder="ì´ìŠˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <div class="helper-text" id="titleHelp"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ë¶„ë¥˜ <span class="required">*</span></label>
                        <select id="category" name="category" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì„¸ë¶€ë¶„ë¥˜ <span class="required">*</span></label>
                        <select id="subcategory" name="subcategory" required>
                            <option value="">ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ìš°ì„ ìˆœìœ„ <span class="required">*</span></label>
                        <select id="priority" name="priority" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ê¸´ê¸‰">ğŸš¨ ê¸´ê¸‰</option>
                            <option value="ë†’ìŒ">âš ï¸ ë†’ìŒ</option>
                            <option value="ë³´í†µ">â„¹ï¸ ë³´í†µ</option>
                            <option value="ë‚®ìŒ">â– ë‚®ìŒ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ìƒíƒœ</label>
                        <select id="status" name="status">
                            <option value="ì‹ ê·œ" selected>ì‹ ê·œ</option>
                            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                            <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                            <option value="ê²€ì¦ì¤‘">ê²€ì¦ì¤‘</option>
                        </select>
                    </div>
                </div>

                <!-- ë¬¸ì œ ìƒí™© -->
                <div class="section-title">ğŸ“ ë¬¸ì œ ìƒí™©</div>

                <div class="form-group">
                    <label>ë¬¸ì œ ìƒí™© <span class="required">*</span></label>
                    <textarea id="description" name="description" required placeholder="ë¬¸ì œ ìƒí™©ì„ ìƒì„¸íˆ ê¸°ìˆ í•˜ì„¸ìš”"></textarea>
                    <div class="helper-text" id="descriptionHelp">ë°œìƒí•œ ë¬¸ì œì˜ í˜„ìƒê³¼ ì˜í–¥ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”</div>
                </div>

                <div class="form-group">
                    <label>ì›ì¸ ë¶„ì„</label>
                    <textarea id="cause" name="cause" placeholder="ë¬¸ì œì˜ ì›ì¸ì„ ë¶„ì„í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                    <div class="helper-text" id="causeHelp"></div>
                </div>

                <!-- ì¡°ì¹˜ ê³„íš -->
                <div class="section-title">ğŸ”§ ì¡°ì¹˜ ê³„íš ë° ê²°ê³¼</div>

                <div class="form-group">
                    <label>ì¡°ì¹˜ ê³„íš</label>
                    <textarea id="action_plan" name="action_plan" placeholder="ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì¡°ì¹˜ ê³„íšì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                    <div class="helper-text" id="actionPlanHelp"></div>
                </div>

                <div class="form-group">
                    <label>ì¡°ì¹˜ ê²°ê³¼</label>
                    <textarea id="action_result" name="action_result" placeholder="ì¡°ì¹˜ë¥¼ ì‹¤í–‰í•œ í›„ ê²°ê³¼ë¥¼ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                </div>

                <!-- ì»¤ìŠ¤í…€ í•„ë“œ (ë™ì ) -->
                <div id="customFieldsSection" style="display: none;">
                    <div class="section-title">âš™ï¸ ì¶”ê°€ ì •ë³´</div>
                    <div id="customFieldsContainer">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ë‹´ë‹¹ ì •ë³´ -->
                <div class="section-title">ğŸ‘¥ ë‹´ë‹¹ ì •ë³´</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì <span class="required">*</span></label>
                        <select id="owner" name="owner" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ìŠ¹ì¸ì</label>
                        <select id="approver" name="approver">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>í˜‘ì˜ì</label>
                    <input type="text" id="collaborators" name="collaborators" placeholder="í˜‘ì˜ìë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥ (ì˜ˆ: ê¹€ì² ìˆ˜, ë°•ì˜í¬)">
                    <div class="helper-text">ì—¬ëŸ¬ ëª…ì¸ ê²½ìš° ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì„¸ìš”</div>
                </div>

                <!-- ì¼ì • ì •ë³´ -->
                <div class="section-title">ğŸ“… ì¼ì • ì •ë³´</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ìš”ì²­ì¼ <span class="required">*</span></label>
                        <input type="date" id="request_date" name="request_date" required>
                    </div>

                    <div class="form-group">
                        <label>ëª©í‘œ ì™„ë£Œì¼ <span class="required">*</span></label>
                        <input type="date" id="target_date" name="target_date" required>
                    </div>

                    <div class="form-group">
                        <label>ì‹¤ì œ ì™„ë£Œì¼</label>
                        <input type="date" id="complete_date" name="complete_date">
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        âœ… ì´ìŠˆ ë“±ë¡
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        ğŸ”„ ì´ˆê¸°í™”
                    </button>
                    <a href="../index.html" class="btn btn-outline">
                        âŒ ì·¨ì†Œ
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script src="../../shared/scripts/utils.js"></script>
    <script src="../scripts/config-loader.js"></script>
    <script src="../scripts/punchlist.js"></script>
    <script>
        let currentTemplate = null;
        let allTemplates = [];
        let customFieldsConfig = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', async () => {
            await initForm();
            setDefaultDates();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('category').addEventListener('change', updateSubcategories);
            document.getElementById('createIssueForm').addEventListener('submit', handleSubmit);

            // í…œí”Œë¦¿ ë¡œë“œ
            await loadTemplates();
        });

        // í¼ ì´ˆê¸°í™”
        async function initForm() {
            // ë¶„ë¥˜ ì²´ê³„ ë¡œë“œ
            const categories = await configLoader.loadCategories();
            const categorySelect = document.getElementById('category');

            categories.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.icon} ${cat.name}`;
                categorySelect.appendChild(option);
            });

            // ë‹´ë‹¹ì ì˜µì…˜
            const ownerSelect = document.getElementById('owner');
            const approverSelect = document.getElementById('approver');

            PunchListAPI.OWNERS.forEach(owner => {
                const option1 = document.createElement('option');
                option1.value = owner;
                option1.textContent = owner;
                ownerSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = owner;
                option2.textContent = owner;
                approverSelect.appendChild(option2);
            });

            // ì»¤ìŠ¤í…€ í•„ë“œ ì„¤ì • ë¡œë“œ
            customFieldsConfig = await configLoader.loadCustomFields();
        }

        // í…œí”Œë¦¿ ë¡œë“œ ë° í‘œì‹œ
        async function loadTemplates() {
            allTemplates = await configLoader.loadAllTemplates();
            const grid = document.getElementById('templateGrid');

            // ê¸°ë³¸ í…œí”Œë¦¿ ì¹´ë“œ
            const defaultCard = createTemplateCard(null, {
                name: 'ê¸°ë³¸ í…œí”Œë¦¿',
                description: 'ì¼ë°˜ì ì¸ ì´ìŠˆë¥¼ ë“±ë¡í•©ë‹ˆë‹¤',
                icon: 'ğŸ“‹'
            });
            grid.appendChild(defaultCard);

            // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ í…œí”Œë¦¿ ì¹´ë“œ
            allTemplates.forEach(template => {
                const card = createTemplateCard(template.templateId, template);
                grid.appendChild(card);
            });
        }

        // í…œí”Œë¦¿ ì¹´ë“œ ìƒì„±
        function createTemplateCard(templateId, template) {
            const card = document.createElement('div');
            card.className = 'template-card';
            if (!templateId) card.classList.add('selected');

            card.innerHTML = `
                <div class="template-icon">${template.icon}</div>
                <div class="template-name">${template.name}</div>
                <div class="template-description">${template.description}</div>
            `;

            card.onclick = () => selectTemplate(templateId, card);

            return card;
        }

        // í…œí”Œë¦¿ ì„ íƒ
        async function selectTemplate(templateId, cardElement) {
            // ì¹´ë“œ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');

            currentTemplate = templateId;

            if (!templateId) {
                // ê¸°ë³¸ í…œí”Œë¦¿
                clearCustomFields();
                clearHelpTexts();
                return;
            }

            // í…œí”Œë¦¿ ë°ì´í„° ë¡œë“œ
            const template = allTemplates.find(t => t.templateId === templateId);
            if (!template) return;

            // ê¸°ë³¸ê°’ ì ìš©
            if (template.defaultValues) {
                for (const [key, value] of Object.entries(template.defaultValues)) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = value;
                    }
                }

                // ì„¸ë¶€ë¶„ë¥˜ ì—…ë°ì´íŠ¸ (ë¶„ë¥˜ê°€ ì„¤ì •ëœ ê²½ìš°)
                if (template.defaultValues.category) {
                    await updateSubcategories();
                    if (template.defaultValues.subcategory) {
                        document.getElementById('subcategory').value = template.defaultValues.subcategory;
                    }
                }
            }

            // ë„ì›€ë§ í…ìŠ¤íŠ¸ ì„¤ì •
            if (template.helpText) {
                for (const [fieldId, helpText] of Object.entries(template.helpText)) {
                    const helpElement = document.getElementById(`${fieldId}Help`);
                    if (helpElement) {
                        helpElement.textContent = helpText;
                    }
                }
            }

            // ì»¤ìŠ¤í…€ í•„ë“œ ë Œë”ë§
            renderCustomFields(template);
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ë Œë”ë§
        function renderCustomFields(template) {
            const container = document.getElementById('customFieldsContainer');
            const section = document.getElementById('customFieldsSection');
            container.innerHTML = '';

            if (!template.customFields) {
                section.style.display = 'none';
                return;
            }

            const enabledFields = Object.entries(template.customFields)
                .filter(([_, config]) => config.enabled)
                .map(([fieldId]) => {
                    return customFieldsConfig.fields.find(f => f.id === fieldId);
                })
                .filter(f => f !== undefined);

            if (enabledFields.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            enabledFields.forEach(field => {
                const fieldConfig = template.customFields[field.id];
                const fieldElement = createCustomFieldElement(field, fieldConfig);
                container.appendChild(fieldElement);
            });
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        function createCustomFieldElement(field, config) {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-group custom-field';
            wrapper.dataset.fieldId = field.id;

            const label = document.createElement('label');
            label.innerHTML = field.name;
            if (config.required) {
                label.innerHTML += ' <span class="required">*</span>';
            }
            wrapper.appendChild(label);

            let input;

            switch (field.type) {
                case 'number':
                    input = document.createElement('input');
                    input.type = 'number';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    input.placeholder = field.placeholder || '';
                    if (field.validation) {
                        if (field.validation.min !== undefined) input.min = field.validation.min;
                        if (field.validation.max !== undefined) input.max = field.validation.max;
                    }
                    if (field.unit) {
                        input.placeholder += ` (ë‹¨ìœ„: ${field.unit})`;
                    }
                    break;

                case 'select':
                    input = document.createElement('select');
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'ì„ íƒí•˜ì„¸ìš”';
                    input.appendChild(defaultOption);

                    field.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        input.appendChild(option);
                    });
                    break;

                case 'boolean':
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-field';

                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;

                    const checkboxLabel = document.createElement('label');
                    checkboxLabel.htmlFor = `custom_${field.id}`;
                    checkboxLabel.textContent = field.helpText || '';

                    checkboxDiv.appendChild(input);
                    checkboxDiv.appendChild(checkboxLabel);
                    wrapper.appendChild(checkboxDiv);

                    if (field.helpText) {
                        const helpDiv = document.createElement('div');
                        helpDiv.className = 'helper-text';
                        helpDiv.textContent = field.helpText;
                        wrapper.appendChild(helpDiv);
                    }

                    return wrapper;

                case 'textarea':
                    input = document.createElement('textarea');
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    input.placeholder = field.placeholder || '';
                    break;

                case 'date':
                    input = document.createElement('input');
                    input.type = 'date';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    break;

                default: // text
                    input = document.createElement('input');
                    input.type = 'text';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    input.placeholder = field.placeholder || '';
                    if (field.pattern) {
                        input.pattern = field.pattern;
                    }
            }

            if (input && config.required) {
                input.required = true;
            }

            if (input && config.defaultValue !== undefined) {
                input.value = config.defaultValue;
            }

            if (input) {
                wrapper.appendChild(input);
            }

            if (field.helpText) {
                const helpDiv = document.createElement('div');
                helpDiv.className = 'helper-text';
                helpDiv.textContent = field.helpText;
                wrapper.appendChild(helpDiv);
            }

            return wrapper;
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ì´ˆê¸°í™”
        function clearCustomFields() {
            document.getElementById('customFieldsContainer').innerHTML = '';
            document.getElementById('customFieldsSection').style.display = 'none';
        }

        // ë„ì›€ë§ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        function clearHelpTexts() {
            document.querySelectorAll('[id$="Help"]').forEach(el => {
                if (el.id === 'descriptionHelp') {
                    el.textContent = 'ë°œìƒí•œ ë¬¸ì œì˜ í˜„ìƒê³¼ ì˜í–¥ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”';
                } else {
                    el.textContent = '';
                }
            });
        }

        // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const oneWeekLater = new Date();
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);
            const targetDate = oneWeekLater.toISOString().split('T')[0];

            document.getElementById('request_date').value = today;
            document.getElementById('target_date').value = targetDate;
        }

        // ì„¸ë¶€ë¶„ë¥˜ ì—…ë°ì´íŠ¸
        async function updateSubcategories() {
            const category = document.getElementById('category').value;
            const subcategorySelect = document.getElementById('subcategory');

            subcategorySelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

            if (!category) return;

            const categories = await configLoader.loadCategories();
            const categoryData = categories.categories.find(c => c.name === category);

            if (categoryData && categoryData.subcategories) {
                categoryData.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        // í¼ ì œì¶œ
        async function handleSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const issueData = Object.fromEntries(formData.entries());

            // ì»¤ìŠ¤í…€ í•„ë“œ ìˆ˜ì§‘
            issueData.customFields = {};
            document.querySelectorAll('.custom-field').forEach(fieldEl => {
                const fieldId = fieldEl.dataset.fieldId;
                const input = fieldEl.querySelector('input, select, textarea');

                if (input) {
                    if (input.type === 'checkbox') {
                        issueData.customFields[fieldId] = input.checked;
                    } else {
                        issueData.customFields[fieldId] = input.value;
                    }
                }
            });

            // í…œí”Œë¦¿ ID ì¶”ê°€
            if (currentTemplate) {
                issueData.templateId = currentTemplate;
            }

            // ë¹ˆ ê°’ ì²˜ë¦¬
            Object.keys(issueData).forEach(key => {
                if (!issueData[key] && key !== 'customFields') {
                    issueData[key] = '';
                }
            });

            try {
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'â³ ë“±ë¡ ì¤‘...';

                await PunchListAPI.createIssue(issueData);

                alert('âœ… ì´ìŠˆê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = '../index.html';
            } catch (error) {
                console.error('ì´ìŠˆ ë“±ë¡ ì‹¤íŒ¨:', error);
                alert('âŒ ì´ìŠˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.textContent = 'âœ… ì´ìŠˆ ë“±ë¡';
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            if (confirm('ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('createIssueForm').reset();
                setDefaultDates();
                document.getElementById('subcategory').innerHTML = '<option value="">ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
                clearCustomFields();
                clearHelpTexts();

                // ê¸°ë³¸ í…œí”Œë¦¿ ì„ íƒ
                document.querySelectorAll('.template-card').forEach((c, i) => {
                    if (i === 0) {
                        c.classList.add('selected');
                    } else {
                        c.classList.remove('selected');
                    }
                });
                currentTemplate = null;
            }
        }
    </script>
</body>
</html>
