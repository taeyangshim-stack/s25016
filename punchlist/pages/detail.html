<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìŠˆ ìƒì„¸ - S25016 í€ì¹˜ë¦¬ìŠ¤íŠ¸</title>

    <link rel="stylesheet" href="../../shared/styles/variables.css">
    <link rel="stylesheet" href="../../shared/styles/reset.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">

    <style>
        body {
            background: var(--color-gray-50);
            min-height: 100vh;
            padding: var(--space-5);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--color-white);
            padding: var(--space-6);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
        }

        .title-section h1 {
            font-size: var(--font-2xl);
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .issue-id {
            font-size: var(--font-base);
            color: var(--color-gray-500);
            font-weight: normal;
        }

        .actions {
            display: flex;
            gap: var(--space-3);
        }

        .badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--border-radius-base);
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-6);
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .card-title {
            font-size: var(--font-lg);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
            margin-bottom: var(--space-1);
        }

        .info-value {
            font-size: var(--font-base);
            color: var(--color-gray-900);
            font-weight: var(--font-medium);
        }

        .description-section {
            margin-top: var(--space-4);
        }

        .description-label {
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
            color: var(--color-gray-700);
            margin-bottom: var(--space-2);
        }

        .description-text {
            font-size: var(--font-base);
            color: var(--color-gray-800);
            line-height: 1.6;
            white-space: pre-wrap;
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius-base);
        }

        .primary-image {
            margin-top: var(--space-4);
            border-radius: var(--border-radius-base);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .primary-image img {
            width: 100%;
            display: block;
            max-height: 420px;
            object-fit: cover;
        }

        .primary-image-caption {
            font-size: var(--font-sm);
            color: var(--color-gray-500);
            padding: var(--space-3);
            background: var(--color-gray-100);
        }

        .custom-fields-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .timeline {
            list-style: none;
            padding: 0;
        }

        .timeline-item {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .timeline-icon {
            width: 32px;
            height: 32px;
            background: var(--color-primary);
            color: var(--color-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-sm);
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .image-upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--border-radius-base);
            padding: var(--space-6);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            background: var(--color-gray-50);
        }

        .image-upload-area:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .image-upload-area.dragover {
            border-color: var(--color-primary);
            background: rgba(99, 102, 241, 0.12);
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .image-preview-item {
            position: relative;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            background: var(--color-gray-100);
            box-shadow: inset 0 0 0 1px var(--color-gray-200);
        }

        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .preview-wrapper {
            position: relative;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(220, 38, 38, 0.92);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .image-preview-item .remove-btn:hover {
            background: rgba(220, 38, 38, 1);
        }

        .image-status {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: var(--font-xs);
            font-weight: var(--font-semibold);
            color: #fff;
            background: rgba(15, 23, 42, 0.75);
        }

        .image-status.success { background: rgba(16, 185, 129, 0.85); }
        .image-status.uploading { background: rgba(59, 130, 246, 0.85); }
        .image-status.error { background: rgba(239, 68, 68, 0.9); }

        .image-preview-item .caption-input {
            width: 100%;
            padding: var(--space-2);
            font-size: var(--font-sm);
            border: none;
            border-top: 1px solid var(--color-gray-200);
        }

        .caption-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid var(--color-gray-200);
            font-size: var(--font-xs);
            gap: var(--space-2);
        }

        .caption-actions button {
            border: none;
            background: none;
            color: var(--color-primary);
            cursor: pointer;
            font-size: var(--font-xs);
            padding: 0;
        }

        .caption-actions button:hover {
            text-decoration: underline;
        }

        #editImageUploadMessage {
            margin-top: var(--space-3);
            font-size: var(--font-sm);
            color: var(--color-gray-500);
        }

        #editImageUploadMessage.error {
            color: #e11d48;
        }

        .timeline-date {
            font-size: var(--font-sm);
            color: var(--color-gray-500);
        }

        .loading {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-gray-500);
        }

        .error {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-danger);
        }

        .overdue {
            color: var(--color-danger);
        }

        .empty-text {
            color: var(--color-gray-400);
            font-style: italic;
        }

        /* ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .image-item {
            position: relative;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            background: var(--color-gray-100);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-item:hover {
            transform: scale(1.05);
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-caption {
            padding: var(--space-2);
            font-size: var(--font-sm);
            color: var(--color-gray-700);
            background: var(--color-white);
            text-align: center;
        }

        /* ì´ë¯¸ì§€ ëª¨ë‹¬ */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .image-modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90vh;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 36px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .edit-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            z-index: 1200;
            padding: var(--space-6);
            overflow-y: auto;
        }

        .edit-modal.active {
            display: block;
        }

        .edit-modal .modal-card {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 720px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .edit-modal-title {
            font-size: var(--font-xl);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: var(--font-2xl);
            color: var(--color-gray-500);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .modal-close-btn:hover {
            color: var(--color-gray-700);
        }

        .edit-form .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .edit-form .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .edit-form .form-group.full {
            grid-column: 1 / -1;
        }

        .edit-form label {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
            font-weight: var(--font-medium);
        }

        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-base);
            font-size: var(--font-base);
            transition: var(--transition-base);
        }

        .edit-form input:focus,
        .edit-form select:focus,
        .edit-form textarea:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .edit-form textarea {
            min-height: 110px;
            resize: vertical;
        }

        .edit-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        .edit-form-actions .btn {
            min-width: 120px;
        }

        .modal-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: var(--space-3);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingState" class="loading">
            â³ ì´ìŠˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <div id="errorState" class="error" style="display: none;">
            âš ï¸ ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
            <a href="list.html" class="btn btn-outline" style="margin-top: var(--space-4);">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div id="contentArea" style="display: none;">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="header-top">
                    <div class="title-section">
                        <h1>
                            <span class="issue-id" id="issueId"></span>
                            <span id="issueTitle"></span>
                        </h1>
                        <div style="display: flex; gap: var(--space-2); margin-top: var(--space-3);">
                            <span class="badge" id="priorityBadge"></span>
                            <span class="badge" id="statusBadge"></span>
                            <span class="badge" id="categoryBadge"></span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="editIssue()">âœï¸ ìˆ˜ì •</button>
                        <button class="btn btn-outline" onclick="deleteIssue()">ğŸ—‘ï¸ ì‚­ì œ</button>
                        <a href="list.html" class="btn btn-outline">ğŸ“‹ ëª©ë¡</a>
                    </div>
                </div>
            </div>

            <!-- ì½˜í…ì¸  ê·¸ë¦¬ë“œ -->
            <div class="content-grid">
                <!-- ì™¼ìª½ ì—´ -->
                <div>
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">ë¶„ë¥˜</span>
                                <span class="info-value" id="category"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì„¸ë¶€ë¶„ë¥˜</span>
                                <span class="info-value" id="subcategory"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìš°ì„ ìˆœìœ„</span>
                                <span class="info-value" id="priority"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìƒíƒœ</span>
                                <span class="info-value" id="status"></span>
                            </div>
                        </div>
                    </div>

                    <!-- ë¬¸ì œ ìƒí™© -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“ ë¬¸ì œ ìƒí™©</h2>
                        <div class="description-text" id="description"></div>
                        <div id="primaryImageWrapper" style="display: none;">
                            <div class="primary-image">
                                <img id="primaryImage" src="" alt="ì²¨ë¶€ ì´ë¯¸ì§€">
                            </div>
                            <div class="primary-image-caption" id="primaryImageCaption"></div>
                        </div>
                    </div>

                    <!-- ì›ì¸ ë¶„ì„ -->
                    <div class="card" id="causeCard" style="display: none;">
                        <h2 class="card-title">ğŸ” ì›ì¸ ë¶„ì„</h2>
                        <div class="description-text" id="cause"></div>
                    </div>

                    <!-- ì¡°ì¹˜ ê³„íš -->
                    <div class="card" id="actionPlanCard" style="display: none;">
                        <h2 class="card-title">ğŸ”§ ì¡°ì¹˜ ê³„íš</h2>
                        <div class="description-text" id="actionPlan"></div>
                    </div>

                    <!-- ì¡°ì¹˜ ê²°ê³¼ -->
                    <div class="card" id="actionResultCard" style="display: none;">
                        <h2 class="card-title">âœ… ì¡°ì¹˜ ê²°ê³¼</h2>
                        <div class="description-text" id="actionResult"></div>
                    </div>

                    <!-- ì»¤ìŠ¤í…€ í•„ë“œ -->
                    <div class="card" id="customFieldsCard" style="display: none;">
                        <h2 class="card-title">âš™ï¸ ì¶”ê°€ ì •ë³´</h2>
                        <div class="custom-fields-grid" id="customFieldsContainer"></div>
                    </div>

                    <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
                    <div class="card" id="imagesCard" style="display: none;">
                        <h2 class="card-title">ğŸ“· ì²¨ë¶€ ì´ë¯¸ì§€</h2>
                        <div class="image-gallery" id="imageGallery"></div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì—´ -->
                <div>
                    <!-- ë‹´ë‹¹ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ‘¥ ë‹´ë‹¹ ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ë‹´ë‹¹ì</span>
                            <span class="info-value" id="owner"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">í˜‘ì˜ì</span>
                            <span class="info-value" id="collaborators"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ìŠ¹ì¸ì</span>
                            <span class="info-value" id="approver"></span>
                        </div>
                    </div>

                    <!-- ì¼ì • ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“… ì¼ì • ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìš”ì²­ì¼</span>
                            <span class="info-value" id="requestDate"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ëª©í‘œ ì™„ë£Œì¼</span>
                            <span class="info-value" id="targetDate"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ì‹¤ì œ ì™„ë£Œì¼</span>
                            <span class="info-value" id="completeDate"></span>
                        </div>
                    </div>

                    <!-- íƒ€ì„ë¼ì¸ -->
                    <div class="card">
                        <h2 class="card-title">â±ï¸ íƒ€ì„ë¼ì¸</h2>
                        <ul class="timeline" id="timeline"></ul>
                    </div>

                    <!-- ë©”íƒ€ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">â„¹ï¸ ë©”íƒ€ ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìƒì„±ì¼ì‹œ</span>
                            <span class="info-value" id="createdAt"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìˆ˜ì •ì¼ì‹œ</span>
                            <span class="info-value" id="updatedAt"></span>
                        </div>
                        <div class="info-item" id="templateInfoItem" style="display: none;">
                            <span class="info-label">í…œí”Œë¦¿</span>
                            <span class="info-value" id="templateId"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <button class="modal-close" onclick="closeImageModal(event)">Ã—</button>
        <div class="modal-content">
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-caption" id="modalCaption"></div>
        </div>
    </div>

    <!-- ì´ìŠˆ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="edit-modal" id="editIssueModal">
        <div class="modal-card">
            <div class="edit-modal-header">
                <h2 class="edit-modal-title">ì´ìŠˆ ìˆ˜ì •</h2>
                <button type="button" class="modal-close-btn" onclick="closeEditModal()">Ã—</button>
            </div>
            <form id="editIssueForm" class="edit-form">
                <div class="form-row">
                    <div class="form-group full">
                        <label for="editTitle">ì œëª©</label>
                        <input type="text" id="editTitle" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPriority">ìš°ì„ ìˆœìœ„</label>
                        <select id="editPriority"></select>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">ìƒíƒœ</label>
                        <select id="editStatus"></select>
                    </div>
                    <div class="form-group">
                        <label for="editOwner">ë‹´ë‹¹ì</label>
                        <select id="editOwner"></select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editCollaborators">í˜‘ì˜ì</label>
                        <input type="text" id="editCollaborators">
                    </div>
                    <div class="form-group">
                        <label for="editApprover">ìŠ¹ì¸ì</label>
                        <input type="text" id="editApprover">
                    </div>
                </div>

                    <div class="form-row">
                    <div class="form-group">
                        <label for="editRequestDate">ìš”ì²­ì¼</label>
                        <input type="date" id="editRequestDate">
                    </div>
                    <div class="form-group">
                        <label for="editTargetDate">ëª©í‘œì¼</label>
                        <input type="date" id="editTargetDate">
                    </div>
                    <div class="form-group">
                        <label for="editCompleteDate">ì™„ë£Œì¼</label>
                        <input type="date" id="editCompleteDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editDescription">ë¬¸ì œ ìƒí™©</label>
                        <textarea id="editDescription"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editCause">ì›ì¸ ë¶„ì„</label>
                        <textarea id="editCause"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editActionPlan">ì¡°ì¹˜ ê³„íš</label>
                        <textarea id="editActionPlan"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editActionResult">ì¡°ì¹˜ ê²°ê³¼</label>
                        <textarea id="editActionResult"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label>ì´ë¯¸ì§€ ì²¨ë¶€</label>
                        <div class="image-upload-area" id="editImageUploadArea">
                            <div style="font-size: 40px; margin-bottom: var(--space-2);">ğŸ“·</div>
                            <div style="font-size: var(--font-base); font-weight: var(--font-semibold); margin-bottom: var(--space-1);">
                                ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì¶”ê°€
                            </div>
                            <div class="helper-text">JPG, PNG, GIF, WEBP ì§€ì› Â· ìµœëŒ€ 5MB</div>
                            <input type="file" id="editImageInput" accept="image/*" multiple style="display:none;">
                        </div>
                        <div class="image-preview-grid" id="editImagePreviewGrid"></div>
                        <div id="editImageUploadMessage" class="helper-text"></div>
                    </div>
                </div>

                <div class="edit-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../shared/scripts/utils.js"></script>
    <script src="../scripts/config-loader.js"></script>
    <script src="../scripts/punchlist.js"></script>
    <script>
        let currentIssue = null;
        let editFormInitialized = false;
        const PLACEHOLDER_IMAGE = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
        const CLOUDINARY_UPLOAD_FOLDER = 's25016/punchlist';
        let editUploadedImages = [];

        function getEditSubmitButton() {
            return document.querySelector('#editIssueForm button[type="submit"]');
        }

        function isEditUploading() {
            return editUploadedImages.some(img => img.status === 'uploading');
        }

        function getEditStatusText(status) {
            const map = {
                success: 'ì—…ë¡œë“œ ì™„ë£Œ',
                uploading: 'ì—…ë¡œë“œ ì¤‘',
                error: 'ì—…ë¡œë“œ ì‹¤íŒ¨'
            };
            return map[status] || status;
        }

        function updateEditImageUploadStatus() {
            const messageEl = document.getElementById('editImageUploadMessage');
            if (!messageEl) return;

            const uploadingCount = editUploadedImages.filter(img => img.status === 'uploading').length;
            const errorCount = editUploadedImages.filter(img => img.status === 'error').length;
            const successCount = editUploadedImages.filter(img => img.status === 'success').length;

            messageEl.classList.remove('error');

            if (uploadingCount > 0) {
                messageEl.textContent = `ì´ë¯¸ì§€ ${uploadingCount}ê°œ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...`;
            } else if (errorCount > 0) {
                messageEl.textContent = `ì´ë¯¸ì§€ ${errorCount}ê°œ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¬ì‹œë„í•˜ê±°ë‚˜ ì‚­ì œí•´ ì£¼ì„¸ìš”.`;
                messageEl.classList.add('error');
            } else if (successCount > 0) {
                messageEl.textContent = `ì´ë¯¸ì§€ ${successCount}ê°œê°€ ì €ì¥ ëŒ€ìƒìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            } else {
                messageEl.textContent = '';
            }

            const submitButton = getEditSubmitButton();
            if (submitButton && submitButton.dataset.locked !== 'true') {
                submitButton.disabled = uploadingCount > 0;
                if (uploadingCount > 0) {
                    submitButton.textContent = 'â³ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...';
                } else if (!submitButton.disabled) {
                    submitButton.textContent = 'ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì €ì¥';
                }
            }
        }

        function renderEditImagePreviews() {
            const grid = document.getElementById('editImagePreviewGrid');
            if (!grid) return;

            grid.innerHTML = '';

            if (editUploadedImages.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1 / -1; text-align:center; color:#7f8c8d; padding:40px;">ë“±ë¡ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                updateEditImageUploadStatus();
                return;
            }

            editUploadedImages.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                const imageSrc = img.dataUrl || img.url || PLACEHOLDER_IMAGE;
                const errorInfo = img.status === 'error' ? `<div class="helper-text" style="color:#e11d48; padding:4px 0;">${img.error}</div>` : '';

                const actionButtons = [
                    img.status === 'error' ? `<button type="button" onclick="retryEditImageUpload(${index})">ì¬ì‹œë„</button>` : '',
                    img.status === 'success' && img.url ? `<button type="button" onclick="copyEditImageUrl(${index})">URL ë³µì‚¬</button>` : ''
                ].filter(Boolean).join(' ');

                item.innerHTML = `
                    <div class="preview-wrapper">
                        <span class="image-status ${img.status}">${getEditStatusText(img.status)}</span>
                        <img src="${imageSrc}" alt="Edit Preview ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removeEditImage(${index})">Ã—</button>
                    </div>
                    <input type="text" class="caption-input" placeholder="ì„¤ëª… (ì„ íƒ)" value="${img.caption || ''}" onchange="updateEditCaption(${index}, this.value)">
                    <div class="caption-actions">
                        <span>${img.url ? 'ë§í¬ ì €ì¥ë¨' : getEditStatusText(img.status)}</span>
                        <div>${actionButtons}</div>
                    </div>
                    ${errorInfo}
                `;
                grid.appendChild(item);
            });

            updateEditImageUploadStatus();
        }

        function resetEditImagesFromCurrentIssue() {
            editUploadedImages = Array.isArray(currentIssue?.images)
                ? currentIssue.images.map(img => ({
                    file: null,
                    dataUrl: img.url || PLACEHOLDER_IMAGE,
                    caption: img.caption || '',
                    status: 'success',
                    url: img.url || '',
                    publicId: img.public_id || '',
                    error: '',
                    existing: true
                }))
                : [];
            renderEditImagePreviews();
        }

        function removeEditImage(index) {
            editUploadedImages.splice(index, 1);
            renderEditImagePreviews();
        }

        function updateEditCaption(index, caption) {
            if (editUploadedImages[index]) {
                editUploadedImages[index].caption = caption;
            }
        }

        async function copyEditImageUrl(index) {
            const image = editUploadedImages[index];
            if (!image || !image.url) return;
            try {
                await navigator.clipboard.writeText(image.url);
                alert('ğŸ“‹ ì´ë¯¸ì§€ URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('URL ë³µì‚¬ ì‹¤íŒ¨:', error);
                alert('âŒ URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function retryEditImageUpload(index) {
            const image = editUploadedImages[index];
            if (!image || !image.file) return;
            image.status = 'uploading';
            image.error = '';
            renderEditImagePreviews();
            uploadEditImageToCloudinary(index);
        }

        function setupEditImageUpload() {
            const uploadArea = document.getElementById('editImageUploadArea');
            const fileInput = document.getElementById('editImageInput');
            if (!uploadArea || !fileInput) return;

            uploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                handleEditFiles(e.target.files);
                fileInput.value = '';
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleEditFiles(e.dataTransfer.files);
            });

            updateEditImageUploadStatus();
        }

        function handleEditFiles(fileList) {
            const files = Array.from(fileList || []);

            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name}ì€(ëŠ”) ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.`);
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name}ì˜ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    return;
                }

                const record = {
                    file,
                    dataUrl: PLACEHOLDER_IMAGE,
                    caption: '',
                    status: 'uploading',
                    url: '',
                    publicId: '',
                    error: ''
                };

                editUploadedImages.push(record);
                const index = editUploadedImages.length - 1;

                const reader = new FileReader();
                reader.onload = (e) => {
                    editUploadedImages[index].dataUrl = e.target.result;
                    renderEditImagePreviews();
                };
                reader.readAsDataURL(file);

                renderEditImagePreviews();
                uploadEditImageToCloudinary(index);
            });

            updateEditImageUploadStatus();
        }

        async function uploadEditImageToCloudinary(index) {
            const image = editUploadedImages[index];
            if (!image) return;

            image.status = 'uploading';
            image.error = '';
            renderEditImagePreviews();

            const formData = new FormData();
            formData.append('file', image.file);
            formData.append('folder', CLOUDINARY_UPLOAD_FOLDER);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success || !result.url) {
                    throw new Error(result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                image.status = 'success';
                image.url = result.url;
                image.publicId = result.public_id || '';
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                image.status = 'error';
                image.error = error.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨';
                image.url = '';
                image.publicId = '';
            }

            renderEditImagePreviews();
        }

        window.removeEditImage = removeEditImage;
        window.updateEditCaption = updateEditCaption;
        window.retryEditImageUpload = retryEditImageUpload;
        window.copyEditImageUrl = copyEditImageUrl;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const issueId = urlParams.get('id');

            if (!issueId) {
                showError('ì´ìŠˆ IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            await setupEditForm();
            await loadIssue(issueId);
        });

        async function setupEditForm() {
            if (editFormInitialized) return;

            const statusSelect = document.getElementById('editStatus');
            const prioritySelect = document.getElementById('editPriority');
            const ownerSelect = document.getElementById('editOwner');

            if (statusSelect) {
                PunchListAPI.STATUSES.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusSelect.appendChild(option);
                });
            }

            if (prioritySelect) {
                PunchListAPI.PRIORITIES.forEach(priority => {
                    const option = document.createElement('option');
                    option.value = priority;
                    option.textContent = priority;
                    prioritySelect.appendChild(option);
                });
            }

            if (ownerSelect) {
                await PunchListAPI.ensureOwnersLoaded();
                PunchListAPI.getOwnerNames().forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    ownerSelect.appendChild(option);
                });
            }

            const editForm = document.getElementById('editIssueForm');
            if (editForm) {
                editForm.addEventListener('submit', handleEditSubmit);
            }

            setupEditImageUpload();

            editFormInitialized = true;
        }

        // ì´ìŠˆ ë¡œë“œ
        async function loadIssue(id) {
            try {
                currentIssue = await PunchListAPI.loadIssueById(id);
                renderIssue();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('contentArea').style.display = 'block';
            } catch (error) {
                console.error('ì´ìŠˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ìŠˆ ë Œë”ë§
        function renderIssue() {
            // í—¤ë”
            document.getElementById('issueId').textContent = currentIssue.id;
            document.getElementById('issueTitle').textContent = currentIssue.title;

            // ë°°ì§€
            const priorityBadge = document.getElementById('priorityBadge');
            priorityBadge.textContent = currentIssue.priority;
            priorityBadge.className = `badge badge-priority-${currentIssue.priority}`;

            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = currentIssue.status;
            statusBadge.className = `badge badge-status-${currentIssue.status}`;

            const categoryBadge = document.getElementById('categoryBadge');
            categoryBadge.textContent = `${currentIssue.category} > ${currentIssue.subcategory}`;
            categoryBadge.style.background = '#e5e7eb';
            categoryBadge.style.color = '#4b5563';

            // ê¸°ë³¸ ì •ë³´
            document.getElementById('category').textContent = currentIssue.category;
            document.getElementById('subcategory').textContent = currentIssue.subcategory;
            document.getElementById('priority').textContent = currentIssue.priority;
            document.getElementById('status').textContent = currentIssue.status;

            // ë¬¸ì œ ìƒí™©
            document.getElementById('description').textContent = currentIssue.description || 'ì—†ìŒ';
            const primaryWrapper = document.getElementById('primaryImageWrapper');
            const primaryImage = document.getElementById('primaryImage');
            const primaryCaption = document.getElementById('primaryImageCaption');

            if (currentIssue.images && currentIssue.images.length > 0) {
                const firstImage = currentIssue.images[0];
                if (primaryImage) {
                    primaryImage.src = firstImage.url || '';
                    primaryImage.alt = firstImage.caption || currentIssue.title || 'ì²¨ë¶€ ì´ë¯¸ì§€';
                }
                if (primaryCaption) {
                    primaryCaption.textContent = firstImage.caption || 'ì´ë¯¸ì§€ ì²¨ë¶€';
                }
                if (primaryWrapper) {
                    primaryWrapper.style.display = firstImage.url ? 'block' : 'none';
                }
            } else if (primaryWrapper) {
                primaryWrapper.style.display = 'none';
            }

            // ì›ì¸ ë¶„ì„
            if (currentIssue.cause) {
                document.getElementById('causeCard').style.display = 'block';
                document.getElementById('cause').textContent = currentIssue.cause;
            }

            // ì¡°ì¹˜ ê³„íš
            if (currentIssue.action_plan) {
                document.getElementById('actionPlanCard').style.display = 'block';
                document.getElementById('actionPlan').textContent = currentIssue.action_plan;
            }

            // ì¡°ì¹˜ ê²°ê³¼
            if (currentIssue.action_result) {
                document.getElementById('actionResultCard').style.display = 'block';
                document.getElementById('actionResult').textContent = currentIssue.action_result;
            }

            // ì»¤ìŠ¤í…€ í•„ë“œ
            if (currentIssue.customFields && Object.keys(currentIssue.customFields).length > 0) {
                renderCustomFields();
            }

            // ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
            if (currentIssue.images && currentIssue.images.length > 0) {
                renderImages();
            } else {
                const imagesCard = document.getElementById('imagesCard');
                if (imagesCard) imagesCard.style.display = 'none';
            }

            // ë‹´ë‹¹ ì •ë³´
            document.getElementById('owner').textContent = currentIssue.owner;
            document.getElementById('collaborators').textContent = currentIssue.collaborators || '-';
            document.getElementById('approver').textContent = currentIssue.approver || '-';

            // ì¼ì • ì •ë³´
            document.getElementById('requestDate').textContent = PunchListAPI.formatDate(currentIssue.request_date);

            const targetDateEl = document.getElementById('targetDate');
            targetDateEl.textContent = PunchListAPI.formatDate(currentIssue.target_date);
            if (PunchListAPI.isOverdue(currentIssue)) {
                targetDateEl.classList.add('overdue');
                targetDateEl.textContent += ' âš ï¸ ì§€ì—°';
            }

            document.getElementById('completeDate').textContent = currentIssue.complete_date
                ? PunchListAPI.formatDate(currentIssue.complete_date)
                : '-';

            // íƒ€ì„ë¼ì¸
            renderTimeline();

            // ë©”íƒ€ ì •ë³´
            document.getElementById('createdAt').textContent = PunchListAPI.formatDateTime(currentIssue.created_at);
            document.getElementById('updatedAt').textContent = PunchListAPI.formatDateTime(currentIssue.updated_at);

            if (currentIssue.templateId) {
                document.getElementById('templateInfoItem').style.display = 'block';
                document.getElementById('templateId').textContent = currentIssue.templateId;
            }
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ë Œë”ë§
        function renderCustomFields() {
            const container = document.getElementById('customFieldsContainer');
            const customFields = currentIssue.customFields;

            document.getElementById('customFieldsCard').style.display = 'block';

            container.innerHTML = Object.entries(customFields)
                .filter(([key, value]) => value !== null && value !== '' && value !== undefined)
                .map(([key, value]) => `
                    <div class="info-item">
                        <span class="info-label">${formatFieldName(key)}</span>
                        <span class="info-value">${formatFieldValue(value)}</span>
                    </div>
                `).join('');
        }

        // ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
        function renderImages() {
            const container = document.getElementById('imageGallery');
            const images = currentIssue.images;

            document.getElementById('imagesCard').style.display = 'block';

            container.innerHTML = images.map((image, index) => `
                <div class="image-item" onclick="openImageModal(${index})">
                    <img src="${image.url}" alt="${image.caption || 'ì´ë¯¸ì§€'}">
                    ${image.caption ? `<div class="image-caption">${image.caption}</div>` : ''}
                </div>
            `).join('');
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
        function openImageModal(index) {
            const image = currentIssue.images[index];
            document.getElementById('modalImage').src = image.url;
            document.getElementById('modalCaption').textContent = image.caption || '';
            document.getElementById('imageModal').classList.add('active');
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal(event) {
            if (event.target.classList.contains('image-modal') ||
                event.target.classList.contains('modal-close')) {
                document.getElementById('imageModal').classList.remove('active');
            }
        }

        // í•„ë“œëª… í¬ë§·íŒ…
        function formatFieldName(key) {
            const names = {
                'estimated_cost': 'ì˜ˆìƒ ë¹„ìš©',
                'actual_cost': 'ì‹¤ì œ ë¹„ìš©',
                'vendor_name': 'ì™¸ì£¼ì—…ì²´',
                'vendor_contact': 'ì™¸ì£¼ ë‹´ë‹¹ì',
                'equipment_serial': 'ì¥ë¹„ ì‹œë¦¬ì–¼ë²ˆí˜¸',
                'risk_level': 'ìœ„í—˜ë„',
                'defect_rate': 'ë¶ˆëŸ‰ë¥ ',
                'customer_impact': 'ê³ ê° ì˜í–¥ë„',
                'downtime_hours': 'ê°€ë™ì¤‘ë‹¨ ì‹œê°„'
            };
            return names[key] || key;
        }

        // í•„ë“œê°’ í¬ë§·íŒ…
        function formatFieldValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤';
            }
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            return value;
        }

        // íƒ€ì„ë¼ì¸ ë Œë”ë§
        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            const events = [];

            // ìƒì„±
            events.push({
                icon: 'â•',
                title: 'ì´ìŠˆ ìƒì„±',
                date: currentIssue.created_at
            });

            // ìƒíƒœ ë³€ê²½ (ê°„ë‹¨í•œ ë²„ì „)
            if (currentIssue.status === 'ì§„í–‰ì¤‘') {
                events.push({
                    icon: 'â–¶ï¸',
                    title: 'ì§„í–‰ ì‹œì‘',
                    date: currentIssue.updated_at
                });
            }

            if (currentIssue.complete_date) {
                events.push({
                    icon: 'âœ…',
                    title: 'ì‘ì—… ì™„ë£Œ',
                    date: currentIssue.complete_date
                });
            }

            timeline.innerHTML = events.map(event => `
                <li class="timeline-item">
                    <div class="timeline-icon">${event.icon}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${event.title}</div>
                        <div class="timeline-date">${PunchListAPI.formatDateTime(event.date)}</div>
                    </div>
                </li>
            `).join('');
        }

        function setSelectValue(selectId, value) {
            const select = document.getElementById(selectId);
            if (!select) return;

            if (value && !Array.from(select.options).some(option => option.value === value)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            }

            select.value = value || '';
        }

        function normalizeDate(value) {
            if (!value) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return value;
            }

            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) {
                return '';
            }

            const year = parsed.getFullYear();
            const month = String(parsed.getMonth() + 1).padStart(2, '0');
            const day = String(parsed.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function populateEditForm() {
            if (!currentIssue) return;

            const titleInput = document.getElementById('editTitle');
            if (titleInput) {
                titleInput.value = currentIssue.title || '';
            }

            setSelectValue('editPriority', currentIssue.priority || '');
            setSelectValue('editStatus', currentIssue.status || '');
            setSelectValue('editOwner', currentIssue.owner || '');

            const collaboratorsInput = document.getElementById('editCollaborators');
            if (collaboratorsInput) {
                collaboratorsInput.value = currentIssue.collaborators || '';
            }

            const approverInput = document.getElementById('editApprover');
            if (approverInput) {
                approverInput.value = currentIssue.approver || '';
            }

            const requestDateInput = document.getElementById('editRequestDate');
            if (requestDateInput) {
                requestDateInput.value = normalizeDate(currentIssue.request_date);
            }

            const targetDateInput = document.getElementById('editTargetDate');
            if (targetDateInput) {
                targetDateInput.value = normalizeDate(currentIssue.target_date);
            }

            const completeDateInput = document.getElementById('editCompleteDate');
            if (completeDateInput) {
                completeDateInput.value = normalizeDate(currentIssue.complete_date);
            }

            const descriptionInput = document.getElementById('editDescription');
            if (descriptionInput) {
                descriptionInput.value = currentIssue.description || '';
            }

            const causeInput = document.getElementById('editCause');
            if (causeInput) {
                causeInput.value = currentIssue.cause || '';
            }

            const actionPlanInput = document.getElementById('editActionPlan');
            if (actionPlanInput) {
                actionPlanInput.value = currentIssue.action_plan || '';
            }

            const actionResultInput = document.getElementById('editActionResult');
            if (actionResultInput) {
                actionResultInput.value = currentIssue.action_result || '';
            }

            resetEditImagesFromCurrentIssue();
        }

        function openEditModal() {
            populateEditForm();
            const modal = document.getElementById('editIssueModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('editIssueModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        async function handleEditSubmit(event) {
            event.preventDefault();

            if (!currentIssue) return;

            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalLabel = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'â³ ì €ì¥ ì¤‘...';
            submitButton.dataset.locked = 'true';

            if (isEditUploading()) {
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                submitButton.disabled = false;
                submitButton.textContent = originalLabel;
                submitButton.dataset.locked = '';
                return;
            }

            const failedImages = editUploadedImages.filter(img => img.status === 'error');
            if (failedImages.length > 0) {
                const proceed = confirm('ì—…ë¡œë“œì— ì‹¤íŒ¨í•œ ì´ë¯¸ì§€ê°€ ìˆìŠµë‹ˆë‹¤. ì‹¤íŒ¨í•œ ì´ë¯¸ì§€ëŠ” ì œì™¸í•˜ê³  ì €ì¥í• ê¹Œìš”?');
                if (!proceed) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalLabel;
                    submitButton.dataset.locked = '';
                    return;
                }
            }

            const successfulImages = editUploadedImages.filter(img => img.status === 'success' && img.url);
            const attachments = successfulImages.map(img => ({
                type: 'image',
                url: img.url,
                caption: img.caption || '',
                fileName: img.file ? img.file.name : '',
                public_id: img.publicId || ''
            }));

            const updatedIssue = {
                ...currentIssue,
                title: document.getElementById('editTitle').value.trim(),
                priority: document.getElementById('editPriority').value,
                status: document.getElementById('editStatus').value,
                owner: document.getElementById('editOwner').value,
                collaborators: document.getElementById('editCollaborators').value,
                approver: document.getElementById('editApprover').value,
                request_date: document.getElementById('editRequestDate').value,
                target_date: document.getElementById('editTargetDate').value,
                complete_date: document.getElementById('editCompleteDate').value,
                description: document.getElementById('editDescription').value,
                cause: document.getElementById('editCause').value,
                action_plan: document.getElementById('editActionPlan').value,
                action_result: document.getElementById('editActionResult').value,
                attachments,
                images: attachments.map(att => ({
                    url: att.url,
                    caption: att.caption,
                    public_id: att.public_id,
                    fileName: att.fileName || ''
                }))
            };

            try {
                const result = await PunchListAPI.updateIssue(updatedIssue);
                if (!result.success) {
                    throw new Error(result.error || 'ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                alert('âœ… ì´ìŠˆê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeEditModal();
                currentIssue = await PunchListAPI.loadIssueById(updatedIssue.id);
                renderIssue();
            } catch (error) {
                console.error('ì´ìŠˆ ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('âŒ ì´ìŠˆ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalLabel;
                submitButton.dataset.locked = '';
                updateEditImageUploadStatus();
            }
        }

        // ìˆ˜ì •
        function editIssue() {
            openEditModal();
        }

        // ì‚­ì œ
        async function deleteIssue() {
            if (!confirm('ì •ë§ë¡œ ì´ ì´ìŠˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await PunchListAPI.deleteIssue(currentIssue.id);
                alert('âœ… ì´ìŠˆê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = 'list.html';
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('âŒ ì´ìŠˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorState').innerHTML = `
                âš ï¸ ${message}<br>
                <a href="list.html" class="btn btn-outline" style="margin-top: var(--space-4);">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            `;
        }
    </script>
</body>
</html>
