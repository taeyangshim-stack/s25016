<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìŠˆ ìƒì„¸ - S25016 í€ì¹˜ë¦¬ìŠ¤íŠ¸</title>

    <link rel="stylesheet" href="../../shared/styles/variables.css">
    <link rel="stylesheet" href="../../shared/styles/reset.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">

    <style>
        body {
            background: var(--color-gray-50);
            min-height: 100vh;
            padding: var(--space-5);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--color-white);
            padding: var(--space-6);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
        }

        .title-section h1 {
            font-size: var(--font-2xl);
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .issue-id {
            font-size: var(--font-base);
            color: var(--color-gray-500);
            font-weight: normal;
        }

        .actions {
            display: flex;
            gap: var(--space-3);
        }

        .badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--border-radius-base);
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-6);
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .card-title {
            font-size: var(--font-lg);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
            margin-bottom: var(--space-1);
        }

        .info-value {
            font-size: var(--font-base);
            color: var(--color-gray-900);
            font-weight: var(--font-medium);
        }

        .description-section {
            margin-top: var(--space-4);
        }

        .description-label {
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
            color: var(--color-gray-700);
            margin-bottom: var(--space-2);
        }

        .description-text {
            font-size: var(--font-base);
            color: var(--color-gray-800);
            line-height: 1.6;
            white-space: pre-wrap;
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius-base);
        }

        .custom-fields-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .timeline {
            list-style: none;
            padding: 0;
        }

        .timeline-item {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .timeline-icon {
            width: 32px;
            height: 32px;
            background: var(--color-primary);
            color: var(--color-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-sm);
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .timeline-date {
            font-size: var(--font-sm);
            color: var(--color-gray-500);
        }

        .loading {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-gray-500);
        }

        .error {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-danger);
        }

        .overdue {
            color: var(--color-danger);
        }

        .empty-text {
            color: var(--color-gray-400);
            font-style: italic;
        }

        /* ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .image-item {
            position: relative;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            background: var(--color-gray-100);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-item:hover {
            transform: scale(1.05);
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-caption {
            padding: var(--space-2);
            font-size: var(--font-sm);
            color: var(--color-gray-700);
            background: var(--color-white);
            text-align: center;
        }

        /* ì´ë¯¸ì§€ ëª¨ë‹¬ */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .image-modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90vh;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 36px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .edit-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            z-index: 1200;
            padding: var(--space-6);
            overflow-y: auto;
        }

        .edit-modal.active {
            display: block;
        }

        .edit-modal .modal-card {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 720px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .edit-modal-title {
            font-size: var(--font-xl);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: var(--font-2xl);
            color: var(--color-gray-500);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .modal-close-btn:hover {
            color: var(--color-gray-700);
        }

        .edit-form .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .edit-form .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .edit-form .form-group.full {
            grid-column: 1 / -1;
        }

        .edit-form label {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
            font-weight: var(--font-medium);
        }

        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-base);
            font-size: var(--font-base);
            transition: var(--transition-base);
        }

        .edit-form input:focus,
        .edit-form select:focus,
        .edit-form textarea:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .edit-form textarea {
            min-height: 110px;
            resize: vertical;
        }

        .edit-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        .edit-form-actions .btn {
            min-width: 120px;
        }

        .modal-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: var(--space-3);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingState" class="loading">
            â³ ì´ìŠˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <div id="errorState" class="error" style="display: none;">
            âš ï¸ ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
            <a href="list.html" class="btn btn-outline" style="margin-top: var(--space-4);">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div id="contentArea" style="display: none;">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="header-top">
                    <div class="title-section">
                        <h1>
                            <span class="issue-id" id="issueId"></span>
                            <span id="issueTitle"></span>
                        </h1>
                        <div style="display: flex; gap: var(--space-2); margin-top: var(--space-3);">
                            <span class="badge" id="priorityBadge"></span>
                            <span class="badge" id="statusBadge"></span>
                            <span class="badge" id="categoryBadge"></span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="editIssue()">âœï¸ ìˆ˜ì •</button>
                        <button class="btn btn-outline" onclick="deleteIssue()">ğŸ—‘ï¸ ì‚­ì œ</button>
                        <a href="list.html" class="btn btn-outline">ğŸ“‹ ëª©ë¡</a>
                    </div>
                </div>
            </div>

            <!-- ì½˜í…ì¸  ê·¸ë¦¬ë“œ -->
            <div class="content-grid">
                <!-- ì™¼ìª½ ì—´ -->
                <div>
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">ë¶„ë¥˜</span>
                                <span class="info-value" id="category"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì„¸ë¶€ë¶„ë¥˜</span>
                                <span class="info-value" id="subcategory"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìš°ì„ ìˆœìœ„</span>
                                <span class="info-value" id="priority"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìƒíƒœ</span>
                                <span class="info-value" id="status"></span>
                            </div>
                        </div>
                    </div>

                    <!-- ë¬¸ì œ ìƒí™© -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“ ë¬¸ì œ ìƒí™©</h2>
                        <div class="description-text" id="description"></div>
                    </div>

                    <!-- ì›ì¸ ë¶„ì„ -->
                    <div class="card" id="causeCard" style="display: none;">
                        <h2 class="card-title">ğŸ” ì›ì¸ ë¶„ì„</h2>
                        <div class="description-text" id="cause"></div>
                    </div>

                    <!-- ì¡°ì¹˜ ê³„íš -->
                    <div class="card" id="actionPlanCard" style="display: none;">
                        <h2 class="card-title">ğŸ”§ ì¡°ì¹˜ ê³„íš</h2>
                        <div class="description-text" id="actionPlan"></div>
                    </div>

                    <!-- ì¡°ì¹˜ ê²°ê³¼ -->
                    <div class="card" id="actionResultCard" style="display: none;">
                        <h2 class="card-title">âœ… ì¡°ì¹˜ ê²°ê³¼</h2>
                        <div class="description-text" id="actionResult"></div>
                    </div>

                    <!-- ì»¤ìŠ¤í…€ í•„ë“œ -->
                    <div class="card" id="customFieldsCard" style="display: none;">
                        <h2 class="card-title">âš™ï¸ ì¶”ê°€ ì •ë³´</h2>
                        <div class="custom-fields-grid" id="customFieldsContainer"></div>
                    </div>

                    <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
                    <div class="card" id="imagesCard" style="display: none;">
                        <h2 class="card-title">ğŸ“· ì²¨ë¶€ ì´ë¯¸ì§€</h2>
                        <div class="image-gallery" id="imageGallery"></div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì—´ -->
                <div>
                    <!-- ë‹´ë‹¹ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ‘¥ ë‹´ë‹¹ ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ë‹´ë‹¹ì</span>
                            <span class="info-value" id="owner"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">í˜‘ì˜ì</span>
                            <span class="info-value" id="collaborators"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ìŠ¹ì¸ì</span>
                            <span class="info-value" id="approver"></span>
                        </div>
                    </div>

                    <!-- ì¼ì • ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“… ì¼ì • ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìš”ì²­ì¼</span>
                            <span class="info-value" id="requestDate"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ëª©í‘œ ì™„ë£Œì¼</span>
                            <span class="info-value" id="targetDate"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ì‹¤ì œ ì™„ë£Œì¼</span>
                            <span class="info-value" id="completeDate"></span>
                        </div>
                    </div>

                    <!-- íƒ€ì„ë¼ì¸ -->
                    <div class="card">
                        <h2 class="card-title">â±ï¸ íƒ€ì„ë¼ì¸</h2>
                        <ul class="timeline" id="timeline"></ul>
                    </div>

                    <!-- ë©”íƒ€ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">â„¹ï¸ ë©”íƒ€ ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìƒì„±ì¼ì‹œ</span>
                            <span class="info-value" id="createdAt"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìˆ˜ì •ì¼ì‹œ</span>
                            <span class="info-value" id="updatedAt"></span>
                        </div>
                        <div class="info-item" id="templateInfoItem" style="display: none;">
                            <span class="info-label">í…œí”Œë¦¿</span>
                            <span class="info-value" id="templateId"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal(event)">
        <button class="modal-close" onclick="closeImageModal(event)">Ã—</button>
        <div class="modal-content">
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-caption" id="modalCaption"></div>
        </div>
    </div>

    <!-- ì´ìŠˆ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="edit-modal" id="editIssueModal">
        <div class="modal-card">
            <div class="edit-modal-header">
                <h2 class="edit-modal-title">ì´ìŠˆ ìˆ˜ì •</h2>
                <button type="button" class="modal-close-btn" onclick="closeEditModal()">Ã—</button>
            </div>
            <form id="editIssueForm" class="edit-form">
                <div class="form-row">
                    <div class="form-group full">
                        <label for="editTitle">ì œëª©</label>
                        <input type="text" id="editTitle" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPriority">ìš°ì„ ìˆœìœ„</label>
                        <select id="editPriority"></select>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">ìƒíƒœ</label>
                        <select id="editStatus"></select>
                    </div>
                    <div class="form-group">
                        <label for="editOwner">ë‹´ë‹¹ì</label>
                        <select id="editOwner"></select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editCollaborators">í˜‘ì˜ì</label>
                        <input type="text" id="editCollaborators">
                    </div>
                    <div class="form-group">
                        <label for="editApprover">ìŠ¹ì¸ì</label>
                        <input type="text" id="editApprover">
                    </div>
                </div>

                    <div class="form-row">
                    <div class="form-group">
                        <label for="editRequestDate">ìš”ì²­ì¼</label>
                        <input type="date" id="editRequestDate">
                    </div>
                    <div class="form-group">
                        <label for="editTargetDate">ëª©í‘œì¼</label>
                        <input type="date" id="editTargetDate">
                    </div>
                    <div class="form-group">
                        <label for="editCompleteDate">ì™„ë£Œì¼</label>
                        <input type="date" id="editCompleteDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editDescription">ë¬¸ì œ ìƒí™©</label>
                        <textarea id="editDescription"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editCause">ì›ì¸ ë¶„ì„</label>
                        <textarea id="editCause"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editActionPlan">ì¡°ì¹˜ ê³„íš</label>
                        <textarea id="editActionPlan"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full">
                        <label for="editActionResult">ì¡°ì¹˜ ê²°ê³¼</label>
                        <textarea id="editActionResult"></textarea>
                    </div>
                </div>

                <div class="edit-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../shared/scripts/utils.js"></script>
    <script src="../scripts/config-loader.js"></script>
    <script src="../scripts/punchlist.js"></script>
    <script>
        let currentIssue = null;
        let editFormInitialized = false;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const issueId = urlParams.get('id');

            if (!issueId) {
                showError('ì´ìŠˆ IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            await setupEditForm();
            await loadIssue(issueId);
        });

        async function setupEditForm() {
            if (editFormInitialized) return;

            const statusSelect = document.getElementById('editStatus');
            const prioritySelect = document.getElementById('editPriority');
            const ownerSelect = document.getElementById('editOwner');

            if (statusSelect) {
                PunchListAPI.STATUSES.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusSelect.appendChild(option);
                });
            }

            if (prioritySelect) {
                PunchListAPI.PRIORITIES.forEach(priority => {
                    const option = document.createElement('option');
                    option.value = priority;
                    option.textContent = priority;
                    prioritySelect.appendChild(option);
                });
            }

            if (ownerSelect) {
                await PunchListAPI.ensureOwnersLoaded();
                PunchListAPI.getOwnerNames().forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    ownerSelect.appendChild(option);
                });
            }

            const editForm = document.getElementById('editIssueForm');
            if (editForm) {
                editForm.addEventListener('submit', handleEditSubmit);
            }

            editFormInitialized = true;
        }

        // ì´ìŠˆ ë¡œë“œ
        async function loadIssue(id) {
            try {
                currentIssue = await PunchListAPI.loadIssueById(id);
                renderIssue();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('contentArea').style.display = 'block';
            } catch (error) {
                console.error('ì´ìŠˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ìŠˆ ë Œë”ë§
        function renderIssue() {
            // í—¤ë”
            document.getElementById('issueId').textContent = currentIssue.id;
            document.getElementById('issueTitle').textContent = currentIssue.title;

            // ë°°ì§€
            const priorityBadge = document.getElementById('priorityBadge');
            priorityBadge.textContent = currentIssue.priority;
            priorityBadge.className = `badge badge-priority-${currentIssue.priority}`;

            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = currentIssue.status;
            statusBadge.className = `badge badge-status-${currentIssue.status}`;

            const categoryBadge = document.getElementById('categoryBadge');
            categoryBadge.textContent = `${currentIssue.category} > ${currentIssue.subcategory}`;
            categoryBadge.style.background = '#e5e7eb';
            categoryBadge.style.color = '#4b5563';

            // ê¸°ë³¸ ì •ë³´
            document.getElementById('category').textContent = currentIssue.category;
            document.getElementById('subcategory').textContent = currentIssue.subcategory;
            document.getElementById('priority').textContent = currentIssue.priority;
            document.getElementById('status').textContent = currentIssue.status;

            // ë¬¸ì œ ìƒí™©
            document.getElementById('description').textContent = currentIssue.description || 'ì—†ìŒ';

            // ì›ì¸ ë¶„ì„
            if (currentIssue.cause) {
                document.getElementById('causeCard').style.display = 'block';
                document.getElementById('cause').textContent = currentIssue.cause;
            }

            // ì¡°ì¹˜ ê³„íš
            if (currentIssue.action_plan) {
                document.getElementById('actionPlanCard').style.display = 'block';
                document.getElementById('actionPlan').textContent = currentIssue.action_plan;
            }

            // ì¡°ì¹˜ ê²°ê³¼
            if (currentIssue.action_result) {
                document.getElementById('actionResultCard').style.display = 'block';
                document.getElementById('actionResult').textContent = currentIssue.action_result;
            }

            // ì»¤ìŠ¤í…€ í•„ë“œ
            if (currentIssue.customFields && Object.keys(currentIssue.customFields).length > 0) {
                renderCustomFields();
            }

            // ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
            if (currentIssue.images && currentIssue.images.length > 0) {
                renderImages();
            }

            // ë‹´ë‹¹ ì •ë³´
            document.getElementById('owner').textContent = currentIssue.owner;
            document.getElementById('collaborators').textContent = currentIssue.collaborators || '-';
            document.getElementById('approver').textContent = currentIssue.approver || '-';

            // ì¼ì • ì •ë³´
            document.getElementById('requestDate').textContent = PunchListAPI.formatDate(currentIssue.request_date);

            const targetDateEl = document.getElementById('targetDate');
            targetDateEl.textContent = PunchListAPI.formatDate(currentIssue.target_date);
            if (PunchListAPI.isOverdue(currentIssue)) {
                targetDateEl.classList.add('overdue');
                targetDateEl.textContent += ' âš ï¸ ì§€ì—°';
            }

            document.getElementById('completeDate').textContent = currentIssue.complete_date
                ? PunchListAPI.formatDate(currentIssue.complete_date)
                : '-';

            // íƒ€ì„ë¼ì¸
            renderTimeline();

            // ë©”íƒ€ ì •ë³´
            document.getElementById('createdAt').textContent = PunchListAPI.formatDateTime(currentIssue.created_at);
            document.getElementById('updatedAt').textContent = PunchListAPI.formatDateTime(currentIssue.updated_at);

            if (currentIssue.templateId) {
                document.getElementById('templateInfoItem').style.display = 'block';
                document.getElementById('templateId').textContent = currentIssue.templateId;
            }
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ë Œë”ë§
        function renderCustomFields() {
            const container = document.getElementById('customFieldsContainer');
            const customFields = currentIssue.customFields;

            document.getElementById('customFieldsCard').style.display = 'block';

            container.innerHTML = Object.entries(customFields)
                .filter(([key, value]) => value !== null && value !== '' && value !== undefined)
                .map(([key, value]) => `
                    <div class="info-item">
                        <span class="info-label">${formatFieldName(key)}</span>
                        <span class="info-value">${formatFieldValue(value)}</span>
                    </div>
                `).join('');
        }

        // ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
        function renderImages() {
            const container = document.getElementById('imageGallery');
            const images = currentIssue.images;

            document.getElementById('imagesCard').style.display = 'block';

            container.innerHTML = images.map((image, index) => `
                <div class="image-item" onclick="openImageModal(${index})">
                    <img src="${image.url}" alt="${image.caption || 'ì´ë¯¸ì§€'}">
                    ${image.caption ? `<div class="image-caption">${image.caption}</div>` : ''}
                </div>
            `).join('');
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
        function openImageModal(index) {
            const image = currentIssue.images[index];
            document.getElementById('modalImage').src = image.url;
            document.getElementById('modalCaption').textContent = image.caption || '';
            document.getElementById('imageModal').classList.add('active');
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal(event) {
            if (event.target.classList.contains('image-modal') ||
                event.target.classList.contains('modal-close')) {
                document.getElementById('imageModal').classList.remove('active');
            }
        }

        // í•„ë“œëª… í¬ë§·íŒ…
        function formatFieldName(key) {
            const names = {
                'estimated_cost': 'ì˜ˆìƒ ë¹„ìš©',
                'actual_cost': 'ì‹¤ì œ ë¹„ìš©',
                'vendor_name': 'ì™¸ì£¼ì—…ì²´',
                'vendor_contact': 'ì™¸ì£¼ ë‹´ë‹¹ì',
                'equipment_serial': 'ì¥ë¹„ ì‹œë¦¬ì–¼ë²ˆí˜¸',
                'risk_level': 'ìœ„í—˜ë„',
                'defect_rate': 'ë¶ˆëŸ‰ë¥ ',
                'customer_impact': 'ê³ ê° ì˜í–¥ë„',
                'downtime_hours': 'ê°€ë™ì¤‘ë‹¨ ì‹œê°„'
            };
            return names[key] || key;
        }

        // í•„ë“œê°’ í¬ë§·íŒ…
        function formatFieldValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤';
            }
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            return value;
        }

        // íƒ€ì„ë¼ì¸ ë Œë”ë§
        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            const events = [];

            // ìƒì„±
            events.push({
                icon: 'â•',
                title: 'ì´ìŠˆ ìƒì„±',
                date: currentIssue.created_at
            });

            // ìƒíƒœ ë³€ê²½ (ê°„ë‹¨í•œ ë²„ì „)
            if (currentIssue.status === 'ì§„í–‰ì¤‘') {
                events.push({
                    icon: 'â–¶ï¸',
                    title: 'ì§„í–‰ ì‹œì‘',
                    date: currentIssue.updated_at
                });
            }

            if (currentIssue.complete_date) {
                events.push({
                    icon: 'âœ…',
                    title: 'ì‘ì—… ì™„ë£Œ',
                    date: currentIssue.complete_date
                });
            }

            timeline.innerHTML = events.map(event => `
                <li class="timeline-item">
                    <div class="timeline-icon">${event.icon}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${event.title}</div>
                        <div class="timeline-date">${PunchListAPI.formatDateTime(event.date)}</div>
                    </div>
                </li>
            `).join('');
        }

        function setSelectValue(selectId, value) {
            const select = document.getElementById(selectId);
            if (!select) return;

            if (value && !Array.from(select.options).some(option => option.value === value)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            }

            select.value = value || '';
        }

        function normalizeDate(value) {
            if (!value) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return value;
            }

            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) {
                return '';
            }

            const year = parsed.getFullYear();
            const month = String(parsed.getMonth() + 1).padStart(2, '0');
            const day = String(parsed.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function populateEditForm() {
            if (!currentIssue) return;

            const titleInput = document.getElementById('editTitle');
            if (titleInput) {
                titleInput.value = currentIssue.title || '';
            }

            setSelectValue('editPriority', currentIssue.priority || '');
            setSelectValue('editStatus', currentIssue.status || '');
            setSelectValue('editOwner', currentIssue.owner || '');

            const collaboratorsInput = document.getElementById('editCollaborators');
            if (collaboratorsInput) {
                collaboratorsInput.value = currentIssue.collaborators || '';
            }

            const approverInput = document.getElementById('editApprover');
            if (approverInput) {
                approverInput.value = currentIssue.approver || '';
            }

            const requestDateInput = document.getElementById('editRequestDate');
            if (requestDateInput) {
                requestDateInput.value = normalizeDate(currentIssue.request_date);
            }

            const targetDateInput = document.getElementById('editTargetDate');
            if (targetDateInput) {
                targetDateInput.value = normalizeDate(currentIssue.target_date);
            }

            const completeDateInput = document.getElementById('editCompleteDate');
            if (completeDateInput) {
                completeDateInput.value = normalizeDate(currentIssue.complete_date);
            }

            const descriptionInput = document.getElementById('editDescription');
            if (descriptionInput) {
                descriptionInput.value = currentIssue.description || '';
            }

            const causeInput = document.getElementById('editCause');
            if (causeInput) {
                causeInput.value = currentIssue.cause || '';
            }

            const actionPlanInput = document.getElementById('editActionPlan');
            if (actionPlanInput) {
                actionPlanInput.value = currentIssue.action_plan || '';
            }

            const actionResultInput = document.getElementById('editActionResult');
            if (actionResultInput) {
                actionResultInput.value = currentIssue.action_result || '';
            }
        }

        function openEditModal() {
            populateEditForm();
            const modal = document.getElementById('editIssueModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('editIssueModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        async function handleEditSubmit(event) {
            event.preventDefault();

            if (!currentIssue) return;

            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalLabel = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'â³ ì €ì¥ ì¤‘...';

            const updatedIssue = {
                ...currentIssue,
                title: document.getElementById('editTitle').value.trim(),
                priority: document.getElementById('editPriority').value,
                status: document.getElementById('editStatus').value,
                owner: document.getElementById('editOwner').value,
                collaborators: document.getElementById('editCollaborators').value,
                approver: document.getElementById('editApprover').value,
                request_date: document.getElementById('editRequestDate').value,
                target_date: document.getElementById('editTargetDate').value,
                complete_date: document.getElementById('editCompleteDate').value,
                description: document.getElementById('editDescription').value,
                cause: document.getElementById('editCause').value,
                action_plan: document.getElementById('editActionPlan').value,
                action_result: document.getElementById('editActionResult').value
            };

            try {
                const result = await PunchListAPI.updateIssue(updatedIssue);
                if (!result.success) {
                    throw new Error(result.error || 'ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                alert('âœ… ì´ìŠˆê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeEditModal();
                currentIssue = await PunchListAPI.loadIssueById(updatedIssue.id);
                renderIssue();
            } catch (error) {
                console.error('ì´ìŠˆ ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('âŒ ì´ìŠˆ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalLabel;
            }
        }

        // ìˆ˜ì •
        function editIssue() {
            openEditModal();
        }

        // ì‚­ì œ
        async function deleteIssue() {
            if (!confirm('ì •ë§ë¡œ ì´ ì´ìŠˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await PunchListAPI.deleteIssue(currentIssue.id);
                alert('âœ… ì´ìŠˆê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = 'list.html';
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('âŒ ì´ìŠˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorState').innerHTML = `
                âš ï¸ ${message}<br>
                <a href="list.html" class="btn btn-outline" style="margin-top: var(--space-4);">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            `;
        }
    </script>
</body>
</html>
