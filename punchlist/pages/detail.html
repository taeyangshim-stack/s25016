<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìŠˆ ìƒì„¸ - S25016 í€ì¹˜ë¦¬ìŠ¤íŠ¸</title>

    <link rel="stylesheet" href="../../shared/styles/variables.css">
    <link rel="stylesheet" href="../../shared/styles/reset.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">

    <style>
        body {
            background: var(--color-gray-50);
            min-height: 100vh;
            padding: var(--space-5);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--color-white);
            padding: var(--space-6);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
        }

        .title-section h1 {
            font-size: var(--font-2xl);
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
        }

        .issue-id {
            font-size: var(--font-base);
            color: var(--color-gray-500);
            font-weight: normal;
        }

        .actions {
            display: flex;
            gap: var(--space-3);
        }

        .badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--border-radius-base);
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-6);
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .card-title {
            font-size: var(--font-lg);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
            margin-bottom: var(--space-1);
        }

        .info-value {
            font-size: var(--font-base);
            color: var(--color-gray-900);
            font-weight: var(--font-medium);
        }

        .description-section {
            margin-top: var(--space-4);
        }

        .description-label {
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
            color: var(--color-gray-700);
            margin-bottom: var(--space-2);
        }

        .description-text {
            font-size: var(--font-base);
            color: var(--color-gray-800);
            line-height: 1.6;
            white-space: pre-wrap;
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius-base);
        }

        .custom-fields-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .timeline {
            list-style: none;
            padding: 0;
        }

        .timeline-item {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .timeline-icon {
            width: 32px;
            height: 32px;
            background: var(--color-primary);
            color: var(--color-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-sm);
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .timeline-date {
            font-size: var(--font-sm);
            color: var(--color-gray-500);
        }

        .loading {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-gray-500);
        }

        .error {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-danger);
        }

        .overdue {
            color: var(--color-danger);
        }

        .empty-text {
            color: var(--color-gray-400);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingState" class="loading">
            â³ ì´ìŠˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <div id="errorState" class="error" style="display: none;">
            âš ï¸ ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
            <a href="list.html" class="btn btn-outline" style="margin-top: var(--space-4);">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div id="contentArea" style="display: none;">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="header-top">
                    <div class="title-section">
                        <h1>
                            <span class="issue-id" id="issueId"></span>
                            <span id="issueTitle"></span>
                        </h1>
                        <div style="display: flex; gap: var(--space-2); margin-top: var(--space-3);">
                            <span class="badge" id="priorityBadge"></span>
                            <span class="badge" id="statusBadge"></span>
                            <span class="badge" id="categoryBadge"></span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="editIssue()">âœï¸ ìˆ˜ì •</button>
                        <button class="btn btn-outline" onclick="deleteIssue()">ğŸ—‘ï¸ ì‚­ì œ</button>
                        <a href="list.html" class="btn btn-outline">ğŸ“‹ ëª©ë¡</a>
                    </div>
                </div>
            </div>

            <!-- ì½˜í…ì¸  ê·¸ë¦¬ë“œ -->
            <div class="content-grid">
                <!-- ì™¼ìª½ ì—´ -->
                <div>
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">ë¶„ë¥˜</span>
                                <span class="info-value" id="category"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì„¸ë¶€ë¶„ë¥˜</span>
                                <span class="info-value" id="subcategory"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìš°ì„ ìˆœìœ„</span>
                                <span class="info-value" id="priority"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìƒíƒœ</span>
                                <span class="info-value" id="status"></span>
                            </div>
                        </div>
                    </div>

                    <!-- ë¬¸ì œ ìƒí™© -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“ ë¬¸ì œ ìƒí™©</h2>
                        <div class="description-text" id="description"></div>
                    </div>

                    <!-- ì›ì¸ ë¶„ì„ -->
                    <div class="card" id="causeCard" style="display: none;">
                        <h2 class="card-title">ğŸ” ì›ì¸ ë¶„ì„</h2>
                        <div class="description-text" id="cause"></div>
                    </div>

                    <!-- ì¡°ì¹˜ ê³„íš -->
                    <div class="card" id="actionPlanCard" style="display: none;">
                        <h2 class="card-title">ğŸ”§ ì¡°ì¹˜ ê³„íš</h2>
                        <div class="description-text" id="actionPlan"></div>
                    </div>

                    <!-- ì¡°ì¹˜ ê²°ê³¼ -->
                    <div class="card" id="actionResultCard" style="display: none;">
                        <h2 class="card-title">âœ… ì¡°ì¹˜ ê²°ê³¼</h2>
                        <div class="description-text" id="actionResult"></div>
                    </div>

                    <!-- ì»¤ìŠ¤í…€ í•„ë“œ -->
                    <div class="card" id="customFieldsCard" style="display: none;">
                        <h2 class="card-title">âš™ï¸ ì¶”ê°€ ì •ë³´</h2>
                        <div class="custom-fields-grid" id="customFieldsContainer"></div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì—´ -->
                <div>
                    <!-- ë‹´ë‹¹ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ‘¥ ë‹´ë‹¹ ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ë‹´ë‹¹ì</span>
                            <span class="info-value" id="owner"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">í˜‘ì˜ì</span>
                            <span class="info-value" id="collaborators"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ìŠ¹ì¸ì</span>
                            <span class="info-value" id="approver"></span>
                        </div>
                    </div>

                    <!-- ì¼ì • ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“… ì¼ì • ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìš”ì²­ì¼</span>
                            <span class="info-value" id="requestDate"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ëª©í‘œ ì™„ë£Œì¼</span>
                            <span class="info-value" id="targetDate"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ì‹¤ì œ ì™„ë£Œì¼</span>
                            <span class="info-value" id="completeDate"></span>
                        </div>
                    </div>

                    <!-- íƒ€ì„ë¼ì¸ -->
                    <div class="card">
                        <h2 class="card-title">â±ï¸ íƒ€ì„ë¼ì¸</h2>
                        <ul class="timeline" id="timeline"></ul>
                    </div>

                    <!-- ë©”íƒ€ ì •ë³´ -->
                    <div class="card">
                        <h2 class="card-title">â„¹ï¸ ë©”íƒ€ ì •ë³´</h2>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìƒì„±ì¼ì‹œ</span>
                            <span class="info-value" id="createdAt"></span>
                        </div>
                        <div class="info-item" style="margin-bottom: var(--space-3);">
                            <span class="info-label">ìˆ˜ì •ì¼ì‹œ</span>
                            <span class="info-value" id="updatedAt"></span>
                        </div>
                        <div class="info-item" id="templateInfoItem" style="display: none;">
                            <span class="info-label">í…œí”Œë¦¿</span>
                            <span class="info-value" id="templateId"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../../shared/scripts/utils.js"></script>
    <script src="../scripts/config-loader.js"></script>
    <script src="../scripts/punchlist.js"></script>
    <script>
        let currentIssue = null;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const issueId = urlParams.get('id');

            if (!issueId) {
                showError('ì´ìŠˆ IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            await loadIssue(issueId);
        });

        // ì´ìŠˆ ë¡œë“œ
        async function loadIssue(id) {
            try {
                currentIssue = await PunchListAPI.loadIssueById(id);
                renderIssue();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('contentArea').style.display = 'block';
            } catch (error) {
                console.error('ì´ìŠˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ìŠˆ ë Œë”ë§
        function renderIssue() {
            // í—¤ë”
            document.getElementById('issueId').textContent = currentIssue.id;
            document.getElementById('issueTitle').textContent = currentIssue.title;

            // ë°°ì§€
            const priorityBadge = document.getElementById('priorityBadge');
            priorityBadge.textContent = currentIssue.priority;
            priorityBadge.className = `badge badge-priority-${currentIssue.priority}`;

            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = currentIssue.status;
            statusBadge.className = `badge badge-status-${currentIssue.status}`;

            const categoryBadge = document.getElementById('categoryBadge');
            categoryBadge.textContent = `${currentIssue.category} > ${currentIssue.subcategory}`;
            categoryBadge.style.background = '#e5e7eb';
            categoryBadge.style.color = '#4b5563';

            // ê¸°ë³¸ ì •ë³´
            document.getElementById('category').textContent = currentIssue.category;
            document.getElementById('subcategory').textContent = currentIssue.subcategory;
            document.getElementById('priority').textContent = currentIssue.priority;
            document.getElementById('status').textContent = currentIssue.status;

            // ë¬¸ì œ ìƒí™©
            document.getElementById('description').textContent = currentIssue.description || 'ì—†ìŒ';

            // ì›ì¸ ë¶„ì„
            if (currentIssue.cause) {
                document.getElementById('causeCard').style.display = 'block';
                document.getElementById('cause').textContent = currentIssue.cause;
            }

            // ì¡°ì¹˜ ê³„íš
            if (currentIssue.action_plan) {
                document.getElementById('actionPlanCard').style.display = 'block';
                document.getElementById('actionPlan').textContent = currentIssue.action_plan;
            }

            // ì¡°ì¹˜ ê²°ê³¼
            if (currentIssue.action_result) {
                document.getElementById('actionResultCard').style.display = 'block';
                document.getElementById('actionResult').textContent = currentIssue.action_result;
            }

            // ì»¤ìŠ¤í…€ í•„ë“œ
            if (currentIssue.customFields && Object.keys(currentIssue.customFields).length > 0) {
                renderCustomFields();
            }

            // ë‹´ë‹¹ ì •ë³´
            document.getElementById('owner').textContent = currentIssue.owner;
            document.getElementById('collaborators').textContent = currentIssue.collaborators || '-';
            document.getElementById('approver').textContent = currentIssue.approver || '-';

            // ì¼ì • ì •ë³´
            document.getElementById('requestDate').textContent = PunchListAPI.formatDate(currentIssue.request_date);

            const targetDateEl = document.getElementById('targetDate');
            targetDateEl.textContent = PunchListAPI.formatDate(currentIssue.target_date);
            if (PunchListAPI.isOverdue(currentIssue)) {
                targetDateEl.classList.add('overdue');
                targetDateEl.textContent += ' âš ï¸ ì§€ì—°';
            }

            document.getElementById('completeDate').textContent = currentIssue.complete_date
                ? PunchListAPI.formatDate(currentIssue.complete_date)
                : '-';

            // íƒ€ì„ë¼ì¸
            renderTimeline();

            // ë©”íƒ€ ì •ë³´
            document.getElementById('createdAt').textContent = PunchListAPI.formatDateTime(currentIssue.created_at);
            document.getElementById('updatedAt').textContent = PunchListAPI.formatDateTime(currentIssue.updated_at);

            if (currentIssue.templateId) {
                document.getElementById('templateInfoItem').style.display = 'block';
                document.getElementById('templateId').textContent = currentIssue.templateId;
            }
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ë Œë”ë§
        function renderCustomFields() {
            const container = document.getElementById('customFieldsContainer');
            const customFields = currentIssue.customFields;

            document.getElementById('customFieldsCard').style.display = 'block';

            container.innerHTML = Object.entries(customFields)
                .filter(([key, value]) => value !== null && value !== '' && value !== undefined)
                .map(([key, value]) => `
                    <div class="info-item">
                        <span class="info-label">${formatFieldName(key)}</span>
                        <span class="info-value">${formatFieldValue(value)}</span>
                    </div>
                `).join('');
        }

        // í•„ë“œëª… í¬ë§·íŒ…
        function formatFieldName(key) {
            const names = {
                'estimated_cost': 'ì˜ˆìƒ ë¹„ìš©',
                'actual_cost': 'ì‹¤ì œ ë¹„ìš©',
                'vendor_name': 'ì™¸ì£¼ì—…ì²´',
                'vendor_contact': 'ì™¸ì£¼ ë‹´ë‹¹ì',
                'equipment_serial': 'ì¥ë¹„ ì‹œë¦¬ì–¼ë²ˆí˜¸',
                'risk_level': 'ìœ„í—˜ë„',
                'defect_rate': 'ë¶ˆëŸ‰ë¥ ',
                'customer_impact': 'ê³ ê° ì˜í–¥ë„',
                'downtime_hours': 'ê°€ë™ì¤‘ë‹¨ ì‹œê°„'
            };
            return names[key] || key;
        }

        // í•„ë“œê°’ í¬ë§·íŒ…
        function formatFieldValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤';
            }
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            return value;
        }

        // íƒ€ì„ë¼ì¸ ë Œë”ë§
        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            const events = [];

            // ìƒì„±
            events.push({
                icon: 'â•',
                title: 'ì´ìŠˆ ìƒì„±',
                date: currentIssue.created_at
            });

            // ìƒíƒœ ë³€ê²½ (ê°„ë‹¨í•œ ë²„ì „)
            if (currentIssue.status === 'ì§„í–‰ì¤‘') {
                events.push({
                    icon: 'â–¶ï¸',
                    title: 'ì§„í–‰ ì‹œì‘',
                    date: currentIssue.updated_at
                });
            }

            if (currentIssue.complete_date) {
                events.push({
                    icon: 'âœ…',
                    title: 'ì‘ì—… ì™„ë£Œ',
                    date: currentIssue.complete_date
                });
            }

            timeline.innerHTML = events.map(event => `
                <li class="timeline-item">
                    <div class="timeline-icon">${event.icon}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${event.title}</div>
                        <div class="timeline-date">${PunchListAPI.formatDateTime(event.date)}</div>
                    </div>
                </li>
            `).join('');
        }

        // ìˆ˜ì •
        function editIssue() {
            // í–¥í›„ êµ¬í˜„: ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
            alert('ìˆ˜ì • ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ì‚­ì œ
        async function deleteIssue() {
            if (!confirm('ì •ë§ë¡œ ì´ ì´ìŠˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await PunchListAPI.deleteIssue(currentIssue.id);
                alert('âœ… ì´ìŠˆê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = 'list.html';
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('âŒ ì´ìŠˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorState').innerHTML = `
                âš ï¸ ${message}<br>
                <a href="list.html" class="btn btn-outline" style="margin-top: var(--space-4);">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            `;
        }
    </script>
</body>
</html>
