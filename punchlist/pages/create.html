<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒˆ ì´ìŠˆ ë“±ë¡ - S25016 í€ì¹˜ë¦¬ìŠ¤íŠ¸</title>

    <link rel="stylesheet" href="../../shared/styles/variables.css">
    <link rel="stylesheet" href="../../shared/styles/reset.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: var(--space-5);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .header {
            background: var(--color-primary-gradient);
            color: var(--color-white);
            padding: var(--space-8);
            text-align: center;
        }

        /* í…œí”Œë¦¿ ì„ íƒ */
        .template-selection {
            padding: var(--space-8);
            background: var(--color-gray-50);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .template-card {
            background: var(--color-white);
            padding: var(--space-5);
            border-radius: var(--border-radius-lg);
            border: 2px solid var(--color-gray-300);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .template-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .template-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }

        .template-name {
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-2);
        }

        .template-description {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
        }

        /* í¼ */
        .form-content {
            padding: var(--space-8);
        }

        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-group label {
            display: block;
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-2);
            color: var(--color-gray-700);
        }

        .form-group label .required {
            color: var(--color-danger);
        }

        .form-group label .helper {
            font-weight: normal;
            font-size: var(--font-sm);
            color: var(--color-gray-500);
            margin-left: var(--space-2);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-base);
            font-size: var(--font-base);
            transition: var(--transition-base);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .button-group {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-8);
        }

        .helper-text {
            font-size: var(--font-sm);
            color: var(--color-gray-500);
            margin-top: var(--space-2);
        }

        .section-title {
            font-size: var(--font-lg);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin: var(--space-8) 0 var(--space-4);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--color-gray-200);
        }

        /* ì»¤ìŠ¤í…€ í•„ë“œ */
        #customFieldsContainer {
            margin-top: var(--space-6);
        }

        .custom-field {
            margin-bottom: var(--space-4);
        }

        /* ì²´í¬ë°•ìŠ¤ */
        .checkbox-field {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .checkbox-field input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ */
        .image-upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--border-radius-base);
            padding: var(--space-6);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .image-upload-area:hover {
            border-color: var(--color-primary);
            background: var(--color-gray-50);
        }

        .image-upload-area.dragover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .image-preview-item {
            position: relative;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            background: var(--color-gray-100);
        }

        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .image-preview-item .remove-btn:hover {
            background: rgba(220, 38, 38, 1);
        }

        .image-preview-item .caption-input {
            width: 100%;
            padding: var(--space-2);
            font-size: var(--font-sm);
            border: none;
            border-top: 1px solid var(--color-gray-300);
        }

        .preview-wrapper {
            position: relative;
        }

        .image-status {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: var(--font-xs);
            font-weight: var(--font-semibold);
            background: rgba(15, 23, 42, 0.75);
            color: #fff;
        }

        .image-status.success {
            background: rgba(16, 185, 129, 0.85);
        }

        .image-status.uploading {
            background: rgba(59, 130, 246, 0.85);
        }

        .image-status.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .caption-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid var(--color-gray-200);
            font-size: var(--font-xs);
            gap: var(--space-2);
        }

        .caption-actions button {
            border: none;
            background: none;
            color: var(--color-primary);
            cursor: pointer;
            font-size: var(--font-xs);
            padding: 0;
        }

        .caption-actions button:hover {
            text-decoration: underline;
        }

        #imageUploadMessage {
            margin-top: var(--space-3);
            font-size: var(--font-sm);
            color: var(--color-gray-500);
        }

        #imageUploadMessage.error {
            color: #e11d48;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â• ìƒˆ ì´ìŠˆ ë“±ë¡</h1>
            <p>í€ì¹˜ë¦¬ìŠ¤íŠ¸ì— ìƒˆë¡œìš´ ì´ìŠˆë¥¼ ë“±ë¡í•©ë‹ˆë‹¤</p>
        </div>

        <!-- í…œí”Œë¦¿ ì„ íƒ -->
        <div class="template-selection">
            <h3>ğŸ“‹ í…œí”Œë¦¿ ì„ íƒ (ì„ íƒì‚¬í•­)</h3>
            <p class="helper-text">ì´ìŠˆ ìœ í˜•ì— ë§ëŠ” í…œí”Œë¦¿ì„ ì„ íƒí•˜ë©´ í•„ìš”í•œ í•­ëª©ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤</p>

            <div class="template-grid" id="templateGrid">
                <!-- ë™ì  ìƒì„± -->
            </div>
        </div>

        <div class="form-content">
            <form id="createIssueForm">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="section-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</div>

                <div class="form-group">
                    <label>ì œëª© <span class="required">*</span></label>
                    <input type="text" id="title" name="title" required placeholder="ì´ìŠˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <div class="helper-text" id="titleHelp"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ë¶„ë¥˜ <span class="required">*</span></label>
                        <select id="category" name="category" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì„¸ë¶€ë¶„ë¥˜ <span class="required">*</span></label>
                        <select id="subcategory" name="subcategory" required>
                            <option value="">ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ë¼ì¸ ë¶„ë¥˜ <span class="required">*</span></label>
                        <select id="lineClassification" name="line_classification" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <div class="helper-text">ì´ìŠˆê°€ ë°œìƒí•œ ë¼ì¸ì„ ì„ íƒí•˜ì„¸ìš”</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ìš°ì„ ìˆœìœ„ <span class="required">*</span></label>
                        <select id="priority" name="priority" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ê¸´ê¸‰">ğŸš¨ ê¸´ê¸‰</option>
                            <option value="ë†’ìŒ">âš ï¸ ë†’ìŒ</option>
                            <option value="ë³´í†µ">â„¹ï¸ ë³´í†µ</option>
                            <option value="ë‚®ìŒ">â– ë‚®ìŒ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ìƒíƒœ</label>
                        <select id="status" name="status">
                            <option value="ì‹ ê·œ" selected>ì‹ ê·œ</option>
                            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                            <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                            <option value="ê²€ì¦ì¤‘">ê²€ì¦ì¤‘</option>
                        </select>
                    </div>
                </div>

                <!-- ë¬¸ì œ ìƒí™© -->
                <div class="section-title">ğŸ“ ë¬¸ì œ ìƒí™©</div>

                <div class="form-group">
                    <label>ë¬¸ì œ ìƒí™© <span class="required">*</span></label>
                    <textarea id="description" name="description" required placeholder="ë¬¸ì œ ìƒí™©ì„ ìƒì„¸íˆ ê¸°ìˆ í•˜ì„¸ìš”"></textarea>
                    <div class="helper-text" id="descriptionHelp">ë°œìƒí•œ ë¬¸ì œì˜ í˜„ìƒê³¼ ì˜í–¥ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”</div>
                </div>

                <div class="form-group">
                    <label>ì›ì¸ ë¶„ì„</label>
                    <textarea id="cause" name="cause" placeholder="ë¬¸ì œì˜ ì›ì¸ì„ ë¶„ì„í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                    <div class="helper-text" id="causeHelp"></div>
                </div>

                <!-- ì¡°ì¹˜ ê³„íš -->
                <div class="section-title">ğŸ”§ ì¡°ì¹˜ ê³„íš ë° ê²°ê³¼</div>

                <div class="form-group">
                    <label>ì¡°ì¹˜ ê³„íš</label>
                    <textarea id="action_plan" name="action_plan" placeholder="ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì¡°ì¹˜ ê³„íšì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                    <div class="helper-text" id="actionPlanHelp"></div>
                </div>

                <div class="form-group">
                    <label>ì¡°ì¹˜ ê²°ê³¼</label>
                    <textarea id="action_result" name="action_result" placeholder="ì¡°ì¹˜ë¥¼ ì‹¤í–‰í•œ í›„ ê²°ê³¼ë¥¼ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                </div>

                <!-- ì»¤ìŠ¤í…€ í•„ë“œ (ë™ì ) -->
                <div id="customFieldsSection" style="display: none;">
                    <div class="section-title">âš™ï¸ ì¶”ê°€ ì •ë³´</div>
                    <div id="customFieldsContainer">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ë‹´ë‹¹ ì •ë³´ -->
                <div class="section-title">ğŸ‘¥ ë‹´ë‹¹ ì •ë³´</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì <span class="required">*</span></label>
                        <select id="owner" name="owner" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ìŠ¹ì¸ì</label>
                        <select id="approver" name="approver">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>í˜‘ì˜ì</label>
                    <input type="text" id="collaborators" name="collaborators" placeholder="í˜‘ì˜ìë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥ (ì˜ˆ: ê¹€ì² ìˆ˜, ë°•ì˜í¬)">
                    <div class="helper-text">ì—¬ëŸ¬ ëª…ì¸ ê²½ìš° ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì„¸ìš”</div>
                </div>

                <!-- ì¼ì • ì •ë³´ -->
                <div class="section-title">ğŸ“… ì¼ì • ì •ë³´</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ìš”ì²­ì¼ <span class="required">*</span></label>
                        <input type="date" id="request_date" name="request_date" required>
                    </div>

                    <div class="form-group">
                        <label>ëª©í‘œ ì™„ë£Œì¼ <span class="required">*</span></label>
                        <input type="date" id="target_date" name="target_date" required>
                    </div>

                    <div class="form-group">
                        <label>ì‹¤ì œ ì™„ë£Œì¼</label>
                        <input type="date" id="complete_date" name="complete_date">
                    </div>
                </div>

                <!-- ì´ë¯¸ì§€ ì²¨ë¶€ -->
                <div class="section-title">ğŸ“· ì´ë¯¸ì§€ ì²¨ë¶€</div>

                <div class="form-group">
                    <div class="image-upload-area" id="imageUploadArea">
                        <div style="font-size: 48px; margin-bottom: var(--space-2);">ğŸ“·</div>
                        <div style="font-size: var(--font-lg); font-weight: var(--font-semibold); margin-bottom: var(--space-2);">
                            ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ
                        </div>
                        <div class="helper-text">
                            JPG, PNG, GIF íŒŒì¼ ì§€ì› (ìµœëŒ€ 5MB)
                        </div>
                        <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                    </div>

                    <div class="image-preview-grid" id="imagePreviewGrid"></div>
                    <div id="imageUploadMessage" class="helper-text"></div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        âœ… ì´ìŠˆ ë“±ë¡
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        ğŸ”„ ì´ˆê¸°í™”
                    </button>
                    <a href="../index.html" class="btn btn-outline">
                        âŒ ì·¨ì†Œ
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script src="../../shared/scripts/utils.js"></script>
    <script src="../scripts/config-loader.js"></script>
    <script src="../scripts/punchlist.js"></script>
    <script>
        let currentTemplate = null;
        let allTemplates = [];
        let customFieldsConfig = null;
        let uploadedImages = []; // { file, dataUrl, caption, status, url, publicId, error }
        const CLOUDINARY_UPLOAD_FOLDER = 's25016/punchlist';
        const PLACEHOLDER_IMAGE = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

        function getSubmitButton() {
            return document.querySelector('#createIssueForm button[type="submit"]');
        }

        function getImageStatusText(status) {
            const map = {
                success: 'ì—…ë¡œë“œ ì™„ë£Œ',
                uploading: 'ì—…ë¡œë“œ ì¤‘',
                error: 'ì—…ë¡œë“œ ì‹¤íŒ¨'
            };
            return map[status] || status;
        }

        function isUploadingImages() {
            return uploadedImages.some(img => img.status === 'uploading');
        }

        function updateImageUploadStatus() {
            const messageEl = document.getElementById('imageUploadMessage');
            const uploadingCount = uploadedImages.filter(img => img.status === 'uploading').length;
            const errorCount = uploadedImages.filter(img => img.status === 'error').length;
            const successCount = uploadedImages.filter(img => img.status === 'success').length;

            messageEl.classList.remove('error');

            if (uploadingCount > 0) {
                messageEl.textContent = `ì´ë¯¸ì§€ ${uploadingCount}ê°œ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...`;
            } else if (errorCount > 0) {
                messageEl.textContent = `ì´ë¯¸ì§€ ${errorCount}ê°œ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ì‚­ì œí•´ ì£¼ì„¸ìš”.`;
                messageEl.classList.add('error');
            } else if (successCount > 0) {
                messageEl.textContent = `ì´ë¯¸ì§€ ${successCount}ê°œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`;
            } else {
                messageEl.textContent = '';
            }

            const submitButton = getSubmitButton();
            if (submitButton && submitButton.dataset.locked !== 'true') {
                submitButton.disabled = uploadingCount > 0;
                submitButton.textContent = uploadingCount > 0 ? 'â³ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...' : 'âœ… ì´ìŠˆ ë“±ë¡';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', async () => {
            await initForm();
            setDefaultDates();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('category').addEventListener('change', updateSubcategories);
            document.getElementById('createIssueForm').addEventListener('submit', handleSubmit);

            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸
            setupImageUpload();

            // í…œí”Œë¦¿ ë¡œë“œ
            await loadTemplates();
        });

        // í¼ ì´ˆê¸°í™”
        async function initForm() {
            // ë¶„ë¥˜ ì²´ê³„ ë¡œë“œ
            const categories = await configLoader.loadCategories();
            const categorySelect = document.getElementById('category');

            categories.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.icon} ${cat.name}`;
                categorySelect.appendChild(option);
            });

            const lineSelect = document.getElementById('lineClassification');
            if (lineSelect) {
                lineSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                (PunchListAPI.LINE_TYPES || []).forEach(line => {
                    const option = document.createElement('option');
                    option.value = line;
                    option.textContent = line;
                    lineSelect.appendChild(option);
                });
            }

            // ë‹´ë‹¹ì ì˜µì…˜
            const ownerSelect = document.getElementById('owner');
            const approverSelect = document.getElementById('approver');

            await PunchListAPI.ensureOwnersLoaded();
            const ownerNames = PunchListAPI.getOwnerNames();
            ownerNames.forEach(owner => {
                const option1 = document.createElement('option');
                option1.value = owner;
                option1.textContent = owner;
                ownerSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = owner;
                option2.textContent = owner;
                approverSelect.appendChild(option2);
            });

            // ì»¤ìŠ¤í…€ í•„ë“œ ì„¤ì • ë¡œë“œ
            customFieldsConfig = await configLoader.loadCustomFields();
        }

        // í…œí”Œë¦¿ ë¡œë“œ ë° í‘œì‹œ
        async function loadTemplates() {
            allTemplates = await configLoader.loadAllTemplates();
            const grid = document.getElementById('templateGrid');

            // ê¸°ë³¸ í…œí”Œë¦¿ ì¹´ë“œ
            const defaultCard = createTemplateCard(null, {
                name: 'ê¸°ë³¸ í…œí”Œë¦¿',
                description: 'ì¼ë°˜ì ì¸ ì´ìŠˆë¥¼ ë“±ë¡í•©ë‹ˆë‹¤',
                icon: 'ğŸ“‹'
            });
            grid.appendChild(defaultCard);

            // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ í…œí”Œë¦¿ ì¹´ë“œ
            allTemplates.forEach(template => {
                const card = createTemplateCard(template.templateId, template);
                grid.appendChild(card);
            });
        }

        // í…œí”Œë¦¿ ì¹´ë“œ ìƒì„±
        function createTemplateCard(templateId, template) {
            const card = document.createElement('div');
            card.className = 'template-card';
            if (!templateId) card.classList.add('selected');

            card.innerHTML = `
                <div class="template-icon">${template.icon}</div>
                <div class="template-name">${template.name}</div>
                <div class="template-description">${template.description}</div>
            `;

            card.onclick = () => selectTemplate(templateId, card);

            return card;
        }

        // í…œí”Œë¦¿ ì„ íƒ
        async function selectTemplate(templateId, cardElement) {
            // ì¹´ë“œ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');

            currentTemplate = templateId;

            if (!templateId) {
                // ê¸°ë³¸ í…œí”Œë¦¿
                clearCustomFields();
                clearHelpTexts();
                return;
            }

            // í…œí”Œë¦¿ ë°ì´í„° ë¡œë“œ
            const template = allTemplates.find(t => t.templateId === templateId);
            if (!template) return;

            // ê¸°ë³¸ê°’ ì ìš©
            if (template.defaultValues) {
                for (const [key, value] of Object.entries(template.defaultValues)) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = value;
                    }
                }

                // ì„¸ë¶€ë¶„ë¥˜ ì—…ë°ì´íŠ¸ (ë¶„ë¥˜ê°€ ì„¤ì •ëœ ê²½ìš°)
                if (template.defaultValues.category) {
                    await updateSubcategories();
                    if (template.defaultValues.subcategory) {
                        document.getElementById('subcategory').value = template.defaultValues.subcategory;
                    }
                }
            }

            // ë„ì›€ë§ í…ìŠ¤íŠ¸ ì„¤ì •
            if (template.helpText) {
                for (const [fieldId, helpText] of Object.entries(template.helpText)) {
                    const helpElement = document.getElementById(`${fieldId}Help`);
                    if (helpElement) {
                        helpElement.textContent = helpText;
                    }
                }
            }

            // ì»¤ìŠ¤í…€ í•„ë“œ ë Œë”ë§
            renderCustomFields(template);
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ë Œë”ë§
        function renderCustomFields(template) {
            const container = document.getElementById('customFieldsContainer');
            const section = document.getElementById('customFieldsSection');
            container.innerHTML = '';

            if (!template.customFields) {
                section.style.display = 'none';
                return;
            }

            const enabledFields = Object.entries(template.customFields)
                .filter(([_, config]) => config.enabled)
                .map(([fieldId]) => {
                    return customFieldsConfig.fields.find(f => f.id === fieldId);
                })
                .filter(f => f !== undefined);

            if (enabledFields.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            enabledFields.forEach(field => {
                const fieldConfig = template.customFields[field.id];
                const fieldElement = createCustomFieldElement(field, fieldConfig);
                container.appendChild(fieldElement);
            });
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        function createCustomFieldElement(field, config) {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-group custom-field';
            wrapper.dataset.fieldId = field.id;

            const label = document.createElement('label');
            label.innerHTML = field.name;
            if (config.required) {
                label.innerHTML += ' <span class="required">*</span>';
            }
            wrapper.appendChild(label);

            let input;

            switch (field.type) {
                case 'number':
                    input = document.createElement('input');
                    input.type = 'number';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    input.placeholder = field.placeholder || '';
                    if (field.validation) {
                        if (field.validation.min !== undefined) input.min = field.validation.min;
                        if (field.validation.max !== undefined) input.max = field.validation.max;
                    }
                    if (field.unit) {
                        input.placeholder += ` (ë‹¨ìœ„: ${field.unit})`;
                    }
                    break;

                case 'select':
                    input = document.createElement('select');
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'ì„ íƒí•˜ì„¸ìš”';
                    input.appendChild(defaultOption);

                    field.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        input.appendChild(option);
                    });
                    break;

                case 'boolean':
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-field';

                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;

                    const checkboxLabel = document.createElement('label');
                    checkboxLabel.htmlFor = `custom_${field.id}`;
                    checkboxLabel.textContent = field.helpText || '';

                    checkboxDiv.appendChild(input);
                    checkboxDiv.appendChild(checkboxLabel);
                    wrapper.appendChild(checkboxDiv);

                    if (field.helpText) {
                        const helpDiv = document.createElement('div');
                        helpDiv.className = 'helper-text';
                        helpDiv.textContent = field.helpText;
                        wrapper.appendChild(helpDiv);
                    }

                    return wrapper;

                case 'textarea':
                    input = document.createElement('textarea');
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    input.placeholder = field.placeholder || '';
                    break;

                case 'date':
                    input = document.createElement('input');
                    input.type = 'date';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    break;

                default: // text
                    input = document.createElement('input');
                    input.type = 'text';
                    input.id = `custom_${field.id}`;
                    input.name = `custom_${field.id}`;
                    input.placeholder = field.placeholder || '';
                    if (field.pattern) {
                        input.pattern = field.pattern;
                    }
            }

            if (input && config.required) {
                input.required = true;
            }

            if (input && config.defaultValue !== undefined) {
                input.value = config.defaultValue;
            }

            if (input) {
                wrapper.appendChild(input);
            }

            if (field.helpText) {
                const helpDiv = document.createElement('div');
                helpDiv.className = 'helper-text';
                helpDiv.textContent = field.helpText;
                wrapper.appendChild(helpDiv);
            }

            return wrapper;
        }

        // ì»¤ìŠ¤í…€ í•„ë“œ ì´ˆê¸°í™”
        function clearCustomFields() {
            document.getElementById('customFieldsContainer').innerHTML = '';
            document.getElementById('customFieldsSection').style.display = 'none';
        }

        // ë„ì›€ë§ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        function clearHelpTexts() {
            document.querySelectorAll('[id$="Help"]').forEach(el => {
                if (el.id === 'descriptionHelp') {
                    el.textContent = 'ë°œìƒí•œ ë¬¸ì œì˜ í˜„ìƒê³¼ ì˜í–¥ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”';
                } else {
                    el.textContent = '';
                }
            });
        }

        // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const oneWeekLater = new Date();
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);
            const targetDate = oneWeekLater.toISOString().split('T')[0];

            document.getElementById('request_date').value = today;
            document.getElementById('target_date').value = targetDate;
        }

        // ì„¸ë¶€ë¶„ë¥˜ ì—…ë°ì´íŠ¸
        async function updateSubcategories() {
            const category = document.getElementById('category').value;
            const subcategorySelect = document.getElementById('subcategory');

            subcategorySelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

            if (!category) return;

            const categories = await configLoader.loadCategories();
            const categoryData = categories.categories.find(c => c.name === category);

            if (categoryData && categoryData.subcategories) {
                categoryData.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        // í¼ ì œì¶œ
        async function handleSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const issueData = Object.fromEntries(formData.entries());

            // ì»¤ìŠ¤í…€ í•„ë“œ ìˆ˜ì§‘
            issueData.customFields = {};
            document.querySelectorAll('.custom-field').forEach(fieldEl => {
                const fieldId = fieldEl.dataset.fieldId;
                const input = fieldEl.querySelector('input, select, textarea');

                if (input) {
                    if (input.type === 'checkbox') {
                        issueData.customFields[fieldId] = input.checked;
                    } else {
                        issueData.customFields[fieldId] = input.value;
                    }
                }
            });

            // í…œí”Œë¦¿ ID ì¶”ê°€
            if (currentTemplate) {
                issueData.templateId = currentTemplate;
            }

            if (isUploadingImages()) {
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                return;
            }

            const failedImages = uploadedImages.filter(img => img.status === 'error');
            if (failedImages.length > 0) {
                const proceed = confirm('ì—…ë¡œë“œì— ì‹¤íŒ¨í•œ ì´ë¯¸ì§€ê°€ ìˆìŠµë‹ˆë‹¤. ì‹¤íŒ¨í•œ ì´ë¯¸ì§€ëŠ” ì œì™¸í•˜ê³  ë“±ë¡í• ê¹Œìš”?');
                if (!proceed) {
                    return;
                }
            }

            const successfulImages = uploadedImages.filter(img => img.status === 'success' && img.url);
            issueData.attachments = successfulImages.map(img => ({
                type: 'image',
                url: img.url,
                caption: img.caption,
                fileName: img.file ? img.file.name : '',
                public_id: img.publicId || ''
            }));

            // í”„ë¡ íŠ¸ì—ì„œ ì¦‰ì‹œ í™œìš©í•  ìˆ˜ ìˆë„ë¡ images í•„ë“œë¥¼ í•¨ê»˜ í¬í•¨
            issueData.images = issueData.attachments.map(att => ({
                url: att.url,
                caption: att.caption,
                public_id: att.public_id || '',
                fileName: att.fileName || ''
            }));

            issueData.customFields = issueData.customFields || {};
            issueData.line_classification = issueData.line_classification || '';
            issueData.customFields.line_classification = issueData.line_classification;

            const creationChanges = [
                { field: 'title', label: 'ì œëª©', before: '-', after: issueData.title || '' },
                { field: 'line_classification', label: 'ë¼ì¸ ë¶„ë¥˜', before: '-', after: issueData.line_classification || '' },
                { field: 'status', label: 'ìƒíƒœ', before: '-', after: issueData.status || 'ì‹ ê·œ' },
                { field: 'priority', label: 'ìš°ì„ ìˆœìœ„', before: '-', after: issueData.priority || '' }
            ].filter(change => change.after);

            const creationLogEntry = {
                timestamp: new Date().toISOString(),
                author: issueData.owner || 'ì‹œìŠ¤í…œ',
                action: 'create',
                summary: 'ì´ìŠˆ ìµœì´ˆ ë“±ë¡',
                changes: creationChanges
            };

            const existingLog = Array.isArray(issueData.customFields.change_log)
                ? [...issueData.customFields.change_log]
                : [];
            existingLog.push(creationLogEntry);
            issueData.customFields.change_log = existingLog;

            // ë¹ˆ ê°’ ì²˜ë¦¬
            Object.keys(issueData).forEach(key => {
                if (!issueData[key] && key !== 'customFields' && key !== 'images') {
                    issueData[key] = '';
                }
            });

            try {
                const submitButton = getSubmitButton();
                submitButton.dataset.locked = 'true';
                submitButton.disabled = true;
                submitButton.textContent = 'â³ ë“±ë¡ ì¤‘...';

                await PunchListAPI.createIssue(issueData);

                alert('âœ… ì´ìŠˆê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = '../index.html';
            } catch (error) {
                console.error('ì´ìŠˆ ë“±ë¡ ì‹¤íŒ¨:', error);
                alert('âŒ ì´ìŠˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

                const submitButton = getSubmitButton();
                submitButton.dataset.locked = '';
                submitButton.disabled = false;
                submitButton.textContent = 'âœ… ì´ìŠˆ ë“±ë¡';
                updateImageUploadStatus();
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            if (confirm('ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('createIssueForm').reset();
                setDefaultDates();
                document.getElementById('subcategory').innerHTML = '<option value="">ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
                const lineSelect = document.getElementById('lineClassification');
                if (lineSelect) {
                    lineSelect.value = '';
                }
                clearCustomFields();
                clearHelpTexts();
                uploadedImages = [];
                renderImagePreviews();
                updateImageUploadStatus();
                const submitButton = getSubmitButton();
                if (submitButton) {
                    submitButton.dataset.locked = '';
                    submitButton.disabled = false;
                    submitButton.textContent = 'âœ… ì´ìŠˆ ë“±ë¡';
                }

                // ê¸°ë³¸ í…œí”Œë¦¿ ì„ íƒ
                document.querySelectorAll('.template-card').forEach((c, i) => {
                    if (i === 0) {
                        c.classList.add('selected');
                    } else {
                        c.classList.remove('selected');
                    }
                });
                currentTemplate = null;
            }
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¤ì •
        function setupImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('imageInput');

            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                fileInput.value = '';
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            updateImageUploadStatus();
        }

        // íŒŒì¼ ì²˜ë¦¬ ë° ì—…ë¡œë“œ ì‹œì‘
        function handleFiles(fileList) {
            const files = Array.from(fileList || []);

            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name}ì€(ëŠ”) ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.`);
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name}ì˜ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤ (ìµœëŒ€ 5MB).`);
                    return;
                }

                const imageRecord = {
                    file,
                    dataUrl: PLACEHOLDER_IMAGE,
                    caption: '',
                    status: 'uploading',
                    url: '',
                    publicId: '',
                    error: ''
                };

                uploadedImages.push(imageRecord);
                const index = uploadedImages.length - 1;

                // ë¯¸ë¦¬ë³´ê¸°ìš© dataUrl ìƒì„±
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImages[index].dataUrl = e.target.result;
                    renderImagePreviews();
                };
                reader.readAsDataURL(file);

                renderImagePreviews();
                uploadImageToCloudinary(index);
            });

            updateImageUploadStatus();
        }

        // Cloudinary ì—…ë¡œë“œ
        async function uploadImageToCloudinary(index) {
            const image = uploadedImages[index];
            if (!image) return;

            image.status = 'uploading';
            image.error = '';
            renderImagePreviews();

            const formData = new FormData();
            formData.append('file', image.file);
            formData.append('folder', CLOUDINARY_UPLOAD_FOLDER);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success || !result.url) {
                    throw new Error(result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                image.status = 'success';
                image.url = result.url;
                image.publicId = result.public_id || '';
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                image.status = 'error';
                image.error = error.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨';
                image.url = '';
                image.publicId = '';
            }

            renderImagePreviews();
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
        function renderImagePreviews() {
            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = '';

            if (uploadedImages.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #7f8c8d; padding: 40px;">ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                updateImageUploadStatus();
                return;
            }

            uploadedImages.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';

                const imageSrc = img.dataUrl || img.url || PLACEHOLDER_IMAGE;
                const statusBadge = `<span class="image-status ${img.status}">${getImageStatusText(img.status)}</span>`;
                const errorInfo = img.status === 'error'
                    ? `<div class="helper-text" style="color:#e11d48; padding:4px 0;">${img.error}</div>`
                    : '';

                const actionButtons = `
                    ${img.status === 'error' ? `<button type="button" onclick="retryImageUpload(${index})">ì¬ì‹œë„</button>` : ''}
                    ${img.status === 'success' && img.url ? `<button type="button" onclick="copyImageUrl(${index})">URL ë³µì‚¬</button>` : ''}
                `;

                item.innerHTML = `
                    <div class="preview-wrapper">
                        ${statusBadge}
                        <img src="${imageSrc}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removeImage(${index})">Ã—</button>
                    </div>
                    <input type="text"
                           class="caption-input"
                           placeholder="ì„¤ëª… (ì„ íƒ)"
                           value="${img.caption}"
                           onchange="updateCaption(${index}, this.value)">
                    <div class="caption-actions">
                        <span>${img.url ? 'ë§í¬ ì €ì¥ë¨' : getImageStatusText(img.status)}</span>
                        <div>${actionButtons}</div>
                    </div>
                    ${errorInfo}
                `;
                grid.appendChild(item);
            });

            updateImageUploadStatus();
        }

        // ì´ë¯¸ì§€ ì œê±°
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderImagePreviews();
        }

        // ìº¡ì…˜ ì—…ë°ì´íŠ¸
        function updateCaption(index, caption) {
            if (uploadedImages[index]) {
                uploadedImages[index].caption = caption;
            }
        }

        // ì—…ë¡œë“œ ì¬ì‹œë„
        function retryImageUpload(index) {
            const image = uploadedImages[index];
            if (!image) return;
            image.status = 'uploading';
            image.error = '';
            renderImagePreviews();
            uploadImageToCloudinary(index);
        }

        // ì´ë¯¸ì§€ URL ë³µì‚¬
        async function copyImageUrl(index) {
            const image = uploadedImages[index];
            if (!image || !image.url) return;
            try {
                await navigator.clipboard.writeText(image.url);
                alert('ğŸ“‹ ì´ë¯¸ì§€ URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('URL ë³µì‚¬ ì‹¤íŒ¨:', error);
                alert('âŒ URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
