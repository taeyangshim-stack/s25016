<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìŠˆ ëª©ë¡ - S25016 í€ì¹˜ë¦¬ìŠ¤íŠ¸</title>

    <link rel="stylesheet" href="../../shared/styles/variables.css">
    <link rel="stylesheet" href="../../shared/styles/reset.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">

    <style>
        body {
            background: var(--color-gray-50);
            min-height: 100vh;
            padding: var(--space-5);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--color-white);
            padding: var(--space-6);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .header h1 {
            font-size: var(--font-2xl);
            color: var(--color-gray-900);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
        }

        .stat-card {
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-radius: var(--border-radius-base);
            text-align: center;
        }

        .stat-number {
            font-size: var(--font-2xl);
            font-weight: var(--font-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-1);
        }

        .stat-label {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
        }

        .filters {
            background: var(--color-white);
            padding: var(--space-5);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
            color: var(--color-gray-700);
            margin-bottom: var(--space-2);
        }

        .filter-group select,
        .filter-group input {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--border-radius-base);
            font-size: var(--font-base);
        }

        .filter-actions {
            display: flex;
            gap: var(--space-3);
        }

        .table-container {
            background: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .table-header {
            padding: var(--space-5);
            border-bottom: 1px solid var(--color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: var(--font-lg);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--color-gray-50);
        }

        th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: var(--font-semibold);
            color: var(--color-gray-700);
            font-size: var(--font-sm);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--color-gray-100);
        }

        th .sort-icon {
            margin-left: var(--space-1);
            opacity: 0.5;
        }

        th.sorted .sort-icon {
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid var(--color-gray-100);
            transition: var(--transition-base);
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--color-gray-50);
        }

        tbody tr.recent-update {
            background: #fef9c3;
        }

        tbody tr.recent-update:hover {
            background: #fef3c7;
        }

        td {
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-sm);
        }

        .badge {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--border-radius-base);
            font-size: var(--font-xs);
            font-weight: var(--font-semibold);
            white-space: nowrap;
        }

        .recent-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: var(--space-1);
            color: #b45309;
            font-size: var(--font-xs);
            font-weight: var(--font-semibold);
        }

        .badge-priority-ê¸´ê¸‰ {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-priority-ë†’ìŒ {
            background: #fed7aa;
            color: #9a3412;
        }

        .badge-priority-ë³´í†µ {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-priority-ë‚®ìŒ {
            background: #e5e7eb;
            color: #4b5563;
        }

        .badge-status-ì‹ ê·œ {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-status-ì§„í–‰ì¤‘ {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-status-ë³´ë¥˜ {
            background: #f3f4f6;
            color: #6b7280;
        }

        .badge-status-ì™„ë£Œ {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-status-ê²€ì¦ì¤‘ {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* ===== ê°€ë…ì„± ê°œì„ : ìš°ì„ ìˆœìœ„ë³„ í–‰ ë°°ê²½ìƒ‰ ===== */
        tbody tr.priority-ê¸´ê¸‰ {
            background: #fef2f2 !important;
            border-left: 4px solid #dc2626;
        }

        tbody tr.priority-ê¸´ê¸‰:hover {
            background: #fee2e2 !important;
        }

        tbody tr.priority-ë†’ìŒ {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }

        tbody tr.priority-ë†’ìŒ:hover {
            background: #fef3c7;
        }

        tbody tr.priority-ë³´í†µ {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
        }

        tbody tr.priority-ë³´í†µ:hover {
            background: #dbeafe;
        }

        tbody tr.priority-ë‚®ìŒ {
            background: #f9fafb;
            border-left: 4px solid #9ca3af;
        }

        tbody tr.priority-ë‚®ìŒ:hover {
            background: #f3f4f6;
        }

        /* ë¼ì¸ë³„ ìƒ‰ìƒ ë±ƒì§€ */
        .line-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 11px;
            display: inline-block;
        }

        .line-badge.badge-Aë¼ì¸ {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .line-badge.badge-Bë¼ì¸ {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .line-badge.badge-ê³µí†µ {
            background: #e5e7eb;
            color: #374151;
            border: 1px solid #9ca3af;
        }

        .line-badge.badge-A_Bë¼ì¸ {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #16a34a;
        }

        /* ===== Week 2: í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ê°œì„  ===== */
        /* ìš°ì„ ìˆœìœ„ ì»¬ëŸ¼ - ì•„ì´ì½˜ ì¤‘ì‹¬ */
        .priority-cell {
            text-align: center;
            padding: 8px 4px !important;
        }

        .priority-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .priority-icon {
            font-size: 20px;
            line-height: 1;
        }

        .priority-text {
            font-size: 10px;
            font-weight: 600;
            color: #6b7280;
        }

        /* ID/ì œëª© ì»¬ëŸ¼ - 2ì¤„ ë ˆì´ì•„ì›ƒ */
        .issue-cell {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 16px !important;
        }

        .issue-id {
            font-family: 'Consolas', monospace;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
        }

        .issue-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            line-height: 1.4;
            /* 2ì¤„ê¹Œì§€ í‘œì‹œ */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .issue-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 10px;
            padding: 2px 6px;
            background: #f3f4f6;
            border-radius: 8px;
            color: #4b5563;
        }

        /* ë¼ì¸Â·ë¶„ë¥˜ ì»¬ëŸ¼ */
        .line-category-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .line-category-cell .line-badge {
            margin-bottom: 2px;
        }

        .line-category-cell .category-text {
            font-size: 11px;
            color: #6b7280;
        }

        /* ì¼ì • ì»¬ëŸ¼ - í™”ì‚´í‘œ í‘œì‹œ */
        .schedule-cell {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .schedule-date {
            font-weight: 500;
            color: #374151;
        }

        .schedule-arrow {
            color: #9ca3af;
            font-weight: 600;
        }

        .schedule-overdue {
            color: #dc2626;
            font-weight: 600;
        }

        /* ì•¡ì…˜ ì»¬ëŸ¼ */
        .action-cell {
            text-align: center;
            padding: 8px !important;
        }

        .action-btn {
            padding: 4px 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #4b5563;
            color: white;
            border-color: #4b5563;
        }

        /* í…Œì´ë¸” í–‰ ë†’ì´ ì¡°ì ˆ */
        tbody tr {
            height: auto;
            min-height: 70px;
        }

        tbody td {
            vertical-align: middle;
        }

        /* í•„í„° í”„ë¦¬ì…‹ ë²„íŠ¼ */
        .filter-presets {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            padding: var(--space-4);
            background: var(--color-gray-50);
            border-radius: var(--border-radius-lg);
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: var(--space-2) var(--space-4);
            background: white;
            border: 2px solid var(--color-gray-300);
            border-radius: var(--border-radius-full);
            font-size: var(--font-sm);
            font-weight: var(--font-semibold);
            color: var(--color-gray-700);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }

        .preset-btn:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .preset-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-4);
            color: var(--color-gray-500);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
        }

        .loading {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-gray-500);
        }

        .overdue {
            color: var(--color-danger);
            font-weight: var(--font-semibold);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-5);
            border-top: 1px solid var(--color-gray-200);
        }

        .pagination button {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-gray-300);
            background: var(--color-white);
            border-radius: var(--border-radius-base);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .pagination button:hover:not(:disabled) {
            background: var(--color-gray-50);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: var(--font-sm);
            color: var(--color-gray-600);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="header-top">
                <h1>ğŸ“‹ ì´ìŠˆ ëª©ë¡</h1>
                <div style="display: flex; gap: var(--space-3);">
                    <a href="create.html" class="btn btn-primary">â• ìƒˆ ì´ìŠˆ ë“±ë¡</a>
                    <a href="../index.html" class="btn btn-outline">ğŸ  ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>

            <!-- í†µê³„ -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">ì „ì²´ ì´ìŠˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressCount">0</div>
                    <div class="stat-label">ì§„í–‰ì¤‘</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingCount">0</div>
                    <div class="stat-label">ë³´ë¥˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completeCount">0</div>
                    <div class="stat-label">ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overdueCount">0</div>
                    <div class="stat-label">ì§€ì—°</div>
                </div>
            </div>
        </div>

        <!-- í•„í„° -->
        <div class="filters">
            <!-- í•„í„° í”„ë¦¬ì…‹ ë²„íŠ¼ -->
            <div class="filter-presets">
                <button class="preset-btn" onclick="applyPreset('urgent-b')">
                    ğŸš¨ ê¸´ê¸‰ ì´ìŠˆ (Bë¼ì¸)
                </button>
                <button class="preset-btn" onclick="applyPreset('overdue')">
                    âš ï¸ ì§€ì—° ì¤‘ì¸ ì´ìŠˆ
                </button>
                <button class="preset-btn" onclick="applyPreset('this-week')">
                    ğŸ“… ì´ë²ˆ ì£¼ ë§ˆê°
                </button>
                <button class="preset-btn" onclick="resetFilters()">
                    ğŸ”„ ì „ì²´ ë³´ê¸°
                </button>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>ë¶„ë¥˜</label>
                    <select id="filterCategory">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ë¼ì¸ ë¶„ë¥˜</label>
                    <select id="filterLine">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ì„¸ë¶€ë¶„ë¥˜</label>
                    <select id="filterSubcategory">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ìƒíƒœ</label>
                    <select id="filterStatus">
                        <option value="">ì „ì²´</option>
                        <option value="ì‹ ê·œ">ì‹ ê·œ</option>
                        <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                        <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                        <option value="ê²€ì¦ì¤‘">ê²€ì¦ì¤‘</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ìš°ì„ ìˆœìœ„</label>
                    <select id="filterPriority">
                        <option value="">ì „ì²´</option>
                        <option value="ê¸´ê¸‰">ê¸´ê¸‰</option>
                        <option value="ë†’ìŒ">ë†’ìŒ</option>
                        <option value="ë³´í†µ">ë³´í†µ</option>
                        <option value="ë‚®ìŒ">ë‚®ìŒ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ë‹´ë‹¹ì</label>
                    <select id="filterOwner">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ê²€ìƒ‰</label>
                    <input type="text" id="searchInput" placeholder="ì œëª©, ID ê²€ìƒ‰...">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">ğŸ” ê²€ìƒ‰</button>
                <button class="btn btn-outline" onclick="resetFilters()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>

            <div class="filter-row" style="margin-top: var(--space-4); border-top: 1px solid var(--color-gray-200); padding-top: var(--space-4);">
                <div class="filter-group">
                    <label>ì •ë ¬ ì‹œ ì œì™¸í•  í•­ëª© (ì—´)</label>
                    <select id="excludeSortColumn" onchange="updateExcludeValueOptions()">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                        <option value="status">ìƒíƒœ</option>
                        <option value="priority">ìš°ì„ ìˆœìœ„</option>
                        <option value="owner">ë‹´ë‹¹ì</option>
                        <option value="line_classification">ë¼ì¸ ë¶„ë¥˜</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ì •ë ¬ ì‹œ ì œì™¸í•  í•­ëª© (ê°’)</label>
                    <select id="excludeSortValue">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- í…Œì´ë¸” -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <span id="resultCount">0</span>ê°œì˜ ì´ìŠˆ
                </div>
                <div>
                    <button class="btn btn-outline btn-sm" onclick="exportToCSV()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortBy('priority')" style="width: 80px; text-align: center;">ìš°ì„ ìˆœìœ„ <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortBy('title')" style="min-width: 280px;">ID Â· ì œëª© <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortBy('line_classification')" style="width: 140px;">ë¼ì¸ Â· ë¶„ë¥˜ <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortBy('status')" style="width: 100px;">ìƒíƒœ <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortBy('owner')" style="width: 100px;">ë‹´ë‹¹ì <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortBy('target_date')" style="width: 180px;">ì¼ì • (ìš”ì²­â†’ëª©í‘œ) <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortBy('updated_at')" style="width: 120px;">ìµœê·¼ ë³€ê²½ <span class="sort-icon">â†•ï¸</span></th>
                            <th style="width: 80px; text-align: center;">ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="issueTableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevBtn" onclick="changePage(-1)">â—€ ì´ì „</button>
                <span class="pagination-info" id="pageInfo">1 / 1</span>
                <button id="nextBtn" onclick="changePage(1)">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
    </div>

    <script src="../../shared/scripts/utils.js"></script>
    <script src="../scripts/config-loader.js"></script>
    <script src="../scripts/punchlist.js"></script>
    <script>
        let allIssues = [];
        let filteredIssues = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let sortColumn = 'id';
        let sortDirection = 'desc';
        let categoryConfig = null;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            await initFilters();
            await loadIssues();
            
            document.getElementById('excludeSortColumn').addEventListener('change', applyFilters);
            document.getElementById('excludeSortValue').addEventListener('change', applyFilters);
        });

        // í•„í„° ì´ˆê¸°í™”
        async function initFilters() {
            // ë¶„ë¥˜ ì˜µì…˜
            categoryConfig = await configLoader.loadCategories();
            const categorySelect = document.getElementById('filterCategory');
            categoryConfig.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.icon} ${cat.name}`;
                categorySelect.appendChild(option);
            });

            const lineSelect = document.getElementById('filterLine');
            if (lineSelect) {
                (PunchListAPI.LINE_TYPES || []).forEach(line => {
                    const option = document.createElement('option');
                    option.value = line;
                    option.textContent = line;
                    lineSelect.appendChild(option);
                });
            }

            // ë‹´ë‹¹ì ì˜µì…˜
            await PunchListAPI.ensureOwnersLoaded();
            const ownerNames = PunchListAPI.getOwnerNames();
            const ownerSelect = document.getElementById('filterOwner');
            ownerNames.forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                ownerSelect.appendChild(option);
            });

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('filterCategory').addEventListener('change', updateSubcategories);
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 500));
            document.getElementById('filterLine').addEventListener('change', applyFilters);
        }

        // ì„¸ë¶€ë¶„ë¥˜ ì—…ë°ì´íŠ¸
        async function updateSubcategories() {
            const category = document.getElementById('filterCategory').value;
            const subcategorySelect = document.getElementById('filterSubcategory');

            subcategorySelect.innerHTML = '<option value="">ì „ì²´</option>';

            if (!category) return;

            if (!categoryConfig) {
                categoryConfig = await configLoader.loadCategories();
            }
            const categoryData = categoryConfig.categories.find(c => c.name === category);

            if (categoryData && categoryData.subcategories) {
                categoryData.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        function refreshLineFilterOptions(issues) {
            const lineSelect = document.getElementById('filterLine');
            if (!lineSelect) return;

            const existing = new Set(Array.from(lineSelect.options).map(option => option.value));

            (issues || []).forEach(issue => {
                const line = issue && issue.line_classification;
                if (line && !existing.has(line)) {
                    const option = document.createElement('option');
                    option.value = line;
                    option.textContent = line;
                    lineSelect.appendChild(option);
                    existing.add(line);
                }
            });
        }

        // ì´ìŠˆ ë¡œë“œ
        async function loadIssues() {
            try {
                allIssues = await PunchListAPI.loadAllIssues();
                refreshLineFilterOptions(allIssues);
                applyFilters();
                updateStats();
            } catch (error) {
                console.error('ì´ìŠˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('issueTableBody').innerHTML = `
                    <tr>
                        <td colspan="11" class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <p>ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                            <p style="font-size: var(--font-sm); margin-top: var(--space-2);">
                                Google Sheets ì—°ë™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                            </p>
                        </td>
                    </tr>
                `;
            }
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            const filters = {
                line: document.getElementById('filterLine').value,
                category: document.getElementById('filterCategory').value,
                subcategory: document.getElementById('filterSubcategory').value,
                status: document.getElementById('filterStatus').value,
                priority: document.getElementById('filterPriority').value,
                owner: document.getElementById('filterOwner').value,
                search: document.getElementById('searchInput').value
            };

            filteredIssues = PunchListAPI.filterIssues(allIssues, filters);
            sortIssues();
            currentPage = 1;
            renderTable();
            updatePagination();
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterSubcategory').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterOwner').value = '';
            document.getElementById('filterLine').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('excludeSortColumn').value = '';
            document.getElementById('excludeSortValue').value = '';

            document.getElementById('filterSubcategory').innerHTML = '<option value="">ì „ì²´</option>';

            // í”„ë¦¬ì…‹ ë²„íŠ¼ í™œì„±í™” ì´ˆê¸°í™”
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));

            applyFilters();
        }

        // í•„í„° í”„ë¦¬ì…‹ ì ìš©
        function applyPreset(presetType) {
            // ë¨¼ì € ëª¨ë“  í•„í„° ì´ˆê¸°í™”
            resetFilters();

            // í”„ë¦¬ì…‹ ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const today = new Date();
            const weekLater = new Date(today);
            weekLater.setDate(weekLater.getDate() + 7);

            switch(presetType) {
                case 'urgent-b':
                    // ê¸´ê¸‰ ì´ìŠˆ (Bë¼ì¸)
                    document.getElementById('filterPriority').value = 'ê¸´ê¸‰';
                    document.getElementById('filterLine').value = 'Bë¼ì¸';
                    break;

                case 'overdue':
                    // ì§€ì—° ì¤‘ì¸ ì´ìŠˆ - ì™„ë£Œë˜ì§€ ì•Šì€ + ëª©í‘œì¼ ì§€ë‚œ ì´ìŠˆ
                    // ì´ ê²½ìš° JavaScript í•„í„°ë§ìœ¼ë¡œ ì²˜ë¦¬
                    filteredIssues = allIssues.filter(issue => {
                        return issue.status !== 'ì™„ë£Œ' && PunchListAPI.isOverdue(issue);
                    });
                    sortIssues();
                    currentPage = 1;
                    renderTable();
                    updatePagination();
                    return;

                case 'this-week':
                    // ì´ë²ˆ ì£¼ ë§ˆê° - ëª©í‘œì¼ì´ ì˜¤ëŠ˜ë¶€í„° 7ì¼ ì´ë‚´
                    filteredIssues = allIssues.filter(issue => {
                        const targetDate = new Date(issue.target_date);
                        return targetDate >= today && targetDate <= weekLater;
                    });
                    sortIssues();
                    currentPage = 1;
                    renderTable();
                    updatePagination();
                    return;
            }

            applyFilters();
        }

        // ì •ë ¬
        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            document.querySelectorAll('th').forEach(th => th.classList.remove('sorted'));
            const thElement = event.target.closest('th');
            if (thElement) {
                thElement.classList.add('sorted');
            }


            sortIssues();
            renderTable();
        }

        function sortIssues() {
            const excludeColumn = document.getElementById('excludeSortColumn').value;
            const excludeValue = document.getElementById('excludeSortValue').value;
            filteredIssues = PunchListAPI.sortIssues(filteredIssues, sortColumn, sortDirection, { excludeColumn, excludeValue });
        }
        
        function updateExcludeValueOptions() {
            const column = document.getElementById('excludeSortColumn').value;
            const valueSelect = document.getElementById('excludeSortValue');
            valueSelect.innerHTML = '<option value="">ì„ íƒ ì•ˆí•¨</option>';

            if (!column) return;

            let options = [];
            switch (column) {
                case 'status':
                    options = PunchListAPI.STATUSES;
                    break;
                case 'priority':
                    options = PunchListAPI.PRIORITIES;
                    break;
                case 'owner':
                    options = PunchListAPI.getOwnerNames();
                    break;
                case 'line_classification':
                    options = PunchListAPI.LINE_TYPES;
                    break;
            }

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                valueSelect.appendChild(option);
            });
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTable() {
            const tbody = document.getElementById('issueTableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageIssues = filteredIssues.slice(start, end);

            document.getElementById('resultCount').textContent = filteredIssues.length;

            if (pageIssues.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pageIssues.map(issue => {
                const isOverdue = PunchListAPI.isOverdue(issue);
                const isRecent = PunchListAPI.isRecentlyUpdated(issue);

                // ê°€ë…ì„± ê°œì„ : ìš°ì„ ìˆœìœ„ í´ë˜ìŠ¤ ì¶”ê°€
                const priorityClass = `priority-${issue.priority}`;
                const rowClasses = [priorityClass];
                if (isRecent) rowClasses.push('recent-update');
                const rowClassAttr = ` class="${rowClasses.join(' ')}"`;

                // ìš°ì„ ìˆœìœ„ ì•„ì´ì½˜
                const priorityIcons = {
                    'ê¸´ê¸‰': 'ğŸš¨',
                    'ë†’ìŒ': 'âš ï¸',
                    'ë³´í†µ': 'ğŸ“Œ',
                    'ë‚®ìŒ': 'ğŸ“'
                };
                const priorityIcon = priorityIcons[issue.priority] || 'ğŸ“Œ';

                // ë¼ì¸ ë±ƒì§€
                const lineCell = issue.line_classification
                    ? PunchListAPI.getLineBadge(issue.line_classification)
                    : '<span class="line-badge" style="background: #e5e7eb; color: #4b5563;">ë¯¸ì§€ì •</span>';

                // ìµœê·¼ ë³€ê²½ í‘œì‹œ
                const updatedLabel = PunchListAPI.formatDateTime(issue.updated_at);
                const recentIndicator = isRecent
                    ? '<span class="recent-indicator" title="ìµœê·¼ 72ì‹œê°„ ë‚´ ì—…ë°ì´íŠ¸">ğŸ†•</span>'
                    : '';

                // ì¼ì • í‘œì‹œ (ìš”ì²­ì¼ â†’ ëª©í‘œì¼)
                const requestDate = PunchListAPI.formatDate(issue.request_date);
                const targetDate = PunchListAPI.formatDate(issue.target_date);
                const scheduleClass = isOverdue ? 'schedule-overdue' : 'schedule-date';

                return `
                    <tr${rowClassAttr}>
                        <td class="priority-cell">
                            <div class="priority-indicator">
                                <span class="priority-icon">${priorityIcon}</span>
                                <span class="priority-text">${issue.priority}</span>
                            </div>
                        </td>
                        <td class="issue-cell">
                            <div class="issue-id">${issue.id}</div>
                            <div class="issue-title">${issue.title}</div>
                            <div class="issue-tags">
                                ${issue.category ? `<span class="tag">${issue.category}</span>` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="line-category-cell">
                                ${lineCell}
                                <span class="category-text">${issue.subcategory || '-'}</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-status-${issue.status}">${issue.status}</span>
                        </td>
                        <td>${issue.owner || '-'}</td>
                        <td>
                            <div class="schedule-cell">
                                <span class="schedule-date">${requestDate}</span>
                                <span class="schedule-arrow">â†’</span>
                                <span class="${scheduleClass}">${targetDate}${isOverdue ? ' âš ï¸' : ''}</span>
                            </div>
                        </td>
                        <td>
                            ${updatedLabel}
                            ${recentIndicator}
                        </td>
                        <td class="action-cell">
                            <button class="action-btn" onclick="event.stopPropagation(); window.location.href='detail.html?id=${issue.id}'">
                                ìƒì„¸
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const stats = PunchListAPI.calculateStats(allIssues);

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('progressCount').textContent = stats.byStatus['ì§„í–‰ì¤‘'] || 0;
            document.getElementById('pendingCount').textContent = stats.byStatus['ë³´ë¥˜'] || 0;
            document.getElementById('completeCount').textContent = stats.byStatus['ì™„ë£Œ'] || 0;
            document.getElementById('overdueCount').textContent = stats.overdue || 0;
        }

        // í˜ì´ì§€ë„¤ì´ì…˜
        function updatePagination() {
            const totalPages = Math.ceil(filteredIssues.length / itemsPerPage);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function changePage(delta) {
            const totalPages = Math.ceil(filteredIssues.length / itemsPerPage);
            const newPage = currentPage + delta;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
                updatePagination();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            const headers = ['ID', 'ì œëª©', 'ë¼ì¸', 'ë¶„ë¥˜', 'ì„¸ë¶€ë¶„ë¥˜', 'ìš°ì„ ìˆœìœ„', 'ìƒíƒœ', 'ë‹´ë‹¹ì', 'ìš”ì²­ì¼', 'ëª©í‘œì¼', 'ìµœê·¼ ë³€ê²½'];
            const rows = filteredIssues.map(issue => [
                issue.id,
                issue.title,
                issue.line_classification || '',
                issue.category,
                issue.subcategory,
                issue.priority,
                issue.status,
                issue.owner,
                issue.request_date,
                issue.target_date,
                issue.updated_at || ''
            ]);

            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `punchlist_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Debounce í•¨ìˆ˜
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>
